<h1 id="1.+%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><a class="headerlink" href="#1.+%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">1. はじめに</a></h1><p>こんにちは､びしょ〜じょです｡Luaに速度を求めるならもっと別の言語で書いたほうが良いんですが､そうはいってもLuaが書きたい! という人は多い｡ボクも書きたい｡まずはちょっとしたところから速度向上を図ろうということです｡</p><p>今回は<em>PUC Lua</em>(<a href="https://www.lua.org" target="_blank" rel="noopener noreferrer">https://www.lua.org</a> が提供する､もっともなじみのある本家Luaインタプリタ) についてみていきます｡</p><h2 id="1.1+%E7%92%B0%E5%A2%83"><a class="headerlink" href="#1.1+%E7%92%B0%E5%A2%83">1.1 環境</a></h2><p>以下の環境でテストしました｡</p><table>
<thead>
<tr>
<th style="text-align: right">key</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right">CPU</td>
<td>Intel® Core™ i5-5200U CPU @ 2.20GHz</td>
</tr>
<tr>
<td style="text-align: right">OS</td>
<td>Arch Linux 4.4.5-1-ARCH</td>
</tr>
<tr>
<td style="text-align: right"></td>
<td></td>
</tr>
<tr>
<td style="text-align: right">Lua</td>
<td>PUC Lua 5.3.2</td>
</tr>
</tbody>
</table><p>tmpfsでマウントしたディレクトリ上で作業した｡</p><h2 id="1.2+%3Ccode%3E_ENV%3C%2Fcode%3E%0A"><a class="headerlink" href="#1.2+%3Ccode%3E_ENV%3C%2Fcode%3E%0A">1.2 <code>_ENV</code>
</a></h2><p>とにかくループするのでループ回数を設定しておく｡
ついでに実行時間の計測を簡単にするものを書く｡</p><div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="cm">--[[
testsuite.lua
]]</span>

<span class="kd">local</span> <span class="n">sock</span> <span class="o">=</span> <span class="nb">require</span><span class="s1">'socket'</span>

<span class="k">return</span> <span class="p">{</span>
  <span class="n">REP</span> <span class="o">=</span> <span class="mi">500000000</span><span class="p">,</span> <span class="c1">-- 感謝の5億回ループ</span>

  <span class="c1">-- 関数fnの実行時間を測る</span>
  <span class="n">get_exectime</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">sock</span><span class="p">.</span><span class="n">gettime</span><span class="p">()</span>
    <span class="n">fn</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">sock</span><span class="p">.</span><span class="n">gettime</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span>
  <span class="k">end</span>
<span class="p">}</span>
</code></pre></div><h1 id="2.+%28PUC%29+Lua"><a class="headerlink" href="#2.+%28PUC%29+Lua">2. (PUC) Lua</a></h1><p>まずはpure Luaです｡実を言うとLuaJITでも有効ですが､pure Luaでもイケる､ということでね｡</p><h2 id="2.1+local"><a class="headerlink" href="#2.1+local">2.1 local</a></h2><p>基本中の基本｡Luaは <em>変数宣言時に<code>local</code>prefixをつけないとすべてグローバルな変数になる</em> ので､毎回<code>local hoge = 1</code>などと書くことが多い｡
では書かないとどうなるか?</p><div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="cm">--[[
2_1_nolocal.lua

loacalなんて知らねえぜ
]]</span>

<span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="nb">require</span><span class="s1">'testsuite'</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span><span class="o">=</span><span class="n">_ENV</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_exectime</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">x</span>
  <span class="k">end</span>
<span class="k">end</span><span class="p">))</span>
</code></pre></div><div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="cm">--[[
2_1_witlocal.lua
jj
localをマメに書く
]]</span>

<span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="nb">require</span><span class="s1">'testsuite'</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span><span class="o">=</span><span class="n">_ENV</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_exectime</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
    <span class="kd">local</span> <span class="n">a</span> <span class="o">=</span> <span class="n">x</span>
  <span class="k">end</span>
<span class="k">end</span><span class="p">))</span>
</code></pre></div><h3 id="%E7%B5%90%E6%9E%9C"><a class="headerlink" href="#%E7%B5%90%E6%9E%9C">結果</a></h3><table>
<thead>
<tr>
<th style="text-align: right">file</th>
<th>実行時間(sec)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right">nolocal</td>
<td>9.699923992157</td>
</tr>
<tr>
<td style="text-align: right"><strong>withlocal</strong></td>
<td><strong>5.5564069747925</strong></td>
</tr>
</tbody>
</table><p>2倍近い差が出ました｡ワオ</p><h2 id="2.2+for"><a class="headerlink" href="#2.2+for">2.2 for</a></h2><p>ループを何回まわしたかカウントしたくなる人もいます｡</p><div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="cm">--[[
2_2_docnt.lua

whileでn回リピートする｡ループとカウントの変数が一つしかないので見た目は良いかもしれない｡
]]</span>

<span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="nb">require</span><span class="s1">'testsuite'</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span><span class="o">=</span><span class="n">_ENV</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_exectime</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">while</span> <span class="n">cnt</span> <span class="o">&lt;=</span> <span class="n">REP</span> <span class="k">do</span>
    <span class="c1">-- something</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span><span class="p">))</span>
</code></pre></div><p>一方でこうも書ける｡</p><div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="cm">--[[
2_2_forcnt.lua
]]</span>

<span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="nb">require</span><span class="s1">'testsuite'</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span><span class="o">=</span><span class="n">_ENV</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_exectime</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">for</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
    <span class="c1">-- somethihg</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span><span class="p">))</span>
</code></pre></div><h3 id="%E7%B5%90%E6%9E%9C"><a class="headerlink" href="#%E7%B5%90%E6%9E%9C">結果</a></h3><table>
<thead>
<tr>
<th style="text-align: right">file</th>
<th>実行時間(sec)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right">docnt</td>
<td>13.829463998477</td>
</tr>
<tr>
<td style="text-align: right"><strong>forcnt</strong></td>
<td><strong>5.6234021186829</strong></td>
</tr>
</tbody>
</table><p>約2倍の差が出た｡これはfor文が変数に足し算して更新してるのに対し､while文は1回ごとに数値の比較をしているという点で差がでたようだ｡</p><h2 id="2.3+%3Ccode%3E%23t+%26gt%3B+0%3C%2Fcode%3E%0A"><a class="headerlink" href="#2.3+%3Ccode%3E%23t+%26gt%3B+0%3C%2Fcode%3E%0A">2.3 <code>#t &gt; 0</code>
</a></h2><p>table <code>t</code>の長さは0か? という問いはLuaでよく使われます｡<code>#t &gt; 0</code>という式は多くのコードに存在する｡</p><div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="cm">--[[
2_3_sharpIfZero.lua
]]</span>

<span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="nb">require</span><span class="s1">'testsuite'</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span><span class="o">=</span><span class="n">_ENV</span><span class="p">})</span>

<span class="c1">-- #t == 500000000だとメモリが足りないと怒られるので200000000に減らしました｡</span>
<span class="kd">local</span> <span class="n">REP</span> <span class="o">=</span> <span class="mi">200000000</span>
<span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">-- おっきなテーブルをつくる</span>
<span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
  <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
<span class="k">end</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_exectime</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">_</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
    <span class="k">if</span> <span class="o">#</span><span class="n">t</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span>      
      <span class="nb">table.remove</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span><span class="p">))</span>
</code></pre></div><p>また<code>t[1]</code>を見ることでもいけそうですね｡</p><div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="cm">--[[
2_3_indexIfZero.lua
]]</span>

<span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="nb">require</span><span class="s1">'testsuite'</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span><span class="o">=</span><span class="n">_ENV</span><span class="p">})</span>

<span class="kd">local</span> <span class="n">REP</span> <span class="o">=</span> <span class="mi">200000000</span>
<span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">-- おっきなテーブルをつくる</span>
<span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
  <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
<span class="k">end</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_exectime</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">_</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="cm">--[[ここが変更点]]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span>      
      <span class="nb">table.remove</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span><span class="p">))</span>
</code></pre></div><p>Luaには<a href="https://www.lua.org/manual/5.3/manual.html#pdf-next" target="_blank" rel="noopener noreferrer"><code>next</code></a>という関数がある｡
第1引数にtable､第2引数にindexを渡すと､table[index]<strong>の次</strong>の<em>key</em>と<em>value</em>を返す｡
<strong>次</strong> is 何なんですが､辞書順っぽいですねこれは｡Luaのtableといえばつまるところ連想配列のようなもので､はい｡</p><p>ここでindexが<code>nil</code>のとき､tableの最初のkeyとvalueを返します｡
<strong>tableが空のとき<code>nil</code>を返します</strong>｡<code>#t &gt; 0</code>の代わりにこれを使うことができそうですね｡</p><div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="cm">--[[
2_3_nextIfZero.lua
]]</span>

<span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="nb">require</span><span class="s1">'testsuite'</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span><span class="o">=</span><span class="n">_ENV</span><span class="p">})</span>

<span class="kd">local</span> <span class="n">REP</span> <span class="o">=</span> <span class="mi">200000000</span>
<span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">-- おっきなテーブルをつくる</span>
<span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
  <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
<span class="k">end</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_exectime</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">_</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
    <span class="k">if</span> <span class="nb">next</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="cm">--[[ここが変更点]]</span> <span class="k">then</span>
      <span class="nb">table.remove</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span><span class="p">))</span>
</code></pre></div><h3 id="%E7%B5%90%E6%9E%9C"><a class="headerlink" href="#%E7%B5%90%E6%9E%9C">結果</a></h3><table>
<thead>
<tr>
<th style="text-align: right">file</th>
<th>実行時間(sec)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right">sharpIfZero</td>
<td>183.32232999801</td>
</tr>
<tr>
<td style="text-align: right"><strong>indexIfZero</strong></td>
<td><strong>99.531152645747</strong></td>
</tr>
<tr>
<td style="text-align: right">nextIfZero</td>
<td>105.69196510315</td>
</tr>
</tbody>
</table><p><code>next</code>を力説しておきながらindexIfZeroに負けましたね｡なぜかというと<code>next</code>のあとに<code>t[1]</code>を思い出したからです｡</p><h3 id="%E5%82%99%E8%80%83"><a class="headerlink" href="#%E5%82%99%E8%80%83">備考</a></h3><p><code>next</code>くん､実はダメでは疑惑ということで<code>t = {}</code>のときを見てみる｡</p><div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="cm">--[[
2_3_sharpConstantZero.lua
]]</span>

<span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="nb">require</span><span class="s1">'testsuite'</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span><span class="o">=</span><span class="n">_ENV</span><span class="p">})</span>

<span class="kd">local</span> <span class="n">REP</span> <span class="o">=</span> <span class="mi">200000000</span>
<span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{}</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_exectime</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
    <span class="k">if</span> <span class="o">#</span><span class="n">t</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="cm">--[[まずは#t]]</span> <span class="k">then</span>
      <span class="nb">table.remove</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span><span class="p">))</span>
</code></pre></div><div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="cm">--[[
2_3_indexConstantZero.lua
]]</span>

<span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="nb">require</span><span class="s1">'testsuite'</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span><span class="o">=</span><span class="n">_ENV</span><span class="p">})</span>

<span class="kd">local</span> <span class="n">REP</span> <span class="o">=</span> <span class="mi">200000000</span>
<span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{}</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_exectime</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="cm">--[[頭を見る]]</span> <span class="k">then</span>
      <span class="nb">table.remove</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span><span class="p">))</span>
</code></pre></div><div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="cm">--[[
2_3_nextConstantZero.lua
]]</span>

<span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="nb">require</span><span class="s1">'testsuite'</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span><span class="o">=</span><span class="n">_ENV</span><span class="p">})</span>

<span class="kd">local</span> <span class="n">REP</span> <span class="o">=</span> <span class="mi">200000000</span>
<span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{}</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_exectime</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
    <span class="k">if</span> <span class="nb">next</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="cm">--[[最後にnext]]</span> <span class="k">then</span>
      <span class="nb">table.remove</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span><span class="p">))</span>
</code></pre></div><h4>結果</h4><table>
<thead>
<tr>
<th style="text-align: right">file</th>
<th>実行時間(sec)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right">sharpConstantZero</td>
<td>5.9717473189036</td>
</tr>
<tr>
<td style="text-align: right"><strong>indexConstantZero</strong></td>
<td><strong>4.908634742101</strong></td>
</tr>
<tr>
<td style="text-align: right"><em>nextConstantZero</em></td>
<td><em>15.312809944153</em></td>
</tr>
</tbody>
</table><p>わずかですがindexの勝ちです｡そして<code>next</code>が3倍遅いンゴねぇ…｡</p><h1 id="3.+%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><a class="headerlink" href="#3.+%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB">3. おわりに</a></h1><p>手動最適化できる箇所はまだまだあると思いますがボクが気づいたのはこの辺でした｡みなさんもぜひ最適化できそうな箇所をシェアしてください｡
末尾最適化もあるので書こうと思いましたが心が折れました｡</p><p><em>LuaJIT2.1の命令に基づいた関数選び</em> などもやろうと思ったんですが､ちょっと重くなりそうなんでまた(気が向いたら)書きます｡
section 2.がLuaなのは途中まで書く気があったという意志の現れです <img class="emoji" title=":triumph:" alt=":triumph:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f624.png" height="20" width="20"></p>