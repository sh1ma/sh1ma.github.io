<!DOCTYPE html>
<html>
  <head>
    <title>Lua5.2から5.3への内部表現について💢 &#47; lilyum ensemble</title>
    <meta content="text/html;charset=UTF-8" http-equiv="content-type">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Satoru Kawahara">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="lilyum ensemble">
    <meta name="twitter:creator" content="Satoru Kawahara"> 
    <meta name="twitter:text:description" content="Lua5.2から5.3への内部表現について💢">
    <meta name="twitter:title" content="Lua5.2から5.3への内部表現について💢"> 
    <meta name="twitter:url" content="https://nymphium.github.io/2016/06/17/luaexpression.html"> 
    <meta name="twitter:description" content="こんにちは､びしょ〜じょです｡極めて眠いホトトギス">
    <meta name="twitter:image:src" content="https://nymphium.github.io/pictures/github_icon.png">
    <meta name="description" content="こんにちは､びしょ〜じょです｡極めて眠いホトトギス">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="https://nymphium.github.io/2016/06/17/luaexpression.html">
    <link rel="alternate" type="application/rss+xml" title="lilyum ensemble" href="https://nymphium.github.io/feed.xml">
    <link href="https://fonts.googleapis.com/css?family=Comfortaa:300%7CDroid+Sans+Mono%7CCrimson+Text:400,400i" rel="stylesheet">
  </head>

  <body>
    <header class="site-header">
      <div class="wrapper" style="font-family: 'Comfortaa';">
        <a class="site-title" href="/">lilyum ensemble</a>
        <nav class="site-nav">
          <div class="trigger">
            <a class="page-link" href="/slide.html">Slides</a>
            <a class="page-link" href="/tags.html">Tags</a>
          </div>
        </nav>
      </div>
    </header>

    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
          <header class="post-header">
            <h1 class="post-title" itemprop="name headline">Lua5.2から5.3への内部表現について💢</h1>
            <span class="post-meta">
              <time datetime="2016-06-17T00:00:00+09:00" itemprop="datePublished">Jun 17, 2016</time>
              <p>tag: &#123;<a href="/tags.html#Lua-ref">Lua</a>&#125;</p>
            </span>
            <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
            <script type="text/javascript" src="https://rawgit.com/JoelSutherland/GitHub-jQuery-Repo-Widget/master/jquery.githubRepoWidget.min.js"></script>
            <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
            <script type="text/x-mathjax-config">
MathJax.Hub.Config({
	extensions: ["tex2jax.js"],
	"HTML-CSS": {
		scale: 80,
		availableFonts: ["TeX"],
	},
	tex2jax: {
		inlinemath: [['$', '$']],
		displaymath: [["\\[", "\\]"]]
	}
});
            </script>
          </header>
          <div class="post-content" itemprop="articleBody">
<p>こんにちは､びしょ〜じょです｡極めて眠いホトトギス</p>
<h1 id="1">1. はじめに</h1>
<p>Lua5.2のVMのバイトコードをデコードする物体を用いて､Lua5.3のVMのバイトコードをデコードしようとしたら結構つまづきました｡という話｡
Luaはわりと､関数が減っただ増えただ程度の変更しか無く､互換性は高いかのように見えますが､内部ではガッツリ変わってるんですねぇここ2ヶ月で思い知らされました｡</p>
<h1 id="2-internal-constant-expression">2. internal constant expression</h1>
<p>luaファイルを<code>luac</code>でコンパイルすると<em>luac.out</em>というファイルが得られます｡</p>
<p>ところで<code>"hoge"</code>とか<code>3</code>などの定数はluac.outのfunction blockのconstants listという部分に､コード中での出現順に格納されます｡
もう少し解説すると､constants listは以下のような構造になっている｡</p>
<p>\[
[格納されている定数の数(4\mathsf{byte})][定数[種類(1\mathsf{byte}) 種類別(n\ \mathsf{byte})]…]
\]</p>
<p>この種類がクセモノなんですねぇ…｡</p>
<h1 id="3-integer-long-string">3. 型が増えた? integer, long string</h1>
<p>まずこの種類について見ていきます｡constants listに現れる種類は以下のようになります｡</p>
<table>
<thead>
<tr>
<th style="text-align: left">type</th>
<th style="text-align: right">value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">nil</td>
<td style="text-align: right">00</td>
</tr>
<tr>
<td style="text-align: left">bool</td>
<td style="text-align: right">01</td>
</tr>
<tr>
<td style="text-align: left">number</td>
<td style="text-align: right">03</td>
</tr>
<tr>
<td style="text-align: left">string</td>
<td style="text-align: right">04</td>
</tr>
</tbody>
</table>
<p>次のようなコードを考える｡</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="c1">-- hoge.lua</span>
<span class="kd">local</span> <span class="n">a</span> <span class="o">=</span> <span class="s2">"aaaaaaaa...aaaa"</span> <span class="c1">-- 256文字以上で適当に､ここでは256文字とする</span>
<span class="kd">local</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">3</span><span class="p">.</span><span class="mi">0</span>
<span class="kd">local</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">4</span>
</code></pre></div>
<h2 id="3-1-until-lua-5-2">3-1. until Lua 5.2</h2>
<p>まずLua5.2でコンパイルしてバイトコードを見てみる｡</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ luac5.2  hoge.lua
$ xxd -g 1 luac.out
00000000: 1b 4c 75 61 52 00 01 04 08 04 08 00 19 93 0d 0a  .LuaR...........
00000010: 1a 0a 00 00 00 00 00 00 00 00 00 01 03 04 00 00  ................
00000020: 00 01 00 00 00 41 40 00 00 81 80 00 00 1f 00 80  .....A@.........
00000030: 00 03 00 00 00 04 01 01 00 00 00 00 00 00 61 61  ..............aa
00000040: 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61  aaaaaaaaaaaaaaaa
......
00000130: 61 61 61 61 61 61 61 61 61 61 61 61 61 61 00 03  aaaaaaaaaaaaaa..
00000140: 00 00 00 00 00 00 08 40 03 00 00 00 00 00 00 10  .......@........
00000150: 40 00 00 00 00 01 00 00 00 01 00 0a 00 00 00 00  @...............
......
</code></pre></div>
<p>ヘッダがあり､(中略)､0x00000031からconstants listです｡
ちなみにヘッダからリトルエンディアンであることがわかるので､最初の<code>03 00 00 00</code>はつまり"3"､定数の数です｡一致していますね｡</p>
<p>次に定数が3つ出現順に見えますはい｡ここから本題なんやな｡</p>
<h3 id="3-1-1-string-a">3-1-1. string <code>a</code>
</h3>
<p>まず1byte､種類がみえてくるわけですが<code>04</code>ということはつまりstring､これはつまり変数<code>a</code>に格納される定数<code>"aaaaaa....aa"</code>ですね｡
次の8byteは実は文字列の長さなんですねぇ､はい｡<code>01 01 00 00 00 00 00 00</code>ということで､リトルエンディアンで解釈すると257文字ですか､この+1は<code>\0</code>ですねわかります｡
さて257byteみていくと､たしかに0x61が256個並んで最後に0x00があります｡いいですね｡ここまでで0x0000013eまで読みました｡</p>
<h3 id="3-1-2-number-b-c">3-1-2. number <code>b</code>, <code>c</code>
</h3>
<p>さて続きまして1byte見ると<code>03</code>ということで､numberですか｡8byte読んでみてください｡はい<code>00 00 00 00 00 00 08 40</code>ということですがまずこれをIEEE 754 単精度浮動小数点数にするんやな…｡
ではこちらをご覧ください｡</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">decodenum</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">mantissa</span> <span class="o">=</span> <span class="p">(</span><span class="n">input</span><span class="p">:</span><span class="n">byte</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span> <span class="o">%</span> <span class="mi">16</span>

  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
    <span class="n">mantissa</span> <span class="o">=</span> <span class="n">mantissa</span> <span class="o">*</span> <span class="p">(</span><span class="mi">256</span> <span class="o">+</span> <span class="n">input</span><span class="p">:</span><span class="n">byte</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="kd">local</span> <span class="n">exponent</span> <span class="o">=</span> <span class="p">((</span><span class="n">input</span><span class="p">:</span><span class="n">byte</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span> <span class="o">%</span> <span class="mi">128</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">input</span><span class="p">:</span><span class="n">byte</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span> <span class="o">//</span> <span class="mi">16</span>

  <span class="k">if</span> <span class="n">exponent</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
    <span class="k">return</span> <span class="mi">0</span>
  <span class="k">end</span>

  <span class="n">mantissa</span> <span class="o">=</span> <span class="p">(</span><span class="nb">math.ldexp</span><span class="p">(</span><span class="n">mantissa</span><span class="p">,</span> <span class="o">-</span><span class="mi">52</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">input</span><span class="p">:</span><span class="n">byte</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">127</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>

  <span class="k">return</span> <span class="nb">math.ldexp</span><span class="p">(</span><span class="n">mantissa</span><span class="p">,</span> <span class="n">exponent</span> <span class="o">-</span> <span class="mi">1023</span><span class="p">)</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="n">ieee754</span> <span class="o">=</span> <span class="nb">string.char</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">decodenum</span><span class="p">(</span><span class="n">ieee754</span><span class="p">))</span> <span class="c1">--&gt; 3.0</span>
</code></pre></div>
<p>はい､<code>3.0</code>ということで､<code>b</code>ですね｡OK｡0x00000147まで読みました｡</p>
<p>同様にして次は<code>4.0</code>ですねはい論破</p>
<h2 id="3-2-lua-5-3">3-2. Lua 5.3</h2>
<p>いやいや内部表現変わらんでしょ→死</p>
<p>ではコンパイルしてみる｡</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ luac5.3 hoge.lua
$ xxd -g 1 luac.out
00000000: 1b 4c 75 61 53 00 19 93 0d 0a 1a 0a 04 08 04 08  .LuaS...........
00000010: 08 78 56 00 00 00 00 00 00 00 00 00 00 00 28 77  .xV...........(w
00000020: 40 01 0a 40 68 6f 67 65 2e 6c 75 61 00 00 00 00  @..@hoge.lua....
00000030: 00 00 00 00 00 02 03 04 00 00 00 01 00 00 00 41  ...............A
00000040: 40 00 00 81 80 00 00 26 00 80 00 03 00 00 00 14  @......&amp;........
00000050: ff 01 01 00 00 00 00 00 00 61 61 61 61 61 61 61  .........aaaaaaa
00000060: 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61  aaaaaaaaaaaaaaaa
......
00000150: 61 61 61 61 61 61 61 61 61 03 00 00 00 00 00 00  aaaaaaaaa.......
00000160: 08 40 13 04 00 00 00 00 00 00 00 01 00 00 00 01  .@..............
......
</code></pre></div>
<p>ウーン､そうですか…｡0x0000004bからconstants listが始まり､<code>03 00 00 00</code>からconstantは3つということがわかるんですが…｡</p>
<h3 id="3-2-1-long-string">3-2-1. long string ←は?</h3>
<p>1byte読みすすめると早速0x14という謎の種類が爆誕するんですねぇ実はコレLua5.3から追加されたlong stringですが内部表現のみに現れるので皆さん安心してください｡</p>
<p>さらに進めてみると<code>ff 01 01 00 00 00 00 00 00 61 61 61 61 61 ......</code>というよくわからない感じになってますね｡
0x61は'a'だというのはわかる｡その前の<code>ff 01 01 00 00 00 00 00 00</code>はおそらく文字列の長さなんですが､なんだこれは｡
256文字なので､0x0100か’\0'を追加した0x0101という表現がどこかにあるはずで､ありますね <code>01 01 00 00 00 00 00 00</code>｡
頭の<code>ff</code>は変わらないんで､<code>14 ff</code>がobject typeだと思っていいんじゃないでしょうか｡
で､0x100文字で<code>a</code>が出土したと｡ポイントは､’\0'はいらなくなったので<code>0x101 - 1</code> ですね｡</p>
<p>ネタバレをいうと､255文字以下はLua 5.2までと同じです｡0xff文字以下とそれより上を別のオブジェクトとすることで､何か良いことがあるんですかねぇ謎｡</p>
<h3 id="3-2-2-integer">3-2-2. integer ←は?</h3>
<p>まぁええわ｡次は<code>b</code>ですね〜ハイハイ同じ感じで<code>03 00 00 00 00 00 00 08 40</code>ですね終わり｡この時点で0x00000161まで読みました｡</p>
<p>次に<code>13</code>というのが来て､民衆は困惑するんですねぇ…｡と思ったけどじつはだいぶ素直で､8byte読んでみると<code>04 00 00 00 00 00 00 00</code>でこれはリトルエンディアンで読むとたちどころに<code>4</code>であることが分かってしまう｡</p>
<p><em>まさにintegerって感じですね!</em> Lua 5.3からbitwise operation(<code>&amp;</code>, <code>|</code>, <code>&lt;&lt;</code>, <code>&gt;&gt;</code>, <code>bit32</code>モジュール)が追加されたので､これを速く動かしたいという狙いなのかもしれない｡ちなみにsigned integerなので0x7fffffffffffffff(16桁)がINT_MAXッシュ</p>
<h3 id="3-2-3-lua-5-3">3-2-3. Lua 5.3での内部のオブジェクトの種類</h3>
<p>つまりこう｡</p>
<table>
<thead>
<tr>
<th style="text-align: left">type</th>
<th style="text-align: right">value</th>
<th style="text-align: left">備考</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">nil</td>
<td style="text-align: right">00</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: left">bool</td>
<td style="text-align: right">01</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: left">number</td>
<td style="text-align: right">03</td>
<td style="text-align: left">64bit float</td>
</tr>
<tr>
<td style="text-align: left">integer</td>
<td style="text-align: right">13</td>
<td style="text-align: left">64bit signed int</td>
</tr>
<tr>
<td style="text-align: left">string</td>
<td style="text-align: right">04</td>
<td style="text-align: left">長さ255以下の文字列</td>
</tr>
<tr>
<td style="text-align: left">long string</td>
<td style="text-align: right">14</td>
<td style="text-align: left">長さ256以上の文字列</td>
</tr>
</tbody>
</table>
<p>nilとboolってさぁ…<code>LOADNIL</code>命令と<code>LOADBOOL</code>命令があるんだから定数としてなんていらないんだよなぁ…｡</p>
<h1 id="4">4. ベンチマーク</h1>
<p>long stringはどれくらい活きるのか､integerは､ファイッ</p>
<h2 id="4-1">4-1. 環境</h2>
<table>
<thead>
<tr>
<th style="text-align: right">key</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right">CPU</td>
<td>Intel® Core™ i5-5200U CPU @ 2.20GHz</td>
</tr>
<tr>
<td style="text-align: right">OS</td>
<td>Arch Linux 4.6.2-1-ARCH</td>
</tr>
</tbody>
</table>
<p>処理系はLua 5.2.5､5.3.3を使用</p>
<h2 id="4-2-prerequirement">4-2. Prerequirement</h2>
<div class="highlight"><pre><code class="language-" data-lang="">$ luarocls --local install luasock
$ luarocls-5.2 --local install luasock
</code></pre></div>
<p>こんなファイルを用意</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="cm">--[[
testsuite.lua
]]</span>

<span class="kd">local</span> <span class="n">sock</span> <span class="o">=</span> <span class="nb">require</span><span class="s1">'socket'</span>

<span class="k">return</span> <span class="p">{</span>
  <span class="n">REP</span> <span class="o">=</span> <span class="mi">500000000</span><span class="p">,</span> <span class="c1">-- 感謝の5億回ループ</span>

  <span class="c1">-- 関数fnの実行時間を測る</span>
  <span class="n">get_exectime</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">sock</span><span class="p">.</span><span class="n">gettime</span><span class="p">()</span>
    <span class="n">fn</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">sock</span><span class="p">.</span><span class="n">gettime</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span>
  <span class="k">end</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="4-3-long-string">4-3. long string</h2>
<p>次のようなものを考える｡メモリの確保･開放を見る｡</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="nb">require</span><span class="s1">'testsuite'</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span><span class="o">=</span><span class="n">_ENV</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_exectime</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
    <span class="kd">local</span> <span class="n">str</span> <span class="o">=</span> <span class="s2">"aaaaaaaaaaaaaaaaaaaaaaaaaaa"</span>
  <span class="k">end</span>
<span class="k">end</span><span class="p">))</span>
</code></pre></div>
<p>こういうときbashが便利なんですよ〜〜</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>0<span class="p">;</span>i&lt;10<span class="p">;</span>i++<span class="o">))</span> <span class="o">{</span>
  lua alloc.lua<span class="p">;</span>
  sleep 3
<span class="o">}</span> | awk <span class="s1">'{i+= $1}END{print i / 10.00}'</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left">version</th>
<th style="text-align: right">time(sec)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">5.2</td>
<td style="text-align: right">5.25221</td>
</tr>
<tr>
<td style="text-align: left">5.3</td>
<td style="text-align: right">3.72571</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="nb">require</span><span class="s1">'testsuite'</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span><span class="o">=</span><span class="n">_ENV</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_exectime</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">str</span> <span class="o">=</span> <span class="s2">"aaaaaaaaaaaaaaaaaaaaaaaaaaa"</span> <span class="c1">-- &lt; 256</span>

  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
    <span class="n">str</span><span class="p">:</span><span class="n">upper</span><span class="p">()</span>
  <span class="k">end</span>
<span class="k">end</span><span class="p">))</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left">version</th>
<th style="text-align: right">time(sec)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">5.2</td>
<td style="text-align: right">67.8894</td>
</tr>
<tr>
<td style="text-align: left">5.3</td>
<td style="text-align: right">68.0755</td>
</tr>
</tbody>
</table>
<p>long stringを見る｡</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="nb">require</span><span class="s1">'testsuite'</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span><span class="o">=</span><span class="n">_ENV</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_exectime</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
    <span class="kd">local</span> <span class="n">str</span> <span class="o">=</span> <span class="s2">"aaaaaaaaaaa......aaaaa"</span> <span class="c1">-- 256文字</span>
  <span class="k">end</span>
<span class="k">end</span><span class="p">))</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left">version</th>
<th style="text-align: right">time(sec)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">5.2</td>
<td style="text-align: right">5.25645</td>
</tr>
<tr>
<td style="text-align: left">5.3</td>
<td style="text-align: right">3.72407</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="nb">require</span><span class="s1">'testsuite'</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span><span class="o">=</span><span class="n">_ENV</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_exectime</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">str</span> <span class="o">=</span> <span class="s2">"aaaaaaaaaaa......aaaaa"</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
    <span class="n">str</span><span class="p">:</span><span class="n">upper</span><span class="p">()</span>
  <span class="k">end</span>
<span class="k">end</span><span class="p">))</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left">version</th>
<th style="text-align: right">time(sec)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">5.2</td>
<td style="text-align: right">224.461</td>
</tr>
<tr>
<td style="text-align: left">5.3</td>
<td style="text-align: right">217.083</td>
</tr>
</tbody>
</table>
<p>あんまおもんないですね｡</p>
<p>とりあえずtableのkeyにつっこむか｡</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="nb">require</span><span class="s1">'testsuite'</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span><span class="o">=</span><span class="n">_ENV</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_exectime</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">str</span> <span class="o">=</span> <span class="s2">"aaaaaaaaaaa......aaaaa"</span>
    <span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
        <span class="kd">local</span> <span class="n">_</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">))</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left">version</th>
<th style="text-align: right">time(sec)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">5.2</td>
<td style="text-align: right">13.2316</td>
</tr>
<tr>
<td style="text-align: left">5.3</td>
<td style="text-align: right">13.4676</td>
</tr>
</tbody>
</table>
<p>あんまおもんないですね｡</p>
<h2 id="4-4-integer-number">4-4. integer/number</h2>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="nb">require</span><span class="s1">'testsuite'</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span><span class="o">=</span><span class="n">_ENV</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_exectime</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
        <span class="kd">local</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">))</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left">version</th>
<th style="text-align: right">time(sec)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">5.2</td>
<td style="text-align: right">5.53783</td>
</tr>
<tr>
<td style="text-align: left">5.3</td>
<td style="text-align: right">3.91654</td>
</tr>
</tbody>
</table>
<p>おもむろにtableのkeyにつっこんでみます｡</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="nb">require</span><span class="s1">'testsuite'</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span><span class="o">=</span><span class="n">_ENV</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_exectime</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">4</span><span class="p">.</span><span class="mi">0</span> <span class="c1">-- number</span>
    <span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">9</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
        <span class="kd">local</span> <span class="n">_</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">))</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left">version</th>
<th style="text-align: right">time(sec)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">5.2</td>
<td style="text-align: right">9.43846</td>
</tr>
<tr>
<td style="text-align: left">5.3</td>
<td style="text-align: right">9.59013</td>
</tr>
</tbody>
</table>
<p>はい｡</p>
<p>ではinteger vs numberではドウカナ…</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="nb">require</span><span class="s1">'testsuite'</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span><span class="o">=</span><span class="n">_ENV</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_exectime</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1">-- integer</span>
    <span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">9</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
        <span class="kd">local</span> <span class="n">_</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">))</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left">version</th>
<th style="text-align: right">time(sec)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">5.2</td>
<td style="text-align: right">9.13759</td>
</tr>
<tr>
<td style="text-align: left">5.3</td>
<td style="text-align: right">6.32312</td>
</tr>
</tbody>
</table>
<p>ｲｲﾈ･</p>
<p>ところで! ところでですよ奥さん｡Lua 5.3には<code>math.tointeger()</code>という関数が追加されて､機能は名前の通りです｡</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="nb">require</span><span class="s1">'testsuite'</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span><span class="o">=</span><span class="n">_ENV</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_exectime</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">4</span><span class="p">.</span><span class="mi">0</span>
    <span class="kd">local</span> <span class="n">numi</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">tointeger</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">9</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REP</span> <span class="k">do</span>
        <span class="kd">local</span> <span class="n">_</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">numi</span><span class="p">]</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">))</span>
</code></pre></div>
<p>てな感じでnumberからintegerに変換すると､</p>
<table>
<thead>
<tr>
<th style="text-align: left">version</th>
<th style="text-align: right">time(sec)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">5.2</td>
<td style="text-align: right">—</td>
</tr>
<tr>
<td style="text-align: left">5.3</td>
<td style="text-align: right">6.38205</td>
</tr>
</tbody>
</table>
<p>という具合ですね｡</p>
<h2 id="4-5">4-5. さらなる詳細</h2>
<p><code>grep -rE 'LUA_(TNUMINT|TLNGSTR)' lua-5.3.3/src</code> してください(飽きた)｡</p>
<h1 id="5">5. おわりに</h1>
<p>stringは何も変わらなくてつまらない感じでしたが､integer型はtableのindexingでそこそこの性能がありますね｡
ボクはbytecodeの解析時にLua 5.2のノリで5.3をやったら突然の種類追加につまづいたので､みなさんもつまづいてください｡</p>
<hr>
<p>このサイトのCSSやら何やらをいじって可愛い感じになったので､可愛い気持ちになってください｡</p>
          </div>
        </article>

      </div>
    </div>
    <footer>
      <div class="pagination btn-group" style="text-align: center; font-family: 'Comfortaa';">
        <a class="btn prev" href="/2016/06/11/%E4%BB%8A%E6%97%A5%E3%81%AFSB69%E3%81%AE%E6%97%A5.html" title="今日はSB69の日">&larr; Prev</a>
        &#47;<a class="btn" href="/">Top</a>&#47;
        <a class="btn next" href="/2016/06/26/RAID0%E3%81%AAF2FS%E3%81%ABArch%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B.html" title="RAID0なF2FSにArchをインストールする">Next &rarr;</a>
      </div>
    </footer>

  </body>
</html>
