<p>こんにちは､びしょ〜じょです｡最近GTX 750 Tiを買ったんですが､その金でCPUをもう少しマシにしたほうが良かったと思いました｡おわり｡</p><h1 id="%E6%BA%96%E5%82%99"><a class="headerlink" href="#%E6%BA%96%E5%82%99">準備</a></h1><p>ArchLinuxの話です｡まず <code>nvidia-settings</code>コマンドが使いたいので <em>nvidia-settings</em> をインストールします｡
ArchWikiだと<em>nvidia-utils</em> パッケージに入ってるような話しぶりですが実はそうではない(2016/05/09現在)｡</p><p>GPUファンを触りたいのでxorg.conf(.d)をいじる｡Device SectionでターゲットのGPUに言及しているところで     <code>Option "Coolbits" "4"</code> を追加する｡</p><div class="highlight">
<span class="listing-name">20-nvidia.conf</span><pre><code class="language-conf" data-lang="conf"><span class="n">Section</span> <span class="s2">"Device"</span>
    <span class="n">Identifier</span>     <span class="s2">"Device0"</span>
    <span class="n">Driver</span>         <span class="s2">"nvidia"</span>
    <span class="n">VendorName</span>     <span class="s2">"NVIDIA Corporation"</span>
    <span class="n">BoardName</span>      <span class="s2">"GeForce GTX 750 Ti"</span>
    <span class="n">Option</span>         <span class="s2">"Coolbits"</span> <span class="s2">"4"</span>
    <span class="c"># ...
</span><span class="n">EndSection</span>
</code></pre>
</div><p>ひとまず再起動してください｡</p><h1 id="nvidia-settings"><a class="headerlink" href="#nvidia-settings">nvidia-settings</a></h1><p><code>nvidia-settings</code> コマンドでGUIが表示され､ <em>GPU 0</em> - <em>Thermal Settings</em> などを見てみると <strong>Enable GPU Fan Settings</strong> と下にバーがあると思います｡
これでファンの速度を調節できるわけですな｡</p><h2 id="cli"><a class="headerlink" href="#cli">cli</a></h2><p>さて自動化ということで､GUIを触っていくのは得策ではありません｡ <code>nvidia-settings</code>はコマンドラインにいろいろ渡すとGUIを触らなくてもよくなる｡</p><p><code>nvidia-settings -e list</code> とすると､CLIから触れるパラメータが出ます｡ボクもよくわからないので詳細ははぶきます｡"fan"などでgrepしてみると､いろいろ出てくる｡察していくと <strong>GPUFanControlState</strong>と<strong>GPUTargetFanSpeed</strong>が必要なことが分かった｡まず前者でファン速度を変更できるようになり(0がdisabled､1がenabled)､後者がファン速度(単位は%､0〜100の整数)</p><p>なるほど｡</p><p>GPUの温度からファンの速度を変更したくなってくる｡それは<code>nvidia-settings -q '[gpu:0]/GPUCoreTemp'</code>で取れる｡OK｡
あとはスクリプトを書いてみる｡</p><div class="highlight">
<span class="listing-name">fnctrl.sh</span><pre><code class="language-zsh" data-lang="zsh"><span class="c">#!/bin/zsh</span>

<span class="nv">temp</span><span class="o">=</span><span class="si">$(</span>nvidia-settings <span class="nt">-q</span> <span class="s1">'[gpu:0]/GPUCoreTemp'</span> | <span class="nb">grep </span>Attribute | <span class="nb">awk</span> <span class="s1">'{print $4}'</span><span class="si">)</span>

nvidia-settings <span class="nt">-a</span> <span class="nv">GPUFanControlState</span><span class="o">=</span>1

<span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">temp</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-gt</span> 40 <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> <span class="c"># 41度以上でファン速度が爆速</span>
    nvidia-settings <span class="nt">-a</span> <span class="nv">GPUTargetFanSpeed</span><span class="o">=</span>100
<span class="k">elif</span> <span class="o">[[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">temp</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-gt</span> 38 <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> <span class="c"># 39度から70%</span>
    nvidia-settings <span class="nt">-a</span> <span class="nv">GPUTargetFanSpeed</span><span class="o">=</span>70
<span class="k">else</span> <span class="c"># デフォルト</span>
    nvidia-settings <span class="nt">-a</span> <span class="nv">GPUTargetFanSpeed</span><span class="o">=</span>33
<span class="k">fi</span>
</code></pre>
</div><p>雑ですが､まぁよしとします｡</p><h1 id="systemd.timer%E3%81%A7%E6%B8%A9%E5%BA%A6%E3%82%92%E7%9B%A3%E8%A6%96"><a class="headerlink" href="#systemd.timer%E3%81%A7%E6%B8%A9%E5%BA%A6%E3%82%92%E7%9B%A3%E8%A6%96">systemd.timerで温度を監視</a></h1><p>systemdはなんでもできるし､cronも吸収した｡
5秒ごとに上のスクリプトを回したい｡
はいご覧の通り</p><div class="highlight"><pre><code class="language-gpufnctrl.service" data-lang="gpufnctrl.service">[Unit]
Description=gpu fan control

[Service]
Type=simple
ExecStart=/usr/bin/zsh /home/nymphium/.config/systemd/script/gpufanctrl.sh

[Install]
WantedBy=default.target
</code></pre></div><div class="highlight"><pre><code class="language-gpufnctrl.timer" data-lang="gpufnctrl.timer">[Unit]
Description=watch GPU temperature every 5 sec

[Timer]
OnBootSec=1min ; 起動してから1分後に開始
OnUnitActiveSec=5sec ;以後5秒毎
AccuracySec=5sec ; ブレ(?)を修正
Persistent=true ; これが動かすserviceがFAILUREしても続ける

[Install]
WantedBy=timers.target
</code></pre></div><p>serviceファイルと同じ名前(同じ名前ではない)のtimerファイルを作成することで､指定した時間にserviceが実行される｡
timerファイルの<code>[Timer]</code>の項に<code>Unit=hoge.service</code>などとすると別のserviceファイルのコントロールができる｡</p><p>最初<code>/etc/systemd/system/</code>に置いたところ､timerは動くがserviceがFAILUREしまくるというよくわからない事態に陥ったため､<code>~/.config/systemd/user/</code>に配置したら無事動いた｡</p><h1 id="%E3%81%9D%E3%81%AE%E4%BB%96"><a class="headerlink" href="#%E3%81%9D%E3%81%AE%E4%BB%96">その他</a></h1><blockquote class="twitter-tweet" data-lang="en">
<p lang="ja" dir="ltr">お母さんが母の日に欲しかったもの、これでしょ？<br><br>お母さん、いつもありがとう！<a href="https://twitter.com/hashtag/mothersday?src=hash" target="_blank" rel="noopener noreferrer">#mothersday</a> <a href="https://twitter.com/hashtag/%E6%AF%8D%E3%81%AE%E6%97%A5?src=hash" target="_blank" rel="noopener noreferrer">#母の日</a> <a href="https://twitter.com/hashtag/GameReady?src=hash" target="_blank" rel="noopener noreferrer">#GameReady</a> <a href="https://t.co/tEpeAmK6hp" target="_blank" rel="noopener noreferrer">pic.twitter.com/tEpeAmK6hp</a></p>— NVIDIA Japan (@NVIDIAJapan) <a href="&lt;div%20class=" enclosed-tweet align="center"><blockquote class="twitter-tweet">
<p lang="ja" dir="ltr">お母さんが母の日に欲しかったもの、これでしょ？<br><br>お母さん、いつもありがとう！<a href="https://twitter.com/hashtag/mothersday?src=hash&amp;ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">#mothersday</a> <a href="https://twitter.com/hashtag/%E6%AF%8D%E3%81%AE%E6%97%A5?src=hash&amp;ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">#母の日</a> <a href="https://twitter.com/hashtag/GameReady?src=hash&amp;ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">#GameReady</a> <a href="https://t.co/tEpeAmK6hp" target="_blank" rel="noopener noreferrer">pic.twitter.com/tEpeAmK6hp</a></p>— NVIDIA Japan (@NVIDIAJapan) <a href="https://twitter.com/NVIDIAJapan/status/729144379416272896?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">May 8, 2016</a>
</blockquote>

<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>“&gt;May 8, 2016</p></a>
</blockquote><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script><h1 id="%E5%8F%82%E8%80%83"><a class="headerlink" href="#%E5%8F%82%E8%80%83">参考</a></h1><p><a href="https://wiki.archlinux.org/index.php/Systemd/Timers" target="_blank" rel="noopener noreferrer">systemd/Timers</a> ArchWiki
<a href="http://qiita.com/sharow/items/e8f7d3e0628d7ee925db" target="_blank" rel="noopener noreferrer">systemdでの定期実行(timerユニット)</a> Qiita</p>