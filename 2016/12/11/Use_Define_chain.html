<!DOCTYPE html>
<html>
  <head>
    <title>Define-Use chainとその構成法 &#47; lilyum ensemble</title>
    <meta content="text/html;charset=UTF-8" http-equiv="content-type">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Satoru Kawahara">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="lilyum ensemble">
    <meta name="twitter:creator" content="Satoru Kawahara"> 
    <meta name="twitter:text:description" content="Define-Use chainとその構成法">
    <meta name="twitter:title" content="Define-Use chainとその構成法"> 
    <meta name="twitter:url" content="https://nymphium.github.io/2016/12/11/Use_Define_chain.html"> 
    <meta name="twitter:description" content="こんにちは､びしょ〜じょです｡これは言語実装 Advent Calendar 201611日目の記事です｡百合が好きなんですが､百合以外にも活動はしているということで､百合以外の活動について今回触れたいと､えぇ､思います｡">
    <meta name="twitter:image:src" content="https://nymphium.github.io/pictures/github_icon.png">
    <meta name="description" content="こんにちは､びしょ〜じょです｡これは言語実装 Advent Calendar 201611日目の記事です｡百合が好きなんですが､百合以外にも活動はしているということで､百合以外の活動について今回触れたいと､えぇ､思います｡">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="https://nymphium.github.io/2016/12/11/Use_Define_chain.html">
    <link rel="alternate" type="application/rss+xml" title="lilyum ensemble" href="https://nymphium.github.io/feed.xml">
    <link href="https://fonts.googleapis.com/css?family=Comfortaa:300%7CDroid+Sans+Mono%7CCrimson+Text:400,400i" rel="stylesheet">
  </head>

  <body>
    <header class="site-header">
      <div class="wrapper" style="font-family: 'Comfortaa';">
        <a class="site-title" href="/">lilyum ensemble</a>
        <nav class="site-nav">
          <div class="trigger">
            <a class="page-link" href="/aboutme.html">About</a>
            <a class="page-link" href="/slide.html">Slides</a>
            <a class="page-link" href="/tags.html">Tags</a>
          </div>
        </nav>
      </div>
    </header>

    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
          <header class="post-header">
            <h1 class="post-title" itemprop="name headline">Define-Use chainとその構成法</h1>
            <span class="post-meta">
              <time datetime="2016-12-11T00:00:00+09:00" itemprop="datePublished">Dec 11, 2016</time>
              <p>tag: &#123;<a href="/tags.html#Lua-ref">Lua</a>, <a href="/tags.html#MoonScript-ref">MoonScript</a>&#125;</p>
            </span>
            <script type="text/javascript" src="/js/GithubRepoWidget.min.js"></script>
            <script type="text/javascript">setTimeout(GithubRepoWidget.init, 3000);</script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" integrity="sha384-9tPv11A+glH/on/wEu99NVwDPwkMQESOocs/ZGXPoIiLE8MU/qkqUcZ3zzL+6DuH" crossorigin="anonymous">
            <!-- The loading of KaTeX is deferred to speed up page rendering -->
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.js" integrity="sha384-U8Vrjwb8fuHMt6ewaCy8uqeUXv4oitYACKdB0VziCerzt011iQ/0TqlSlv8MReCm" crossorigin="anonymous"></script>
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/contrib/auto-render.min.js" integrity="sha384-aGfk5kvhIq5x1x5YdvCp4upKZYnA8ckafviDpmWEKp4afOZEqOli7gqSnh8I6enH" crossorigin="anonymous"
                    onload="renderMathInElement(document.body);"></script>
          </header>
          <div class="post-content" itemprop="articleBody">
<p>こんにちは､びしょ〜じょです｡これは<a href="http://qiita.com/advent-calendar/2016/lang_dev">言語実装 Advent Calendar 2016</a>11日目の記事です｡
百合が好きなんですが､百合以外にも活動はしているということで､百合以外の活動について今回触れたいと､えぇ､思います｡</p>
<h1 id="1">1. はじめに</h1>
<p>今年は通年の講義で<a href="https://lua.org">Lua</a> VMのバイトコードの最適化器を作っています｡
去年は<a href="https://nymphium.github.io/2016/01/13/llix.html">こんなもの</a>を作ってました｡
最適化器は最終報告会の後に公開しようと思っています｡</p>
<p>さて､とある文による定義(や代入)がそれ以降使われないとき､その文を削除したいなんていうケースがあります｡
はい､<a href="https://en.wikipedia.org/wiki/Dead_code_elimination">dead code elimination</a>などです｡
この"それ以降使われない"かどうかの判別に<em>Define-Use Chain</em>を使います｡</p>
<h2 id="1-1-prerequirements">1-1. prerequirements</h2>
<p>まずひとつに､example codesは実装言語に倣って<a href="https://moonscript.org">MoonScript</a>を使います｡
あまり分からなくてもいいですが､Luaのtableについて知っておいてもらえるとありがたいです､まぁだいたい連想配列でいいですはい｡</p>
<p>それともう一つ､今回は<em>Lua VM</em>というレジスターベースのVMの命令をターゲットにして進めます｡
Lua VM 5.3には47個の命令がありますが､今回簡単のため以下の5つで戦わせていただきます｡</p>
<ul>
<li>
<p><code>LOADK A B</code></p>

<p><code>レジスターA</code>にconstant listの<code>B</code>番目の値をブッ込みます｡<code>A = Cst(B)</code>といった感じで｡</p>
</li>
<li>
<p><code>ADD A B C</code></p>

<p><code>レジスターA</code> に<code>レジスターB</code>と<code>C</code>を足したものを格納する｡
つまり <code>A = B + C</code>と考えればいい｡</p>
</li>
<li>
<p><code>EQ A B C</code></p>

<p><code>XOR(A == 0, レジスターBの値 == レジスターCの値)</code>のときにプログラムカウンターをインクリメントする｡</p>

<p>つまり<code>XOR(A == 0, レジスターBの値 == レジスターCの値)</code>が真のときに次の命令を無視する｡</p>
</li>
<li>
<p><code>JMP A B</code></p>

<p>プログラムカウンターに<code>B</code>を足す｡<code>A</code>に関しては今回関係ないので省略｡
<code>JumpEq</code>みたいなものは<code>EQ</code>と<code>JMP</code>を並べて使うわけですね｡</p>
</li>
<li>
<p><code>RETURN A B</code></p>

<p>今回はトップレベルだけ考えるので､まぁプログラムの終了位置と考えてください｡本当は全然違うぞ｡</p>
</li>
</ul>
<p>まぁこれだけでいいか｡
簡単のためにだいぶ端折ってますんで､詳細はドキュメント…公式にそんなものはない<sup id="fnref1" title="Dibyendu Majumdar. Lua 5.3 Bytecode Reference "><a href="#fn1" rel="footnote">1</a></sup>)<sup id="fnref2" title="Kein-Hong Man. A No-Frills Introduction to Lua 5.1 VM Instructions "><a href="#fn2" rel="footnote">2</a></sup>)…Luaのソースコードを見てください｡</p>
<p>最後に一つ､後述しますがほとんど手探りなので<em>間違ってる可能性が極めて高い</em>です｡｢そうじゃなくてこうだ｣というのがあったら大変ありがたいですのでどしどしご指摘願います｡</p>
<hr>
<p>こんな感じのLua VMの命令を見てみましょうか｡</p>
<div class="highlight"><pre><code class="language-" data-lang="">LOADK 0 0 -- load `3`
LOADK 1 1 -- load `5`
LOADK 1 2 -- load `7` *&lt;!&gt;*
EQ 0 0 1 -- R(0) == R(1) ?
JMP 0 2
LOADK 2 2 -- load `7`
JMP 0 1
LOADK 2 3 -- load `9`
RETURN 0 1

constant list: [3, 5, 7, 9]
</code></pre></div>
<p>上から見ていくと､</p>
<ol>
<li>
<code>レジスター0</code>に<code>3</code>をロードして</li>
<li>
<code>レジスター1</code>に<code>5</code>をロードして､</li>
<li>
<code>レジスター1</code>に<code>7</code>をロードする｡</li>
<li>
<code>レジスター0</code>と<code>レジスター1</code>の値が同じかどうかを比較する</li>
<li>同じ場合は8. に飛ぶ</li>
<li>
<code>レジスター2</code>に<code>7</code>をロードして</li>
<li>9.に飛ぶ</li>
<li>
<code>レジスター2</code>に<code>9</code>をロードする</li>
<li>おわり</li>
</ol>
<p>なるほど｡3行目<em>&lt;!&gt;</em>は<code>レジスター1</code>の値を上書きしています｡
とすると2行目の彼は無駄なのでは…ということが人間はすぐに分かります｡すぐに分かる｡
しかしプログラムは書かないといけない｡
人間も､もっと複雑なものがでてくるとあっぷあっぷになる｡
ということで書く｡</p>
<h1 id="2-what-is-define-use-chain">2. What is Define-Use Chain?</h1>
<p>Wikipediaを読んで知った気になるのが趣味なので､Wikipediaを引用します｡</p>
<p><a href="https://en.wikipedia.org/wiki/Use-define_chain">Use-define chain - Wikipedia</a></p>
<blockquote>
<p>A Use-Definition Chain (UD Chain) is a data structure that consists of a use, U, of a variable, and all the definitions, D, of that variable that can reach that use without any other intervening definitions.
A definition can have many forms, but is generally taken to mean the assignment of some value to a variable (which is different from the use of the term that refers to the language construct involving a data type and allocating storage).</p>
</blockquote>
<p>オイオイこれは<em>Use-Define Chain</em>の記事じゃねーかってすみません｡</p>
<p>Use-Define Chainは､変数を使用する部分から､その変数の定義位置を逆引きするようなイメージですか｡
例で見ると､<code>EQ</code>からどこで定義されたレジスター<code>1</code>の値を使いたいか､ということになりますね｡</p>
<p><em>Define-Use Chain</em>はその逆で､定義から使用先が紐付けられています｡
例でいくと､2行目の宣言は誰も使ってないので参照する使用先が無い､3行目は<code>EQ</code>で使われるので使用先が1つある､となり2行目が不要であることが分かるわけですね!</p>
<h1 id="3-reachable-definition">3. Reachable Definition</h1>
<p>ただ､資料に乏しく､なんかウマイ感じのアルゴリズムの説明もありません｡
仕方なく雰囲気だけで我流の実装をしてみたところもちろんガバガバで爆死しました｡</p>
<p>先生に伺ったところ､｢<em>Reachable Definition</em>からちょっと発展させればできる｣とのことでした｡
Reachable Definition､それならちょっと前に読んだ本<sup id="fnref3" title="中田 育男, 佐々木 正孝, 滝本 宗宏, 渡邉 担. コンパイラの基盤技術と実践―コンパイラ・インフラストラクチャCOINSを用いて "><a href="#fn3" rel="footnote">3</a></sup>に出てきたなとなってなんとかなりそうだった｡</p>
<p>段階を追うのが下手なので､ここで強制的に段階を追わせていただきます｡
まず､Reachable Definitionについて語るために､<em>Control Flow Graph</em>について語る必要があります｡</p>
<h2 id="3-1-control-flow-graph-cfg">3-1. Control Flow Graph (CFG)</h2>
<p>簡単に言ってしまうと､プログラムの実行の流れをグラフにしたようなものです｡context-free grammarではないよ｡
最適化などでしょっちゅう使われる物体ですね<sup id="fnref4" title="Zdenek Dvorák, Jan Hubicka, Pavel Nejedlý, Josef Zlomek. Control Flow Graph - Infrastructure for Profile Driven Optimizations in GCC Compiler "><a href="#fn4" rel="footnote">4</a></sup>｡
各ノードは<em>基本ブロック</em>と呼ばれ､各ブロックには文が突っ込まれている｡
<sup id="fnref1" title="Dibyendu Majumdar. Lua 5.3 Bytecode Reference "><a href="#fn1" rel="footnote">1</a></sup>)によると､</p>
<blockquote>
<p>ブロック\(B_1\)からブロック\(B_2\)に有向辺が引かれるのは, 以下の場合である.</p>

<p>1) \(B_1\)の最後の文から\(B_2\)の最初の文へ無条件あるいは条件付き飛越しがある</p>

<p>2) \(B_1\)の最後が無条件飛越し文以外の文で終わっていて, プログラムの字面上で\(B_1\)の直後に\(B_2\)が来る</p>
</blockquote>
<p>とのこと｡</p>
<p>ブロックBから有向辺が伸びている先のブロックの集合を先行ブロック(successor)､
Bに向かって有向辺を向けているブロックの集合を後続ブロック(predecessor)となる｡</p>
<p>Lua VMの命令で見ていくと､<code>EQ</code>､<code>JP</code>と<code>RETURN</code>がブロックの出口となります｡
特に<code>RETURN</code>がブロック最後の命令のときは､先行ブロックがそのブロックに付きません｡</p>
<p>説明のため､基本ブロックは次のようなtableとなる:</p>
<div class="highlight"><pre><code class="language-moon" data-lang="moon"><span class="p">{</span><span class="w">
    </span><span class="ss">start:</span><span class="w"> </span><span class="p">(</span><span class="err">基本ブロックの開始行</span><span class="p">:</span><span class="w"> </span><span class="n">number</span><span class="p">)</span><span class="w"> </span><span class="c1">-- これいる</span><span class="w">
    </span><span class="ss">end:</span><span class="w">   </span><span class="p">(</span><span class="err">終了行</span><span class="p">:</span><span class="w"> </span><span class="n">number</span><span class="p">)</span><span class="w"> </span><span class="c1">-- これいる</span><span class="w">
    </span><span class="ss">succ:</span><span class="w">  </span><span class="p">{</span><span class="o">......</span><span class="p">}</span><span class="w"> </span><span class="c1">-- 先行ブロック､これ要らない</span><span class="w">
    </span><span class="ss">pred:</span><span class="w">  </span><span class="p">{</span><span class="o">......</span><span class="p">}</span><span class="w"> </span><span class="c1">-- 後続ブロック これいる</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>さてこれにより命令は以下のようなCFGになります(inspect<sup id="fnref5" title="Enrique Garcíao. inspect.lua "><a href="#fn5" rel="footnote">5</a></sup>による整形)｡</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{</span>
    <span class="k">end</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">succ</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">{</span>
        <span class="k">end</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="p">},</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">succ</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">{</span>
            <span class="k">end</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="p">},</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
            <span class="n">succ</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">{</span>
                <span class="k">end</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="mi">5</span><span class="o">&gt;</span><span class="p">{</span>
                    <span class="k">end</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
                    <span class="n">pred</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="p">},</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
                    <span class="n">succ</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="p">}</span>
                  <span class="p">},</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">3</span><span class="o">&gt;</span> <span class="p">},</span>
                <span class="n">start</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
                <span class="n">succ</span> <span class="o">=</span> <span class="p">{}</span>
              <span class="p">}</span> <span class="p">}</span>
          <span class="p">}</span> <span class="p">}</span>
      <span class="p">},</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">5</span><span class="o">&gt;</span> <span class="p">}</span>
  <span class="p">},</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">2</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">5</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="p">}</span>
</code></pre></div>
<p>ビジュアライザーも作ったんでよかったら見ていってください｡
<img src="/pictures/2016-12-11-duchain_cfg.png" alt="Control Flow Graph"></p>
<p>CFGそれ自体は本題でないので､説明はこの辺にとどめます｡</p>
<hr>
<p>さて､Reachable Definitionに話を戻します｡</p>
<p>まず､各ブロックについて<em>定義</em>と<em>使用</em>を取っていきます｡
各ブロックのメンバーに<code>gen</code>, <code>use</code>というリストを追加し､以下のようなtableを突っ込みます｡</p>
<div class="highlight"><pre><code class="language-moon" data-lang="moon"><span class="c1">-- for gen</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="ss">reg:</span><span class="w"> </span><span class="p">(</span><span class="err">レジスター</span><span class="p">)</span><span class="w">
    </span><span class="ss">line:</span><span class="w"> </span><span class="p">(</span><span class="err">行番号</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1">-- for use</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="ss">reg:</span><span class="w"> </span><span class="p">(</span><span class="err">レジスター</span><span class="p">)</span><span class="w">
    </span><span class="ss">line:</span><span class="w"> </span><span class="p">(</span><span class="err">行番号</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>例をまた引っ張ってきます｡</p>
<div class="highlight"><pre><code class="language-" data-lang="">-- block 1 to 2, 3
LOADK 0 0
LOADK 1 1
LOADK 1 2
EQ 0 0 1
-- block 2 to 4
JMP 0 2
-- block 3 to 5
LOADK 2 2
JMP 0 1
-- block 4 to 5
LOADK 2 3
-- block 5
RETURN 0 1

constant list: [3, 5, 7, 9]
</code></pre></div>
<p>これより<code>gen</code>と<code>use</code>を取っていくと､次のようになります( <sup id="fnref5" title="Enrique Garcíao. inspect.lua "><a href="#fn5" rel="footnote">5</a></sup>)による整形を一部改変)｡</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="k">end</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="c1">-- gen/use of block 1</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span><span class="n">line</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">},</span>
        <span class="p">{</span><span class="n">line</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">},</span>
        <span class="p">{</span><span class="n">line</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">geg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">}</span>
    <span class="p">},</span>
    <span class="n">use</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span><span class="n">line</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">},</span>
        <span class="p">{</span><span class="n">line</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">}</span>
    <span class="p">},</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">succ</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">{</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="k">end</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="c1">-- gen/use of block 2</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">use</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="p">},</span>
        <span class="n">succ</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">{</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
            <span class="k">end</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
            <span class="c1">-- gen/use of block 3</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="p">{</span>
                <span class="p">{</span><span class="n">line</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="n">use</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="p">},</span>
            <span class="n">succ</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">{</span>
                <span class="n">start</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
                <span class="k">end</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
                <span class="c1">-- gen/use of block 4</span>
                <span class="n">gen</span> <span class="o">=</span> <span class="p">{},</span>
                <span class="n">use</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="p">{</span><span class="n">line</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="mi">5</span><span class="o">&gt;</span><span class="p">{</span>
                    <span class="k">end</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
                    <span class="c1">-- gen/use of block 5</span>
                    <span class="n">gen</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="p">{</span><span class="n">line</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">}</span>
                    <span class="p">},</span>
                    <span class="n">use</span> <span class="o">=</span> <span class="p">{},</span>
                    <span class="n">pred</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="p">},</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
                    <span class="n">succ</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="p">}</span>
                  <span class="p">},</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">3</span><span class="o">&gt;</span> <span class="p">},</span>
                <span class="n">succ</span> <span class="o">=</span> <span class="p">{}</span>
              <span class="p">}</span> <span class="p">},</span>
          <span class="p">}</span> <span class="p">},</span>
      <span class="p">},</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">5</span><span class="o">&gt;</span> <span class="p">}</span>
  <span class="p">},</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">2</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">5</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="p">}</span>
</code></pre></div>
<p>これを踏まえ､Reachable Definitionの実装はこんな感じになる:</p>
<div class="highlight"><pre><code class="language-moon" data-lang="moon"><span class="n">modified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="kc">true</span><span class="p">}</span><span class="w">
</span><span class="k">while</span><span class="w"> </span><span class="n">foldl</span><span class="w"> </span><span class="p">((</span><span class="n">acc</span><span class="p">,</span><span class="w"> </span><span class="n">mod</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">mod</span><span class="p">),</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">modified</span><span class="w">
    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">#</span><span class="n">cfg</span><span class="w">
      </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">
        </span><span class="n">block</span><span class="p">.</span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foldl</span><span class="w"> </span><span class="p">((</span><span class="n">acc</span><span class="p">,</span><span class="w"> </span><span class="n">pred</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">union</span><span class="w"> </span><span class="n">acc</span><span class="p">,</span><span class="w"> </span><span class="n">pred</span><span class="p">.</span><span class="n">out</span><span class="p">),</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">pred</span><span class="w">
        </span><span class="n">block</span><span class="p">.</span><span class="n">kill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intersec</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">gen</span><span class="w">
        </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">out</span><span class="w">
        </span><span class="n">block</span><span class="p">.</span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">union</span><span class="w"> </span><span class="p">(</span><span class="n">latest</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">gen</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">diff</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">kill</span><span class="p">)</span><span class="w">
        </span><span class="nb">table.insert</span><span class="w"> </span><span class="n">modified</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">diff</span><span class="w"> </span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">out</span><span class="p">)</span><span class="w">
</span></code></pre></div>
<p>フ〜ム…解説します｡</p>
<ul>
<li>
<p><code>block.gen</code></p>

<p>CFGの要素のブロック<code>block</code>で新たに生成される定義の集合｡これはプログラムの代入文から明らか｡</p>
</li>
<li>
<p><code>block.in</code></p>

<p><code>block</code>の入り口に到達する定義の集合｡
後続ブロック<code>block.pred</code>の各要素<code>p</code>について<code>p.out</code>の和集合となる｡</p>
</li>
<li>
<p><code>block.kill</code></p>

<p><code>block</code>に到達したが､ブロック中で無効になる､つまりブロック中で新たな代入により不要になるものの集まり｡</p>

<p><code>block.in</code>と<code>block.gen</code>のintersectionを取ればいいわけだな｡</p>
</li>
<li>
<p><code>block.out</code></p>

<p>ブロックの出口に到達する定義の集合｡
(<code>block.in</code>と<code>block.kill</code>の差集合)と<code>block.gen</code>の和集合とすればいいか｡</p>

<p>ここで一つ､例えば変数<code>x</code>への代入が同一ブロック中に2回あったらちょっと困る｡</p>

<p>そこで､<em>最新の<code>x</code>への代入</em>(つまりブロック内で最後に実行される<code>x</code>への代入)のみに注目し､他は無視することで対処する (関数<code>latest()</code>)｡</p>
</li>
</ul>
<p>
</p>
<p>で､それを各ブロックの<code>block.out</code>の変更がなくなるまで繰り返しておりますわけですな｡</p>
<p>これでCFGにReachable Definitionをくっつけた感じになりました｡</p>
<h1 id="4-du-chain">4. DU Chainの構成</h1>
<p>さてここまでくれば後は簡単｡かも｡
今の所CFG'に定義の集合<code>block.def</code>が無く､<code>block.def</code>から使用をたどるといったギミックがありません｡
逆にこの2つを実装するとゴールです｡がんばります｡</p>
<div class="highlight"><pre><code class="language-moon" data-lang="moon"><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">#</span><span class="n">cfg</span><span class="w">
    </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">
    </span><span class="n">block</span><span class="p">.</span><span class="n">def</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">union</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">gen</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">in</span><span class="w">

    </span><span class="k">for</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">#</span><span class="n">block</span><span class="p">.</span><span class="n">use</span><span class="w">
        </span><span class="n">use</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">use</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="w">
        </span><span class="n">use</span><span class="p">.</span><span class="n">defined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w">

        </span><span class="k">if</span><span class="w"> </span><span class="n">defr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="n">latest</span><span class="w"> </span><span class="n">filter</span><span class="w"> </span><span class="p">((</span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">line</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">use</span><span class="p">.</span><span class="n">line</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">reg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">use</span><span class="p">.</span><span class="n">reg</span><span class="p">),</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">gen</span><span class="w">
            </span><span class="n">insert</span><span class="w"> </span><span class="n">use</span><span class="p">.</span><span class="n">defined</span><span class="p">,</span><span class="w"> </span><span class="n">defr</span><span class="w"> </span><span class="k">unless</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">use</span><span class="p">.</span><span class="n">defined</span><span class="p">,</span><span class="w"> </span><span class="n">defr</span><span class="w">

            </span><span class="k">unless</span><span class="w"> </span><span class="n">defr</span><span class="p">.</span><span class="n">used</span><span class="w">
                </span><span class="n">defr</span><span class="p">.</span><span class="n">used</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">use</span><span class="p">}</span><span class="w">
            </span><span class="k">else</span><span class="w">
                </span><span class="n">insert</span><span class="w"> </span><span class="n">defr</span><span class="p">.</span><span class="n">used</span><span class="p">,</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="k">unless</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">use</span><span class="p">.</span><span class="n">defined</span><span class="p">,</span><span class="w"> </span><span class="n">use</span><span class="w">
        </span><span class="k">else</span><span class="w">
            </span><span class="k">for</span><span class="w"> </span><span class="n">defr</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">filter</span><span class="w"> </span><span class="p">((</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">reg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">use</span><span class="p">.</span><span class="n">reg</span><span class="p">),</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">in</span><span class="p">)</span><span class="w">
                </span><span class="n">insert</span><span class="w"> </span><span class="n">use</span><span class="p">.</span><span class="n">defined</span><span class="p">,</span><span class="w"> </span><span class="n">defr</span><span class="w"> </span><span class="k">unless</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">use</span><span class="p">.</span><span class="n">defined</span><span class="p">,</span><span class="w"> </span><span class="n">defr</span><span class="w">

                </span><span class="k">unless</span><span class="w"> </span><span class="n">defr</span><span class="p">.</span><span class="n">used</span><span class="w">
                    </span><span class="n">defr</span><span class="p">.</span><span class="n">used</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">use</span><span class="p">}</span><span class="w">
                </span><span class="k">else</span><span class="w">
                    </span><span class="n">insert</span><span class="w"> </span><span class="n">defr</span><span class="p">.</span><span class="n">used</span><span class="p">,</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="k">unless</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">defr</span><span class="p">.</span><span class="n">used</span><span class="p">,</span><span class="w"> </span><span class="n">use</span><span class="w">
</span></code></pre></div>
<p>まず3行目で<code>block.def</code>を作ります｡Define-Useの<em>Define</em>です｡<code>block.egn</code>と<code>block.in</code>のunionというのは直感で分かると思います｡
さて､あとはこの<code>def</code>から<code>use</code>がわかればOKとなりました｡早い｡</p>
<p>中のイテレーションで<code>block.use</code>から定義をたどるギミックを作ります｡
イテレーションした各<code>block</code>の<code>use</code>のメンバーに<code>defined</code>を生やし､使用しているレジスターの定義を突っ込んでいきます｡</p>
<p>まず<code>block</code>内での定義を探します｡
ここで<code>block.def</code>から探さないのはなぜかというと､そうですね､<code>block</code>内(<em>直近</em>)での定義がもちろん最優先なので｡
<code>block</code>内のさらに直近を最優先するので<code>latest()</code>で<code>use</code>に最も近い定義を拾います｡かぶりがないように(<code>unless have ......</code>)<code>use.defined</code>に突っ込みます｡</p>
<p><code>block</code>内に定義が無い場合は<code>block.in</code>から定義全部引っ張ります｡</p>
<p><code>use.defined</code>を基に<code>def.used</code>を作ります｡これは簡単ですね｡
<code>use.defined</code>の各構成ステップで<code>use</code>自体を､<code>use</code>が引っ張ってくる<code>defr</code>の<code>defr.used</code>に突っ込めばいいわけですから｡ポインター最高!!!!! :p</p>
<p>あれ? 定義から使用も､使用から定義も参照できるようになってるな…</p>
<p>これで欲しかったものが手に入りました( <sup id="fnref5" title="Enrique Garcíao. inspect.lua "><a href="#fn5" rel="footnote">5</a></sup>)による整形)｡</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="p">{</span> <span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{</span>
    <span class="n">def</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">{</span>
        <span class="n">line</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">used</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">{</span>
            <span class="n">defined</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="p">},</span>
            <span class="n">line</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
            <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="p">},</span> <span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">{</span>
            <span class="n">defined</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="p">},</span>
            <span class="n">line</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
            <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="p">}</span> <span class="p">}</span>
      <span class="p">},</span> <span class="p">{</span>
        <span class="n">line</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">used</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="p">},</span> <span class="o">&lt;</span><span class="mi">5</span><span class="o">&gt;</span><span class="p">{</span>
        <span class="n">line</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">used</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="mi">6</span><span class="o">&gt;</span><span class="p">{</span>
            <span class="n">defined</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">5</span><span class="o">&gt;</span> <span class="p">},</span>
            <span class="n">line</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
            <span class="n">reg</span> <span class="o">=</span> <span class="mi">1</span>
          <span class="p">}</span> <span class="p">}</span>
      <span class="p">}</span> <span class="p">},</span>
    <span class="k">end</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">succ</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="mi">7</span><span class="o">&gt;</span><span class="p">{</span>
        <span class="n">def</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">2</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">5</span><span class="o">&gt;</span> <span class="p">},</span>
        <span class="k">end</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="p">},</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">succ</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span><span class="p">{</span>
            <span class="n">def</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="mi">9</span><span class="o">&gt;</span><span class="p">{</span>
                <span class="n">line</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
                <span class="n">reg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                <span class="n">used</span> <span class="o">=</span> <span class="p">{}</span>
              <span class="p">},</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">2</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">5</span><span class="o">&gt;</span> <span class="p">},</span>
            <span class="k">end</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">7</span><span class="o">&gt;</span> <span class="p">},</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
            <span class="n">succ</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="mi">10</span><span class="o">&gt;</span><span class="p">{</span>
                <span class="n">def</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="mi">11</span><span class="o">&gt;</span><span class="p">{</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
                    <span class="n">reg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">used</span> <span class="o">=</span> <span class="p">{}</span>
                  <span class="p">},</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">2</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">5</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">9</span><span class="o">&gt;</span> <span class="p">},</span>
                <span class="k">end</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="mi">12</span><span class="o">&gt;</span><span class="p">{</span>
                    <span class="n">def</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">11</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">2</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">5</span><span class="o">&gt;</span> <span class="p">},</span>
                    <span class="k">end</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
                    <span class="n">pred</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="p">},</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
                    <span class="n">succ</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">10</span><span class="o">&gt;</span> <span class="p">},</span>
                    <span class="n">use</span> <span class="o">=</span> <span class="p">{}</span>
                  <span class="p">},</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">8</span><span class="o">&gt;</span> <span class="p">},</span>
                <span class="n">start</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
                <span class="n">succ</span> <span class="o">=</span> <span class="p">{},</span>
                <span class="n">use</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="p">}</span>
              <span class="p">}</span> <span class="p">},</span>
            <span class="n">use</span> <span class="o">=</span> <span class="p">{}</span>
          <span class="p">}</span> <span class="p">},</span>
        <span class="n">use</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="p">},</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">12</span><span class="o">&gt;</span> <span class="p">},</span>
    <span class="n">use</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">6</span><span class="o">&gt;</span> <span class="p">}</span>
  <span class="p">},</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">7</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">12</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">8</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">table</span> <span class="mi">10</span><span class="o">&gt;</span> <span class="p">}</span>
</code></pre></div>
<h1 id="5">5. おわりに</h1>
<p>それでは皆さんもガンガン最適化をしていってください｡
ちなみに､現在鋭意製作中の最適化器を用いると､例は以下のように最適化されます｡</p>
<div class="highlight"><pre><code class="language-" data-lang="">JMP 0 0
RETURN 0 1
</code></pre></div>
<p>そうだね…｡</p>
<hr>
<p>『Vivid Strike!』8話までイッキ見しましたが面白いですね｡今季は他に何もアニメを観てない｡</p>
<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>Dibyendu Majumdar. <a href="https://github.com/dibyendumajumdar/ravi/blob/master/readthedocs/lua_bytecode_reference.rst">Lua 5.3 Bytecode Reference</a> <a href="#fnref1" rev="footnote">↩</a></p>
</li>

<li id="fn2">
<p>Kein-Hong Man. <a href="http://luaforge.net/docman/83/98/ANoFrillsIntroToLua51VMInstructions.pdf">A No-Frills Introduction to Lua 5.1 VM Instructions</a> <a href="#fnref2" rev="footnote">↩</a></p>
</li>

<li id="fn3">
<p>中田 育男, 佐々木 正孝, 滝本 宗宏, 渡邉 担. <a href="https://www.amazon.co.jp/%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9%E3%81%AE%E5%9F%BA%E7%9B%A4%E6%8A%80%E8%A1%93%E3%81%A8%E5%AE%9F%E8%B7%B5_%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9%E3%83%BB%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%83%81%E3%83%A3COINS%E3%82%92%E7%94%A8%E3%81%84%E3%81%A6-%E4%B8%AD%E7%94%B0-%E8%82%B2%E7%94%B7/dp/4254121733">コンパイラの基盤技術と実践―コンパイラ・インフラストラクチャCOINSを用いて</a> <a href="#fnref3" rev="footnote">↩</a></p>
</li>

<li id="fn4">
<p>Zdenek Dvorák, Jan Hubicka, Pavel Nejedlý, Josef Zlomek. <a href="http://www.ucw.cz/%7Ehubicka/papers/proj/node18.html#CFG">Control Flow Graph - Infrastructure for Profile Driven Optimizations in GCC Compiler</a> <a href="#fnref4" rev="footnote">↩</a></p>
</li>

<li id="fn5">
<p>Enrique Garcíao. <a href="https://github.com/kikito/inspect.lua">inspect.lua</a> <a href="#fnref5" rev="footnote">↩</a></p>
</li>

</ol>
</div>
          </div>
        </article>

      </div>
    </div>
    <footer>
      <div class="pagination btn-group" style="text-align: center; font-family: 'Comfortaa';">
        <a class="btn prev" href="/2016/11/18/%E8%AA%AD%E3%82%93%E3%81%A0.html" title="読書の秋､ファミレスのドリンクバーで粘る秋">&larr; Prev</a>
        &#47;<a class="btn" href="/">Top</a>&#47;
        <a class="btn next" href="/2016/12/13/%E3%81%94%E5%A0%B1%E5%91%8A.html" title="ご報告">Next &rarr;</a>
      </div>
    </footer>

  </body>
</html>
