<!DOCTYPE html>
<html>
  <head>
    <title>awesome WMでタイマー &#47; lilyum ensemble</title>
    <meta content="text/html;charset=UTF-8" http-equiv="content-type">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Satoru Kawahara">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="lilyum ensemble">
    <meta name="twitter:creator" content="Satoru Kawahara"> 
    <meta name="twitter:text:description" content="awesome WMでタイマー">
    <meta name="twitter:title" content="awesome WMでタイマー"> 
    <meta name="twitter:url" content="https://nymphium.github.io/2016/03/19/awesome_timer.html"> 
    <meta name="twitter:description" content="">
    <meta name="twitter:image:src" content="https://nymphium.github.io/pictures/github_icon.png">
    <meta name="description" content="">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="https://nymphium.github.io/2016/03/19/awesome_timer.html">
    <link rel="alternate" type="application/rss+xml" title="lilyum ensemble" href="https://nymphium.github.io/feed.xml">
    <link href="https://fonts.googleapis.com/css?family=Comfortaa:300%7CDroid+Sans+Mono%7CCrimson+Text:400,400i" rel="stylesheet">
  </head>

  <body>
    <header class="site-header">
      <div class="wrapper" style="font-family: 'Comfortaa';">
        <a class="site-title" href="/">lilyum ensemble</a>
        <nav class="site-nav">
          <div class="trigger">
            <a class="page-link" href="/aboutme.html">About</a>
            <a class="page-link" href="/slide.html">Slides</a>
            <a class="page-link" href="/tags.html">Tags</a>
          </div>
        </nav>
      </div>
    </header>

    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
          <header class="post-header">
            <h1 class="post-title" itemprop="name headline">awesome WMでタイマー</h1>
            <span class="post-meta">
              <time datetime="2016-03-19T00:00:00+09:00" itemprop="datePublished">Mar 19, 2016</time>
              <p>tag: &#123;<a href="/tags.html#awesome-ref">awesome</a>, <a href="/tags.html#Lua-ref">Lua</a>&#125;</p>
            </span>
            <script type="text/javascript" src="/js/GithubRepoWidget.min.js"></script>
            <script type="text/javascript">setTimeout(GithubRepoWidget.init, 3000);</script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" integrity="sha384-9tPv11A+glH/on/wEu99NVwDPwkMQESOocs/ZGXPoIiLE8MU/qkqUcZ3zzL+6DuH" crossorigin="anonymous">
            <!-- The loading of KaTeX is deferred to speed up page rendering -->
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.js" integrity="sha384-U8Vrjwb8fuHMt6ewaCy8uqeUXv4oitYACKdB0VziCerzt011iQ/0TqlSlv8MReCm" crossorigin="anonymous"></script>
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/contrib/auto-render.min.js" integrity="sha384-aGfk5kvhIq5x1x5YdvCp4upKZYnA8ckafviDpmWEKp4afOZEqOli7gqSnh8I6enH" crossorigin="anonymous"
                    onload="renderMathInElement(document.body);"></script>
          </header>
          <div class="post-content" itemprop="articleBody">
<p>こんにちは､びしょ〜じょです｡映画プリパラとミルキィホームズを観てきました｡連続で森脇ふでやすペアの作品は疲れますね｡</p>
<h1 id="1">1. はじめに</h1>
<p>世の中にはこんな便利なLuaモジュールがあります｡</p>
<div class="github-widget" data-repo="nymphium/luakatsu"></div>
<p>ところでawesomeというLuaで設定ファイルを記述できるウィンドウマネージャがあります｡ピンときましたね｡</p>
<p>そうですね､<em>お誕生日にメッセージが出る</em>とハッピーですね｡</p>
<h1 id="2-awesome-timer-api">2. awesome timer API</h1>
<p>awesomeには実はtimer APIというものがあったんですねぇ…｡</p>
<p><a href="https://awesomewm.org/doc/api/modules/timer.html#timer">awesome API Document: timer module</a></p>
<p>せっかくなのでちょっとみてみます｡ドキュメントは(個人的に)初見だと若干不親切だったので補足ッピよ｡</p>
<h2 id="table">table</h2>
<h3 id="timer">timer</h3>
<p><code>timer</code>はtableですが､オブジェクト指向のクラスだと思ってください｡
awesome実行時に_Gに展開されます｡
<code>{timeout = N}</code>というtableを渡すことでインスタンスを生成します｡
この<code>N</code>は､number型で､N秒ごとにこのインスタンスに登録されているイベントを､やっていく｡
また､読み取り専用でインスタンスには<code>started</code>というbool型のメンバ変数があり､インスタンスのタイマーが開始されているか(後述)がわかります｡</p>
<p>このtimreインスタンスにイベントを追加していくということです｡</p>
<h2 id="function">function</h2>
<h3 id="t-start">t:start()</h3>
<p>timerのインスタンスtを開始します｡これによりtのタイマーが起動し､<code>t.timeout</code>秒ごとにイベントを繰り出します｡
<code>T:f()</code>は<code>T.f(T)</code>の糖衣構文なのでもちろん<code>timer.start(t)</code>とすることもできます｡</p>
<p>このとき､<code>t.started</code>は<code>true</code>となります｡</p>
<h3 id="t-stop">t:stop()</h3>
<p>インスタンスtのタイマーを止めます｡</p>
<p>このとき､<code>t.started</code>は<code>false</code>となります｡</p>
<h3 id="t-again">t:again()</h3>
<p>止まっているtを再開します｡</p>
<h3 id="t-connect_signal-signame-func">t:connect_signal(signame, func)</h3>
<p>これがイベントの追加関数です｡<code>signame</code>にはstring型でsignal名を追加します｡
signal is 何な人はawesome のsignalを学んでほしい｡と言いたいところですが､timerは<code>"timeout"</code>signalを見るので､ここは<code>"timeout"</code>とでもしておいてください｡
<code>func</code>には関数を追加します｡この登録する関数は第1引数にtを取ります｡第2引数以降にブツをわたしたいときは､後述の<code>t:emmit_signal()</code>を使います｡</p>
<h3 id="t-disconnect_signal-signame-func">t:disconnect_signal(signame, func)</h3>
<p>イベントを削除します｡<code>signame</code>は上記と同じですね｡<code>"timeout"</code>としておいてください｡
<code>func</code>ですが､例えば<code>foo</code>という関数を登録した場合､<code>t:disconnect_signal("timeout", foo)</code>としないといかんのですな｡</p>
<p>ところでLuaでは各関数にidが振ってあります｡
<code>tostring(foo)</code>などしてみるとidが伺えます｡
これはtableも同じで､中身が同じでもidが異なると､<code>foo == bar</code>は<code>false</code>を返します｡</p>
<p>なにが言いたいかというと､<code>disconnect_signal()</code>の第2引数には登録した関数そのものを渡したいので
､イベントを削除したい場合は<code>connect_signal()</code>に無名関数を渡すのはまずく､適当な変数にバインドしてください｡</p>
<h3 id="t-emit_signal-signame">t:emit_signal(signame, …)</h3>
<p>インスタンスtの<code>signame</code> signalに登録されている関数すべてを適用します｡各関数の第1引数にはtが､それ以降には<code>...</code>が渡されます｡</p>
<h3 id="timer-instances">timer.instances()</h3>
<p>timer全体で登録されているイベントの数を返します｡インスタンス毎じゃないぞ､timer全体だぞ｡なので引数はいりません｡</p>
<h1 id="3">3. 実装</h1>
<p>まず考えよっか｡</p>
<hr>
<p>luakatsuの<code>find_birthday()</code>を使います｡<code>find_birthday(today)</code>でアイドル情報が帰ってきたらそれを出力します｡</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">idol</span> <span class="o">=</span> <span class="n">Aikatsu</span><span class="p">.</span><span class="n">find_birthday</span><span class="p">(</span><span class="nb">os.date</span><span class="p">(</span><span class="s2">"%m/%d"</span><span class="p">))</span>

<span class="k">if</span> <span class="n">idol</span> <span class="k">then</span>
    <span class="o">...</span>
<span class="k">end</span>
</code></pre></div>
<p>awesomeの通知モジュールというとnaughtyです｡これは<code>naughty.notify {title = ..., text = ...}</code>といった感じで､うん｡</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="n">naughty</span><span class="p">.</span><span class="n">notify</span> <span class="p">{</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s2">"notificatoin"</span><span class="p">,</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">"今日は"</span> <span class="o">..</span> <span class="n">idol</span><span class="p">.</span><span class="n">name</span> <span class="o">..</span> <span class="s2">"ちゃんの誕生日だよ!"</span>
<span class="p">}</span>
</code></pre></div>
<p>これを関数にして､例えば毎日0000､0600､1200､1800あたりに発火してみます｡
でもこのままだと起動時即<code>t:start()</code>するとよくわからない時間に通知が出ますね｡調節します｡</p>
<p>区切りのいい時間になったら通知タイマーを開始させるタイマーを作ってみます｡
パディング用のタイマーのtimeoutをうまくやります｡とりあえずベタな方法でいってみます｡</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">now</span> <span class="o">=</span> <span class="nb">os.date</span><span class="s2">"*t"</span>
<span class="kd">local</span> <span class="n">sec</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">hour</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">now</span><span class="p">.</span><span class="n">min</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">now</span><span class="p">.</span><span class="n">sec</span>

<span class="k">if</span> <span class="n">sec</span> <span class="o">&lt;</span> <span class="mi">21600</span> <span class="k">then</span>
    <span class="n">sec</span> <span class="o">=</span> <span class="mi">21600</span> <span class="o">-</span> <span class="n">sec</span>
<span class="k">elseif</span> <span class="n">sec</span> <span class="o">&lt;</span> <span class="mi">43200</span> <span class="k">then</span>
    <span class="n">sec</span> <span class="o">=</span> <span class="mi">43200</span> <span class="o">-</span> <span class="n">sec</span>
<span class="k">elseif</span> <span class="n">sec</span> <span class="o">&lt;</span> <span class="mi">64800</span> <span class="k">then</span>
    <span class="n">sec</span> <span class="o">=</span> <span class="mi">64800</span> <span class="o">-</span> <span class="n">sec</span>
<span class="k">elseif</span> <span class="n">sec</span> <span class="o">&lt;</span> <span class="mi">86400</span> <span class="k">then</span>
    <span class="n">sec</span> <span class="o">=</span> <span class="mi">86400</span> <span class="o">-</span> <span class="n">sec</span>
<span class="k">end</span>
</code></pre></div>
<p>次に行く前に通知タイマーを作ってしまおう｡</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">luakatsutime</span> <span class="o">=</span> <span class="n">timer</span> <span class="p">{</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">21600</span><span class="p">}</span> <span class="c1">-- every 6 hours</span>
<span class="n">luakatsutimer</span><span class="p">:</span><span class="n">connect_signal</span><span class="p">(</span><span class="s2">"timeout"</span><span class="p">,</span> <span class="n">celebrate_notify</span><span class="p">)</span>
</code></pre></div>
<p>登録する関数はこんな感じですか｡</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="k">function</span> <span class="nf">padding</span><span class="p">(</span><span class="n">timer</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">function</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">:</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">timer</span><span class="p">:</span><span class="n">start</span><span class="p">()</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Luaは外のブロックで定義された変数も見えるので特に必要はないですが高階関数にしてあります｡
実際に実行したいタイマー<code>timer</code>を引数にとり､期を待ちます｡
第一引数には登録したインスタンスが来るので､<code>self</code>で受けます｡で､中で<code>stop()</code> &amp; <code>start()</code>｡</p>
<p>この関数をパディング用タイマーに登録してさっきの泥臭い手法で計算した<code>sec</code>秒後に発火させておわり｡</p>
<h2 id="3-1">3-1. 全体</h2>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="k">do</span>
    <span class="nb">package.path</span> <span class="o">=</span> <span class="nb">package.path</span> <span class="o">..</span> <span class="n">LUAKATSU_PATH</span>
    <span class="kd">local</span> <span class="n">naughty</span> <span class="o">=</span> <span class="n">naughty</span> <span class="ow">or</span> <span class="nb">require</span><span class="s1">'naughty'</span>
    <span class="kd">local</span> <span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span> <span class="ow">or</span> <span class="nb">require</span><span class="s1">'timer'</span>
    <span class="nb">require</span><span class="s1">'luakatsu'</span>

    <span class="kd">local</span> <span class="n">tsig</span> <span class="o">=</span> <span class="s2">"timeout"</span>

    <span class="kd">local</span> <span class="k">function</span> <span class="nf">oiwai</span><span class="p">()</span>
        <span class="kd">local</span> <span class="n">today</span> <span class="o">=</span> <span class="nb">os.date</span> <span class="s2">"*t"</span>
        <span class="n">today</span><span class="p">.</span><span class="n">md</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"%02d/%02d"</span><span class="p">):</span><span class="n">format</span><span class="p">(</span><span class="n">today</span><span class="p">.</span><span class="n">month</span><span class="p">,</span> <span class="n">today</span><span class="p">.</span><span class="n">day</span><span class="p">)</span>

        <span class="kd">local</span> <span class="n">idol</span> <span class="o">=</span> <span class="n">Aikatsu</span><span class="p">.</span><span class="n">find_birthday</span><span class="p">(</span><span class="n">today</span><span class="p">.</span><span class="n">md</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">idol</span> <span class="k">then</span>
            <span class="n">naughty</span><span class="p">.</span><span class="n">notify</span> <span class="p">{</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">today</span><span class="p">.</span><span class="n">month</span> <span class="o">..</span> <span class="s2">"がつ"</span> <span class="o">..</span> <span class="n">today</span><span class="p">.</span><span class="n">day</span> <span class="o">..</span> <span class="s2">"にち"</span><span class="p">,</span>
                <span class="n">text</span> <span class="o">=</span>  <span class="s2">"今日は"</span> <span class="o">..</span> <span class="n">idol</span><span class="p">.</span><span class="n">name</span> <span class="o">..</span> <span class="s2">"ちゃんのお誕生日だよ!"</span><span class="p">,</span>
                <span class="n">height</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                <span class="n">whdth</span> <span class="o">=</span> <span class="mi">160</span><span class="p">,</span>
                <span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">fg</span> <span class="o">=</span> <span class="s2">"ff0000"</span><span class="p">,</span> <span class="c1">-- 黄色背景に赤文字でアイカツ感を出す</span>
                <span class="n">bg</span> <span class="o">=</span> <span class="s2">"ffff00"</span><span class="p">,</span>
                <span class="n">run</span> <span class="o">=</span> <span class="c1">-- notificatoinをクリックするとお祝いツイートができる</span>
                    <span class="k">function</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                        <span class="n">awful</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span>
                            <span class="s2">"xdg-open https://twitter.com/intent/tweet?text="</span>
                            <span class="o">..</span> <span class="p">(</span><span class="n">idol</span><span class="p">.</span><span class="n">name</span><span class="p">):</span><span class="n">gsub</span><span class="p">(</span><span class="s2">"%s"</span><span class="p">,</span> <span class="s2">"+"</span><span class="p">)</span>
                            <span class="o">..</span> <span class="s2">"ちゃん誕生日おめでとう!"</span>
                        <span class="p">)</span>
                        <span class="n">naughty</span><span class="p">.</span><span class="n">destroy</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="c1">-- そして消える</span>
                    <span class="k">end</span>
            <span class="p">}</span>
        <span class="k">end</span>
    <span class="k">end</span>

    <span class="kd">local</span> <span class="n">luakatsutimer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">{</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">21600</span><span class="p">}</span> <span class="c1">-- every 6 hours</span>
    <span class="n">luakatsutimer</span><span class="p">:</span><span class="n">connect_signal</span><span class="p">(</span><span class="n">tsig</span><span class="p">,</span> <span class="n">celebrate_notify</span><span class="p">)</span>

    <span class="kd">local</span> <span class="n">now</span> <span class="o">=</span> <span class="nb">os.date</span><span class="s2">"*t"</span>
    <span class="kd">local</span> <span class="n">sec</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">hour</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">now</span><span class="p">.</span><span class="n">min</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">now</span><span class="p">.</span><span class="n">sec</span>

    <span class="k">if</span> <span class="n">sec</span> <span class="o">&lt;</span> <span class="mi">21600</span> <span class="k">then</span>
        <span class="n">sec</span> <span class="o">=</span> <span class="mi">21600</span> <span class="o">-</span> <span class="n">sec</span>
    <span class="k">elseif</span> <span class="n">sec</span> <span class="o">&lt;</span> <span class="mi">43200</span> <span class="k">then</span>
        <span class="n">sec</span> <span class="o">=</span> <span class="mi">43200</span> <span class="o">-</span> <span class="n">sec</span>
    <span class="k">elseif</span> <span class="n">sec</span> <span class="o">&lt;</span> <span class="mi">64800</span> <span class="k">then</span>
        <span class="n">sec</span> <span class="o">=</span> <span class="mi">64800</span> <span class="o">-</span> <span class="n">sec</span>
    <span class="k">elseif</span> <span class="n">sec</span> <span class="o">&lt;</span> <span class="mi">86400</span> <span class="k">then</span>
        <span class="n">sec</span> <span class="o">=</span> <span class="mi">86400</span> <span class="o">-</span> <span class="n">sec</span>
    <span class="k">end</span>

    <span class="n">celebrate_notify</span><span class="p">()</span> <span class="c1">-- 起動時にも出したい</span>

    <span class="kd">local</span> <span class="k">function</span> <span class="nf">padding</span><span class="p">(</span><span class="n">timer</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">function</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
            <span class="n">self</span><span class="p">:</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">timer</span><span class="p">:</span><span class="n">start</span><span class="p">()</span>
        <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">paddingtimer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">{</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">sec</span><span class="p">}</span>
    <span class="n">paddingtimer</span><span class="p">:</span><span class="n">connect_signal</span><span class="p">(</span><span class="n">tsig</span><span class="p">,</span> <span class="n">padding</span><span class="p">(</span><span class="n">luakatsutimer</span><span class="p">))</span>
    <span class="n">paddingtimer</span><span class="p">:</span><span class="n">start</span><span class="p">()</span>
<span class="k">end</span>
</code></pre></div>
<p>実装の全体図です｡
awesome-clientなどで<code>error(pcakage.path)</code>などdirtyな方法で<code>package.path</code>をさっと確認してもらえればわかりますが､luakatsuなどがありそうなパスは読んでくれませんね｡
ということで､<code>package.path</code>にパスを追加します｡設定ファイル内の名前空間を汚したくないので､<code>do ... end</code>でくくっています｡</p>
<h1 id="4-demo">4. demo</h1>
<div class="enclosed-tweet" align="center">
<blockquote class="twitter-tweet">
<p lang="ja" dir="ltr">awesomeでやっとちゃんとした定刻での自動通知ができた｡ <a href="https://t.co/AIxhOJrmJb">pic.twitter.com/AIxhOJrmJb</a></p>— びしょ〜じょ (@Nymphium) <a href="https://twitter.com/Nymphium/status/711097741535895552?ref_src=twsrc%5Etfw">March 19, 2016</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
<p>今日は3/19で､あいにくアイカツキャラで誕生日の人はいませんでした｡が､アイマスなら人間が多いので今日もだれか誕生日だろうという予想がずばりあたり､後略</p>
<h1 id="5">5. おわりに</h1>
<p>awesomeは実はまだまだ機能が豊富なんですよねぇ〜使ってない機能は多々あるのでガンガン発掘していきたい｡
awesomeは今年に入ってから3.5.6→3.5.9と開発がぐんぐん進んでいるので注目していきたい｡</p>
<p>おわりだよー(○・▽・○)</p>
<hr>
<p>明日はアイカツのあれのライブですが､自由席で整理番号がなんと41番だったのでやっぱり日頃の行いがな〜最高〜〜</p>
          </div>
        </article>

      </div>
    </div>
    <footer>
      <div class="pagination btn-group" style="text-align: center; font-family: 'Comfortaa';">
        <a class="btn prev" href="/2016/02/29/llix_typeanotation.html" title="自作Lua処理系に型注釈をつけた(嘘)">&larr; Prev</a>
        &#47;<a class="btn" href="/">Top</a>&#47;
        <a class="btn next" href="/2016/04/23/lilycle.html" title="りりくるRSは最高">Next &rarr;</a>
      </div>
    </footer>

  </body>
</html>
