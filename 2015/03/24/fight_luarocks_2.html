<!DOCTYPE html>
<html>
  <head>
    <title>LuaRocksとの戦い2 &#47; lilyum ensemble</title>
    <meta content="text/html;charset=UTF-8" http-equiv="content-type">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="lilyum ensemble">
    <meta name="twitter:creator" content="Satoru Kawahara"> 
    <meta name="twitter:title" content="LuaRocksとの戦い2 - lilyum ensemble"> 
    <meta name="twitter:url" content="https://nymphium.github.io/2015/03/24/fight_luarocks_2.html"> 
    <meta name="twitter:text:description" content="こんにちは､びしょ〜じょです｡クズ極まって奨学金が廃止になりましたが､とりあえず学籍は保持されました｡">
    <meta name="twitter:image:src" content="https://nymphium.github.io/pictures/github_icon.png">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="alternate" type="application/rss+xml" title="lilyum ensemble" href="https://nymphium.github.io/feed.xml">
    <link href="https://fonts.googleapis.com/css?family=Comfortaa:300%7CDroid+Sans+Mono%7CCrimson+Text:400,400i" rel="stylesheet">
    <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>LuaRocksとの戦い2 | lilyum ensemble</title>
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="LuaRocksとの戦い2" />
<meta name="author" content="Satoru Kawahara" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="こんにちは､びしょ〜じょです｡クズ極まって奨学金が廃止になりましたが､とりあえず学籍は保持されました｡" />
<meta property="og:description" content="こんにちは､びしょ〜じょです｡クズ極まって奨学金が廃止になりましたが､とりあえず学籍は保持されました｡" />
<link rel="canonical" href="https://nymphium.github.io/2015/03/24/fight_luarocks_2.html" />
<meta property="og:url" content="https://nymphium.github.io/2015/03/24/fight_luarocks_2.html" />
<meta property="og:site_name" content="lilyum ensemble" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-03-24T00:00:00+09:00" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://nymphium.github.io/2015/03/24/fight_luarocks_2.html"},"description":"こんにちは､びしょ〜じょです｡クズ極まって奨学金が廃止になりましたが､とりあえず学籍は保持されました｡","@type":"BlogPosting","url":"https://nymphium.github.io/2015/03/24/fight_luarocks_2.html","headline":"LuaRocksとの戦い2","dateModified":"2015-03-24T00:00:00+09:00","datePublished":"2015-03-24T00:00:00+09:00","author":{"@type":"Person","name":"Satoru Kawahara"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="keywords" content="Lua,LuaRocks">
  </head>

  <body>
    <header class="site-header">
      <div class="wrapper" style="font-family: 'Comfortaa';">
        <a class="site-title" href="/">lilyum ensemble</a>
        <nav class="site-nav">
          <div class="trigger">
            <a class="page-link" href="/aboutme.html">About</a>
            <a class="page-link" href="/slide.html">Slides</a>
            <a class="page-link" href="/tags.html">Tags</a>
          </div>
        </nav>
      </div>
    </header>

    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
          <header class="post-header">
            <h1 class="post-title" itemprop="name headline">LuaRocksとの戦い2</h1>
            <span class="post-meta">
              <time datetime="2015-03-24T00:00:00+09:00" itemprop="datePublished">Mar 24, 2015</time>
              <p>tag: &#123;<a href="/tags.html#Lua-ref">Lua</a>, <a href="/tags.html#LuaRocks-ref">LuaRocks</a>&#125;</p>
            </span>
            <script type="text/javascript" src="/js/GithubRepoWidget.min.js"></script>
            <script type="text/javascript">setTimeout(GithubRepoWidget.init, 3000);</script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" integrity="sha384-9tPv11A+glH/on/wEu99NVwDPwkMQESOocs/ZGXPoIiLE8MU/qkqUcZ3zzL+6DuH" crossorigin="anonymous">
            <!-- The loading of KaTeX is deferred to speed up page rendering -->
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.js" integrity="sha384-U8Vrjwb8fuHMt6ewaCy8uqeUXv4oitYACKdB0VziCerzt011iQ/0TqlSlv8MReCm" crossorigin="anonymous"></script>
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/contrib/auto-render.min.js" integrity="sha384-aGfk5kvhIq5x1x5YdvCp4upKZYnA8ckafviDpmWEKp4afOZEqOli7gqSnh8I6enH" crossorigin="anonymous"
                    onload="renderMathInElement(document.body);"></script>
          </header>
          <div class="post-content" itemprop="articleBody">
<p>こんにちは､びしょ〜じょです｡クズ極まって奨学金が廃止になりましたが､とりあえず学籍は保持されました｡</p>
<p>さて本題</p>
<hr>
<p>戦い1は<a href="http://nymphium.hateblo.jp/entry/2015/02/01/153037">こちら</a>｡</p>
<p><a href="https://github.com/Nymphium/luakatsu">これ</a>をウッピデートしていたら色々問題が見えてきた｡いや､問題か…?</p>
<hr>
<h3 id="luarocks">luarocksがショボい</h3>
<p>ぶっちゃけluarocksコマンドがショボい｡write_rockspecオプションでrockspecファイルを作るわけだが､source.urlはrockspecファイルを自力で編集する必要がある｡そのくらいオプションに追加してくれよ｡</p>
<p>そしてdescription.detailedも､detailedオプションの記述よりもREADME.mdのよく分からない部分を優先してしまうなど色々残念感が多い｡</p>
<p>というわけでひどく簡易的だがluarocks/write_rockspec.luaを一部書き換えた｡</p>
<div class="highlight"><pre><code class="language-diff" data-lang="diff">89c89
&lt;          rockspec.description.detailed = paragraph
---
&gt;          -- rockspec.description.detailed = paragraph
95c95
&lt;          rockspec.description.detailed = paragraph
---
&gt;          -- rockspec.description.detailed = paragraph
222c222
&lt; 
---
&gt;    
258c258,259
&lt;          url = "*** please add URL for source tarball, zip or repository here ***",
---
&gt;          url = flags["url"],
</code></pre></div>
<p>何もしないとdetailedはREADMEの一部を適当に引っ張ってくる｡これはwrite_rockspec.luaのdetect_description関数を見ていただければわかる｡</p>
<p>で､luarocksコマンドはLuaで記述されており､どうやらwrite_rockspecオプションでは以後に続く<code>--hoge=huga</code>の形式のサブオプションを<code>flags["hoge"] = "huga"</code>のようにflagsというtableに突っ込んでいるようだ｡</p>
<p>というわけでsource.urlもオプションで記述できるように<code>flags["url"]</code>を用いた｡</p>
<p>これでとりあえずはrockspecを触ることも少なくなることを祈るしか無い｡</p>
<hr>
<h4 id="3-25">追記 3/25</h4>
<p>教えてもらいました｡</p>
<div class="enclosed-tweet" align="center">
<blockquote class="twitter-tweet">
<p lang="en" dir="ltr">@Nymphium Oh, you’re right! The priority is inverted there. I’ll fix this!</p>— Hisham (@hisham_hm) <a href="https://twitter.com/hisham_hm/status/580435538357944321?ref_src=twsrc%5Etfw">March 24, 2015</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
<div class="enclosed-tweet" align="center">
<blockquote class="twitter-tweet">
<p lang="en" dir="ltr">@Nymphium it gets the URL from the last parameter:<br><br>luarocks write_rockspec bla 1.0-1 <a href="http://t.co/mBRo5RtgcK">http://t.co/mBRo5RtgcK</a></p>— Hisham (@hisham_hm) <a href="https://twitter.com/hisham_hm/status/580436720354750464?ref_src=twsrc%5Etfw">March 24, 2015</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
<p>“–detailed"がREADMEを優先するのはバグだが､source.urlに関してはやはりボクが悪いですね｡</p>
<p>追記終わり｡</p>
<hr>
<h3 id="tag">tagについて</h3>
<p>無事にluakatsuもv1.3になったということで､<a href="https://rocks.moonscript.org/" title="LuaRocks">LuaRocks</a>にrockspecを登録し､無事にインストールできるか試してみた</p>
<p><em>…が､ダメ…っ!!</em></p>
<p>これはボクが完全に悪く､バージョンはGitでtagを付けて分けており､<a href="https://github.com/keplerproject/luarocks/wiki/Documentation">LuaRocksnのDocumentation</a>を読むと､soure.urlが"git://"から始まっていると､source.tagやsource.branchから､文字通りtagやbranchを指定することができるようだ｡</p>
<p>逆に､指定しないとmaster branchなどから引っ張ってくるようで､そのせいでインストールがうまく行かなかった｡</p>
<p>ということで､write_rockspecオプションのサブオプションに<code>--tag=TAG</code>を付けることで解決｡</p>
<p>Documentationは読もう(アイカツ格言)｡</p>
<hr>
<h2 id="part-e19bde596a988dee">全く関係ないその他</h2>
<p>アイカツ2015年第3段､もう弾が切れそうなのでスミレちゃんのレアドレスが揃いそうにない｡
第4段のPVが公式から上がっており､ニューカマーの二人には期待が募るばかりである｡</p>
          </div>
        </article>

      </div>
    </div>
    <footer>
      <div class="pagination btn-group" style="text-align: center; font-family: 'Comfortaa';">
        <a class="btn prev" href="/2015/03/15/ikou.html" title="3/15は星宮いちごちゃんの誕生日､はてブからの移住">&larr; Prev</a>
        &#47;<a class="btn" href="/">Top</a>&#47;
        <a class="btn next" href="/2015/05/10/apriled.html" title="Apriled">Next &rarr;</a>
      </div>
    </footer>

  </body>
</html>
