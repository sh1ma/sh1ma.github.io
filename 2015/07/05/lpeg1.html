<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html;charset=UTF-8" http-equiv="content-type"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="format-detection" content="telephone=no"/>

    <title>LPegの使い方 patternその1 - lilyum ensemble</title>
    <meta itemprop="name" content="LPegの使い方 patternその1 - lilyum ensemble"/>
    <meta name="keywords" content="Lua,MoonScript"/>
    <meta name="thumbnail" content="https://nymphium.github.io/pictures/github_icon.png"/>
    <meta itemprop="image" content="https://nymphium.github.io/pictures/github_icon.png"/>

    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:site" content="lilyum ensemble"/>
    <meta name="twitter:title" content="LPegの使い方 patternその1 - lilyum ensemble"/>
    <meta name="twitter:url" content="https://nymphium.github.io/2015/07/05/lpeg1.html"/> 
    <meta name="twitter:text:description" content="こんにちは､びしょ〜じょです｡無事『FLOWERS』夏篇を終わったことにより脳内が百合まみれっちゅ〜わけ｡春篇もさることながら､とんでもない百合でしたね｡八重垣さんと孝崎さん人間的に不器用すぎる..."/>
    <meta name="twitter:image:src" content="https://nymphium.github.io/pictures/github_icon.png"/>

    <link rel="icon" type="image/x-icon" href="/favicon.ico"/>
    <link rel="stylesheet" href="/css/main.css"/>
    <link rel="alternate" type="application/rss+xml" title="lilyum ensemble" href="https://nymphium.github.io/feed.xml"/>
    <link href="https://fonts.googleapis.com/css?family=Comfortaa:300%7CDroid+Sans+Mono%7CCrimson+Text:400,400i" rel="stylesheet"/>
<!-- Begin Jekyll SEO tag v2.5.0 -->
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="LPegの使い方 patternその1" />
<meta name="author" content="Satoru Kawahara" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="こんにちは､びしょ〜じょです｡無事『FLOWERS』夏篇を終わったことにより脳内が百合まみれっちゅ〜わけ｡" />
<meta property="og:description" content="こんにちは､びしょ〜じょです｡無事『FLOWERS』夏篇を終わったことにより脳内が百合まみれっちゅ〜わけ｡" />
<link rel="canonical" href="https://nymphium.github.io/2015/07/05/lpeg1.html" />
<meta property="og:url" content="https://nymphium.github.io/2015/07/05/lpeg1.html" />
<meta property="og:site_name" content="lilyum ensemble" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-07-05T00:00:00+09:00" />
<script type="application/ld+json">
{"description":"こんにちは､びしょ〜じょです｡無事『FLOWERS』夏篇を終わったことにより脳内が百合まみれっちゅ〜わけ｡","@type":"BlogPosting","headline":"LPegの使い方 patternその1","dateModified":"2015-07-05T00:00:00+09:00","url":"https://nymphium.github.io/2015/07/05/lpeg1.html","datePublished":"2015-07-05T00:00:00+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://nymphium.github.io/2015/07/05/lpeg1.html"},"author":{"@type":"Person","name":"Satoru Kawahara"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta property="og:image" content="https://nymphium.github.io/pictures/github_icon.png"/>
  </head>

  <body>
    <header class="site-header">
      <div class="wrapper" style="font-family: 'Comfortaa';">
        <a class="site-title" href="/">lilyum ensemble</a>
        <nav class="site-nav">
          <div class="trigger">
            <a class="page-link" href="/aboutme.html">About</a>
            <a class="page-link" href="/slide.html">Slides</a>
            <a class="page-link" href="/tags.html">Tags</a>
          </div>
        </nav>
      </div>
    </header>

    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
          <header class="post-header">
            <h1 class="post-title" itemprop="name headline">LPegの使い方 patternその1</h1>
            <span class="post-meta">
              <time datetime="2015-07-05T00:00:00+09:00" itemprop="datePublished">Jul 5, 2015</time>
              <p class="tags">tag: {<a href="/tags.html#Lua-ref">Lua</a>, <a href="/tags.html#MoonScript-ref">MoonScript</a>}</p>
              <a class="twitter-share-button" href="https://twitter.com/intent/tweet" target="_blank" rel="noopener noreferrer">Tweet</a>
            </span>
            <script type="text/javascript" src="/js/GithubRepoWidget.min.js"></script>
            <script type="text/javascript">setTimeout(GithubRepoWidget.init, 3000);</script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" integrity="sha384-9tPv11A+glH/on/wEu99NVwDPwkMQESOocs/ZGXPoIiLE8MU/qkqUcZ3zzL+6DuH" crossorigin="anonymous">
            <!-- The loading of KaTeX is deferred to speed up page rendering -->
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.js" integrity="sha384-U8Vrjwb8fuHMt6ewaCy8uqeUXv4oitYACKdB0VziCerzt011iQ/0TqlSlv8MReCm" crossorigin="anonymous"></script>
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/contrib/auto-render.min.js" integrity="sha384-aGfk5kvhIq5x1x5YdvCp4upKZYnA8ckafviDpmWEKp4afOZEqOli7gqSnh8I6enH" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
          </header>
          <div class="post-content" itemprop="articleBody">
<p>こんにちは､びしょ〜じょです｡無事『FLOWERS』夏篇を終わったことにより脳内が百合まみれっちゅ〜わけ｡</p>
<p>春篇もさることながら､とんでもない百合でしたね｡八重垣さんと孝崎さん人間的に不器用すぎる｡
しかしそれ故に互いを認め合った時の､アレよ､最高｡後半の八重垣さんに対し積極的になった孝崎さん可愛すぎるし弱ってたり素直だったりする八重垣さんも可愛いしもうやばいでしょ｡</p>
<p>キャストも前作からのあやねると洲崎綾で､最っ高やな…｡『chaleur』もいいし洲崎さんも歌うんだよな､いい…｡</p>
<p>本当に最高でした､秋篇も非常に楽しみです｡カラノショージョ3もあるしイノグレさまさまって感じ｡</p>
<p>追伸 なんか今回沙沙貴姉妹以前より増してすごく可愛くなかったですか｡ハグしてくれのところとか親友のところとか｡</p>
<hr>
<h1 id="LPeg%E3%81%A8%E3%81%AF"><a class="headerlink" href="#LPeg%E3%81%A8%E3%81%AF">LPegとは</a></h1>
<p></p>
<center>
<img src="/pictures/2015-07-05-lpeg_logo.gif" alt="LPeg">

<p><a href="http://www.inf.puc-rio.br/%7Eroberto/lpeg/" target="_blank" rel="noopener noreferrer">http://www.inf.puc-rio.br/~roberto/lpeg/</a></p>
</center>
<p>全く関係ないこというけど有名なLuaモジュールの一部のロゴってこんな感じでちんまりしてるよね｡LuaTeXのロゴとかもアレだし｡はい｡</p>
<p>PEGのLua版｡PEGは文脈自由文法の知り合いで曖昧性がない｡詳しくは調べてください｡</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># LuaRocksにあるので簡単インストール</span>
luarocks <span class="nt">--local</span> <span class="nb">install </span>lpeg
</code></pre></div>
<p>Luaの(サブセットの)処理系をMoonScriptで書くことになったので､本稿は使い方の備忘録となる｡</p>
<p>まずpatternで文法を作る(らしい)(詳しく知らない)｡</p>
<h1 id="Pattern"><a class="headerlink" href="#Pattern">Pattern</a></h1>
<p>MoonScript + LPeg的には<code>import P, S, R, V, C from require "lpeg"</code>等とするのがいいが､説明のため<code>lpeg = require "lpeg"</code>ってな感じに｡</p>
<h2 id="lpeg.P%28val%29"><a class="headerlink" href="#lpeg.P%28val%29">lpeg.P(val)</a></h2>
<p>なかなかトリッキーな関数｡</p>
<ul>
<li>
<p><code>type(val) == "string"</code></p>

<p>pattern <code>^val</code>を返す｡</p>
</li>
<li>
<p><code>type(val) == "table"</code></p>

<p>PEGを表現できる｡渡されたPEGに基づくpatternを返す｡</p>
</li>
</ul>
<p>他にも渡された型によっていろいろできる｡<a href="http://www.inf.puc-rio.br/%7Eroberto/lpeg/#op-p" target="_blank" rel="noopener noreferrer">公式</a>をご覧ください(丸投げ)｡</p>
<h2 id="lpeg.R%28range%29"><a class="headerlink" href="#lpeg.R%28range%29">lpeg.R(range)</a></h2>
<p>正規表現的にいうと〜<code>lpeg.R "09"</code>は[0-9]とか<code>lpeg.R "az"</code>は[a-z]みたいな感じのpatternを返す｡</p>
<h2 id="lpeg.S%28str%29"><a class="headerlink" href="#lpeg.S%28str%29">lpeg.S(str)</a></h2>
<p>正規表現的にいうと<code>lpeg.S "+-/*%"</code>で[+-/*%]みたいな感じのpatternを返す｡正規表現を見ると前項の<code>lpeg.R</code>とで少々の混乱が生まれた｡</p>
<h2 id="lpeg.V%28v%29"><a class="headerlink" href="#lpeg.V%28v%29">lpeg.V(v)</a></h2>
<p>文法を定義するとき､非終端記号を示すのに使われる｡</p>
<h1 id="%E6%BC%94%E7%AE%97%E5%AD%90"><a class="headerlink" href="#%E6%BC%94%E7%AE%97%E5%AD%90">演算子</a></h1>
<p>文法について触れる前にpattern同士の演算子をよォ…｡</p>
<h2 id="pat+%2A+pat"><a class="headerlink" href="#pat+%2A+pat">pat * pat</a></h2>
<p>連接を表す｡PEGだと\(S\cdot{}E\)または\(SE\)みたいな感じになる｡<code>S * E</code></p>
<h2 id="pat+%2B+pat"><a class="headerlink" href="#pat+%2B+pat">pat + pat</a></h2>
<p>和集合｡ PEGだと\(S/E\)となる｡ここでひとまずPEGの説明をすると､この\(/\)は文脈自由文法でいうところの\(|\)に似ているが､異なる点は\(S\)に失敗すると\(E\)に適合するか調べ､\(S\)<em>には戻らない</em>ところ｡これがPEGの曖昧さを破壊している｡</p>
<h2 id="pat%5En"><a class="headerlink" href="#pat%5En">pat^n</a></h2>
<p>patをn回以上繰り返す｡nが負の数だと最小マッチになる｡<code>n == -1</code>のときはPEGの\(pat?\)(省略可能)になる｡</p>
<h2 id="%28pat%29"><a class="headerlink" href="#%28pat%29">(pat)</a></h2>
<p>いつものグルーピング｡</p>
<h1 id="Grammer"><a class="headerlink" href="#Grammer">Grammer</a></h1>
<p><code>lpeg.P</code>にtableを渡すことでPEGを定義できる｡四則演算はこんな感じかしら｡</p>
<div class="highlight"><pre><code class="language-MoonScript" data-lang="MoonScript">space = lpeg.S' \t\n'
grammer = lpeg.P{
    'Term'
    Term: lpeg.V'Fact' * (space^0 * lpeg.S'+-' * space^0 * lpeg.V'Fact')^0
    Fact: lpeg.V'Prm' * (space^0 * lpeg.S'*/%' * space^0 * lpeg.V'Prm')^0
    Prm: lpeg.S'(' * space^0 * lpeg.V'Term' * space^0 * lpeg.S')' + lpeg.R'09'
}
</code></pre></div>
<p>PEG的にはこうなる｡</p>
<div>
$$
\begin{array}{l}
Term\leftarrow{}Fact\cdot(Space^*\cdot(‘+’/‘-’)\cdot{}Space^*\cdot{}Fact)^*\\
Fact\leftarrow{}Prm\cdot{}(Space^*\cdot{}(‘*’/‘/’/‘\%’)\cdot{}Prm)^*\\
Prm\leftarrow{}‘(’\cdot{}Term^*\cdot{}Space^*{‘)’}/[0-9]^+
\end{array}
$$
</div>
<p>渡すtableの1番目には開始記号を明示していする｡</p>
<h1 id="Tips"><a class="headerlink" href="#Tips">Tips</a></h1>
<p>MoonScriptでLPegを使う際､想いがMoonScript処理系に伝わらないことがある｡例えば\([0-9][a-z][A-Z]\)というものを書きたい時､</p>
<div class="highlight"><pre><code class="language-MoonScript" data-lang="MoonScript">-- MoonScript
R '09' * R 'az' * R 'AZ'
</code></pre></div>
<p>とすると､Luaに落ちる時､曲解される｡</p>
<div class="highlight"><pre><code class="language-Lua" data-lang="Lua">-- Lua
R('09' * R('az' * R('AZ')))
</code></pre></div>
<p>フニ〜</p>
<div class="highlight"><pre><code class="language-MoonScript" data-lang="MoonScript">-- MoonScript
R'09' * R'az' * R'AZ'
</code></pre></div>
<p>といった具合に<em>関数と引数の間にスペースを入れない</em>ことで</p>
<div class="highlight"><pre><code class="language-Lua" data-lang="Lua">-- Lua
R('09') * R('az') * R('AZ')
</code></pre></div>
<p>落ちたな(確信)｡</p>
<hr>
<p>Luaの純度を高めるため､<a href="https://github.com/pygy/LuLPeg" target="_blank" rel="noopener noreferrer">LuLPeg</a>を使おうと考えている｡見たところLPeg v0.12と同じ動きをちゃんとしてくれているようだ｡</p>
<p>その1があるからってその2があるとか､そういう考えは捨てて欲しい｡でも『FLOWERS』秋篇は5000%あるので､ある｡</p>
          </div>
        </article>

      </div>
    </div>
    <footer>
      <div class="pagination btn-group" style="text-align: center; font-family: 'Comfortaa';">
        <a class="btn prev" href="/2015/06/29/staranis_live.html" title="STAR☆ANIS アイカツ！スペシャルLIVE TOUR 2015 SHINING STAR*">← Prev</a>
        /<a class="btn" href="/">Top</a>/
        <a class="btn next" href="/2015/07/11/x1_carbon.html" title="X1 Carbon 2015にArchをインストールした後におこなう儀式">Next →</a>
      </div>
    </footer>

  </body>
</html>
