<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html;charset=UTF-8" http-equiv="content-type"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="format-detection" content="telephone=no"/>

    <title>日刊Promise(4) 継続モナドで明日への布石 - lilyum ensemble</title>
    <meta itemprop="name" content="日刊Promise(4) 継続モナドで明日への布石 - lilyum ensemble"/>
    <meta name="keywords" content="日刊Promise"/>
    <meta name="thumbnail" content="/pictures/2020/05/08/nikkan-promise4/thumb.png"/>
    <meta itemprop="image" content="/pictures/2020/05/08/nikkan-promise4/thumb.png"/>

    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:site" content="lilyum ensemble"/>
    <meta name="twitter:title" content="日刊Promise(4) 継続モナドで明日への布石 - lilyum ensemble"/>
    <meta name="twitter:url" content="/2020/05/08/nikkan-promise4.html"/> 
    <meta name="twitter:text:description" content="1. はじめにこんにちは､びしょ〜じょです｡前回はPromiseの実装に失敗していることが明らかになりました｡そこで今回は､Promiseの実装に必要となる継続モナドの導入をします｡2. 継続?..."/>
    <meta name="twitter:image" content="https://nymphium.github.io/pictures/2020/05/08/nikkan-promise4/thumb.png"/>
    <meta name="twitter:image:src" content="https://nymphium.github.io/pictures/2020/05/08/nikkan-promise4/thumb.png"/>

    <link rel="icon" type="image/x-icon" href="/favicon.ico"/>
    <link rel="stylesheet" href="/css/main.css"/>
    <link rel="alternate" type="application/rss+xml" title="lilyum ensemble" href="/feed.xml"/>
    <link href="https://fonts.googleapis.com/css?family=Comfortaa:300%7CDroid+Sans+Mono%7CCrimson+Text:400,400i" rel="stylesheet"/>
<!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="日刊Promise(4) 継続モナドで明日への布石" />
<meta name="author" content="Satoru Kawahara" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="lily, Aikatsu, Programming language, and more" />
<meta property="og:description" content="lily, Aikatsu, Programming language, and more" />
<link rel="canonical" href="https://nymphium.github.io/2020/05/08/nikkan-promise4.html" />
<meta property="og:url" content="https://nymphium.github.io/2020/05/08/nikkan-promise4.html" />
<meta property="og:site_name" content="lilyum ensemble" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-08T00:00:00+09:00" />
<script type="application/ld+json">
{"description":"lily, Aikatsu, Programming language, and more","url":"https://nymphium.github.io/2020/05/08/nikkan-promise4.html","headline":"日刊Promise(4) 継続モナドで明日への布石","dateModified":"2020-05-08T00:00:00+09:00","datePublished":"2020-05-08T00:00:00+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://nymphium.github.io/2020/05/08/nikkan-promise4.html"},"@type":"BlogPosting","author":{"@type":"Person","name":"Satoru Kawahara"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta property="og:image" content="/pictures/2020/05/08/nikkan-promise4/thumb.png"/>
  </head>

  <body>
    <header class="site-header">
      <div class="wrapper" style="font-family: 'Comfortaa';">
        <a class="site-title" href="/">lilyum ensemble</a>
        <nav class="site-nav">
          <div class="trigger">
            <a class="page-link" href="/aboutme.html">About</a>
            <a class="page-link" href="/slide.html">Slides</a>
            <a class="page-link" href="/tags.html">Tags</a>
          </div>
        </nav>
      </div>
    </header>

    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
          <header class="post-header">
            <h1 class="post-title" itemprop="name headline">日刊Promise(4) 継続モナドで明日への布石</h1>
            <span class="post-meta">
              <time datetime="2020-05-08T00:00:00+09:00" itemprop="datePublished">May 8, 2020</time>
              <a class="src" href="https://github.com/nymphium/nymphium.github.io/blob/source/_posts%2F2020-05-08-nikkan-promise4.md" target="_blank" rel="noopener noreferrer">src</a>
              <p class="tags">tag: {<span class="tag"><a href="/tags.html#%E6%97%A5%E5%88%8APromise-ref">日刊Promise</a></span>}</p>
              <a class="twitter-share-button" href="https://twitter.com/intent/tweet" target="_blank" rel="noopener noreferrer">Tweet</a> 
            </span>
            <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
            <script type="text/javascript" src="/js/GithubRepoWidget.min.js"></script>
            <script type="text/javascript">setTimeout(GithubRepoWidget.init, 3000);</script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" integrity="sha384-9tPv11A+glH/on/wEu99NVwDPwkMQESOocs/ZGXPoIiLE8MU/qkqUcZ3zzL+6DuH" crossorigin="anonymous">
            <!-- The loading of KaTeX is deferred to speed up page rendering -->
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.js" integrity="sha384-U8Vrjwb8fuHMt6ewaCy8uqeUXv4oitYACKdB0VziCerzt011iQ/0TqlSlv8MReCm" crossorigin="anonymous"></script>
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/contrib/auto-render.min.js" integrity="sha384-aGfk5kvhIq5x1x5YdvCp4upKZYnA8ckafviDpmWEKp4afOZEqOli7gqSnh8I6enH" crossorigin="anonymous"></script>
            <script>
document.addEventListener("DOMContentLoaded", function(){
  renderMathInElement
    ( document.body
    , { delimiters: [ {left: "$$",  right: "$$",  display: true}
                    , {left: "\\(", right: "\\)", display: false}
                    , {left: "\\[", right: "\\]", display: true}
                    , {left: "[[",  right: "]]",  display: true}
                    , {left: "$",   right: "$",   display: false} ]
    , })});
            </script>
          </header>
          <div class="post-content" itemprop="articleBody">
<h1 id="1.+%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><a class="headerlink" href="#1.+%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">1. はじめに</a></h1>
<p>こんにちは､びしょ〜じょです｡
前回はPromiseの実装に失敗していることが明らかになりました｡
そこで今回は､Promiseの実装に必要となる継続モナドの導入をします｡</p>
<h1 id="2.+%E7%B6%99%E7%B6%9A%3F+%E3%83%A2%E3%83%8A%E3%83%89%3F+%E3%81%AF%3F+%E3%83%9E%E3%83%9E%3F"><a class="headerlink" href="#2.+%E7%B6%99%E7%B6%9A%3F+%E3%83%A2%E3%83%8A%E3%83%89%3F+%E3%81%AF%3F+%E3%83%9E%E3%83%9E%3F">2. 継続? モナド? は? ママ?</a></h1>
<p>継続モナドは実はみんなのママなのですが</p>
<div class="twicard">
  <span class="image"><a href="https://www.schoolofhaskell.com/school/to-infinity-and-beyond/pick-of-the-week/the-mother-of-all-monads" target="_blank" rel="noopener noreferrer"><div><img src="/pictures/no_image.png"></div></a></span>
  <span class="txt">
    <div class="title"><a href="https://www.schoolofhaskell.com/school/to-infinity-and-beyond/pick-of-the-week/the-mother-of-all-monads" target="_blank" rel="noopener noreferrer">The Mother of all Monads - School of Haskell | School of Haskell</a></div>
    <div class="description"></div>
  </span>
</div>
<p>今回は単純に評価器をCPSにするにあたって継続を渡しまくることになるので､継続モナドを導入して実装をスッキリさせるつもりです｡</p>
<p>evalがCPSとはどういうことかというと､evalがCPSになっているということ……｡
わかりやすい二項演算を例に見てみると､</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="k">rec</span> <span class="n">eval_k</span> <span class="o">:</span> <span class="k">type</span> <span class="n">ans</span><span class="o">.</span> <span class="n">env</span> <span class="o">-&gt;</span> <span class="n">exp</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">value</span> <span class="o">-&gt;</span> <span class="n">ans</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ans</span> <span class="o">=</span>
  <span class="k">fun</span> <span class="n">env</span> <span class="n">exp</span> <span class="n">k</span> <span class="o">-&gt;</span>
  <span class="k">match</span> <span class="n">exp</span> <span class="k">with</span>
  <span class="o">......</span>
  <span class="o">|</span> <span class="nc">Op</span> <span class="p">(</span><span class="n">op</span><span class="o">,</span> <span class="n">e1</span><span class="o">,</span> <span class="n">e2</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">eval_k</span> <span class="n">env</span> <span class="n">e1</span> <span class="o">@@</span> <span class="k">fun</span> <span class="n">v1</span> <span class="o">-&gt;</span>
    <span class="n">eval_k</span> <span class="n">env</span> <span class="n">e2</span> <span class="o">@@</span> <span class="k">fun</span> <span class="n">v2</span> <span class="o">-&gt;</span>
    <span class="n">binop_k</span> <span class="n">op</span> <span class="n">v1</span> <span class="n">v2</span> <span class="n">k</span>
    <span class="o">......</span>
</code></pre></div>
<p>こんな雰囲気｡
若干ゃだるいので､継続モナドを使ってスマートに実装する｡
ここでいう"モナド"とは <code>&gt;&gt;=</code> や <code>return</code> のある便利な代数構造を指しています｡</p>
<p>継続モナドを導入すると上記のプログラムは</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="k">rec</span> <span class="n">eval</span> <span class="o">:</span> <span class="k">type</span> <span class="n">ans</span><span class="o">.</span> <span class="n">env</span> <span class="o">-&gt;</span> <span class="n">exp</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">value</span><span class="o">,</span> <span class="n">ans</span><span class="p">)</span> <span class="nn">Cont</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span>
  <span class="k">fun</span> <span class="n">env</span> <span class="n">exp</span> <span class="o">-&gt;</span>
  <span class="k">match</span> <span class="n">exp</span> <span class="k">with</span>
  <span class="o">......</span>
  <span class="o">|</span> <span class="nc">Op</span> <span class="p">(</span><span class="n">op</span><span class="o">,</span> <span class="n">e1</span><span class="o">,</span> <span class="n">e2</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">let</span><span class="o">*</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">eval</span> <span class="n">env</span> <span class="n">e1</span> <span class="k">in</span>
    <span class="k">let</span><span class="o">*</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">eval</span> <span class="n">env</span> <span class="n">e2</span> <span class="k">in</span>
    <span class="n">lift</span> <span class="o">@@</span> <span class="n">binop_k</span> <span class="n">op</span> <span class="n">v1</span> <span class="n">v2</span>
</code></pre></div>
<p>こういう感じで書けるようになることが期待される｡</p>
<h1 id="3.+%3Ccode%3Econt.ml%3C%2Fcode%3E+%E5%AE%9F%E8%A3%85"><a class="headerlink" href="#3.+%3Ccode%3Econt.ml%3C%2Fcode%3E+%E5%AE%9F%E8%A3%85">3. <code>cont.ml</code> 実装</a></h1>
<p>継続は残りの計算なんですが､型で表すと</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">type</span> <span class="p">(</span><span class="k">'</span><span class="n">hole</span><span class="o">,</span> <span class="k">'</span><span class="n">ans</span><span class="p">)</span> <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="k">'</span><span class="n">hole</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="n">ans</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="n">ans</span>
</code></pre></div>
<p>計算に穴(<code>'hole</code>)が空いており､それに何か値を渡すと残りの計算(<code>'hole -&gt; 'ans</code>)が走って実行結果(<code>'ans</code>)が返ってくる､と読める｡</p>
<p>あとはやるだけなのでこのようなシグネチャと対応する実装を用意すれ</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">val</span> <span class="p">(</span> <span class="o">&gt;&gt;=</span> <span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="k">'</span><span class="n">a</span><span class="o">,</span> <span class="k">'</span><span class="n">ans</span><span class="p">)</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="k">'</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="k">'</span><span class="n">b</span><span class="o">,</span> <span class="k">'</span><span class="n">ans</span><span class="p">)</span> <span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="k">'</span><span class="n">b</span><span class="o">,</span> <span class="k">'</span><span class="n">ans</span><span class="p">)</span> <span class="n">t</span>
<span class="k">val</span> <span class="p">(</span> <span class="k">let</span><span class="o">*</span> <span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="k">'</span><span class="n">a</span><span class="o">,</span> <span class="k">'</span><span class="n">ans</span><span class="p">)</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="k">'</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="k">'</span><span class="n">b</span><span class="o">,</span> <span class="k">'</span><span class="n">ans</span><span class="p">)</span> <span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="k">'</span><span class="n">b</span><span class="o">,</span> <span class="k">'</span><span class="n">ans</span><span class="p">)</span> <span class="n">t</span>
<span class="k">val</span> <span class="n">return</span> <span class="o">:</span> <span class="k">'</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="k">'</span><span class="n">a</span><span class="o">,</span> <span class="k">'</span><span class="n">ans</span><span class="p">)</span> <span class="n">t</span>
<span class="k">val</span> <span class="n">lift</span> <span class="o">:</span> <span class="p">((</span><span class="k">'</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="k">'</span><span class="n">a</span><span class="o">,</span> <span class="k">'</span><span class="n">b</span><span class="p">)</span> <span class="n">t</span>
<span class="k">val</span> <span class="n">run</span> <span class="o">:</span> <span class="p">(</span><span class="k">'</span><span class="n">a</span><span class="o">,</span> <span class="k">'</span><span class="n">b</span><span class="p">)</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="k">'</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="n">b</span>
<span class="k">val</span> <span class="n">run_identity</span> <span class="o">:</span> <span class="p">(</span><span class="k">'</span><span class="n">a</span><span class="o">,</span> <span class="k">'</span><span class="n">a</span><span class="p">)</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="n">a</span>
</code></pre></div>
<p>特に､</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="p">(</span> <span class="o">&gt;&gt;=</span> <span class="p">)</span> <span class="n">cont</span> <span class="n">k</span> <span class="n">k'</span> <span class="o">=</span>
  <span class="n">cont</span>
  <span class="o">@@</span> <span class="k">fun</span> <span class="n">a</span> <span class="o">-&gt;</span>
  <span class="k">let</span> <span class="n">cont'</span> <span class="o">=</span> <span class="n">k</span> <span class="n">a</span> <span class="k">in</span>
  <span class="n">cont'</span> <span class="n">k'</span>
<span class="p">;;</span>
</code></pre></div>
<p>加えて､<code>List.map</code>も継続バージョンが欲しくなったので追加した｡</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">module</span> <span class="nc">List</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">map</span> <span class="o">~</span><span class="n">f</span> <span class="n">xs</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">xs</span> <span class="k">with</span>
    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">return</span> <span class="bp">[]</span>
    <span class="o">|</span> <span class="n">x</span> <span class="o">::</span> <span class="n">xs'</span> <span class="o">-&gt;</span>
      <span class="k">let</span><span class="o">*</span> <span class="n">y</span> <span class="o">=</span> <span class="n">f</span> <span class="n">x</span> <span class="k">in</span>
      <span class="k">let</span><span class="o">*</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">map</span> <span class="o">~</span><span class="n">f</span> <span class="n">xs'</span> <span class="k">in</span>
      <span class="n">return</span> <span class="o">@@</span> <span class="p">(</span><span class="n">y</span> <span class="o">::</span> <span class="n">ys</span><span class="p">)</span>
  <span class="p">;;</span>
<span class="k">end</span>
</code></pre></div>
<p>一般的な<code>List.map</code>とほとんど同じように定義されているのにCPSになっているのが面白い｡
これが抽象化の力である｡</p>
<h1 id="4.+eval%E3%82%92CPSify"><a class="headerlink" href="#4.+eval%E3%82%92CPSify">4. evalをCPSify</a></h1>
<p><code>eval_exp</code>および<code>eval_stmts</code>も､<code>List.map</code>と同様に､ちょっと書き換えるだけである｡</p>
<div class="highlight"><pre><code class="language-diff" data-lang="diff"><span class="err">......</span>
+and eval_exp : type ans. env -&gt; exp -&gt; (runtime_value, ans) Cont.t =
<span class="gi">+ fun env exp -&gt;
+  let open Cont in
</span><span class="gd">-and eval_exp env exp =
</span>   let () = Thread_pool.run () |&gt; ignore in
   match exp with
<span class="gi">+  | Value v -&gt; return @@ rtv_of_value env v
</span><span class="gd">-  | Value v -&gt; rtv_of_value env v
</span>   | Op (op, e1, e2) -&gt;
<span class="gi">+    let* v1 = eval_exp env e1 in
+    let* v2 = eval_exp env e2 in
+    return @@ binop op v1 v2
+  | Call (e, es) -&gt;
+    let* fn = eval_exp env e in
+    let* args = Cont.List.map ~f:(eval_exp env) es in
</span><span class="gd">-    let v1 = eval_exp env e1 in
-    let v2 = eval_exp env e2 in
-    binop op v1 v2
-  | Call (e1, e2) -&gt;
-    let fn = eval_exp env e1 in
-    let args = List.map ~f:(eval_exp env) e2 in
</span>     (match fn with
     | Closure (env', xs, body) -&gt;
       let env'' = bind_args xs args @ env' in
<span class="err">......</span>

<span class="gi">+and eval_stmts : type ans. env -&gt; stmts -&gt; (runtime_value, ans) Cont.t =
+ fun env stmts -&gt;
+  let open Cont in
</span><span class="gd">-and eval_stmts env stmts =
</span>   match stmts with
   | End stmt -&gt;
     (match stmt with
     | Expression e | Def (_, e) -&gt;
<span class="gi">+      let* _ = eval_exp env e in
+      return RUnit
</span><span class="gd">-      let () = eval_exp env e |&gt; ignore in
-      RUnit
</span>     | Return e -&gt; eval_exp env e)
   | Last (stmt, tl) -&gt;
     (match stmt with
     | Expression e -&gt;
<span class="gi">+      let* _ = eval_exp env e in
</span><span class="gd">-      let () = eval_exp env e |&gt; ignore in
</span>       eval_stmts env tl
     | Def (x, e) -&gt;
<span class="gi">+      let* rtv = eval_exp env e in
+      let env' = (x, rtv) :: env in
</span><span class="gd">-      let env' = (x, eval_exp env e) :: env in
</span>       eval_stmts env' tl
     | Return e -&gt; eval_exp env e)
 ;;
</code></pre></div>
<p>answer typeを多相にしたかったので<code>forall</code>で型注釈を付けた｡
GADTsやrecord以外でOCamlのプログラムに型注釈を付けたくなる数少ないシーンな気がする｡</p>
<p>実際のところ､あまり変わってないのはとりあえずCPSっぽくしたというだけで本当にやるべきことをやってないからです｡
次やるべきことは､<code>Promise(Wait(-))</code>で継続をガバッと取って､前回確認したように<code>.then</code>に取ってきた継続を渡して残りの文を1つの大きなpromise objectにするところですね｡</p>
<h1 id="5.+%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><a class="headerlink" href="#5.+%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB">5. おわりに</a></h1>
<p>jane streetが<code>Core.Cont</code>を用意してくれれば睡眠時間が長くなったんじゃないですか? でも楽しかったからオッケーです!</p>
          </div>
        </article>

      </div>
    </div>
    <footer>
      <div class="pagination btn-group" style="text-align: center; font-family: 'Comfortaa';">
        <a class="btn prev" href="/2020/05/06/nikkan-promise3.html" title="日刊Promise(3) スレッドプールっぽいものを作ってsetTimeoutを改修">← Prev</a>
        /<a class="btn" href="/">Top</a>/
        <a class="btn next" href="/2020/08/25/tswara.html" title="Unsound TypeScript: spread syntax">Next →</a>
      </div>
    </footer>

  </body>
</html>
