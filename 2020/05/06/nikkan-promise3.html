<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html;charset=UTF-8" http-equiv="content-type"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="format-detection" content="telephone=no"/>

    <title>æ—¥åˆŠPromise(3) ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«ã£ã½ã„ã‚‚ã®ã‚’ä½œã£ã¦setTimeoutã‚’æ”¹ä¿® - lilyum ensemble</title>
    <meta itemprop="name" content="æ—¥åˆŠPromise(3) ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«ã£ã½ã„ã‚‚ã®ã‚’ä½œã£ã¦setTimeoutã‚’æ”¹ä¿® - lilyum ensemble"/>
    <meta name="keywords" content="æ—¥åˆŠPromise,JavaScript"/>
    <meta name="thumbnail" content="/pictures/2020/05/06/nikkan-promise3/thumb.png"/>
    <meta itemprop="image" content="/pictures/2020/05/06/nikkan-promise3/thumb.png"/>

    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:site" content="lilyum ensemble"/>
    <meta name="twitter:title" content="æ—¥åˆŠPromise(3) ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«ã£ã½ã„ã‚‚ã®ã‚’ä½œã£ã¦setTimeoutã‚’æ”¹ä¿® - lilyum ensemble"/>
    <meta name="twitter:url" content="/2020/05/06/nikkan-promise3.html"/> 
    <meta name="twitter:text:description" content="1. ã¯ã˜ã‚ã«ã“ã‚“ã«ã¡ã¯ï½¤ã³ã—ã‚‡ã€œã˜ã‚‡ã§ã™ï½¡â€œæ—¥åˆŠ"ã§ã™ãŒæ˜¨æ—¥ã¯ç¥çµµå¸«æ´»å‹•ã®ãŸã‚ãŠä¼‘ã¿ã‚’ã„ãŸã ã„ãŸãŸã‚ï½¤ã»ã¼æ—¥ã«ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸï½¡ä»Šå›ã¯ï½¤å‰å›ã®èª²é¡Œã§ã‚ã£ãŸsetTimeoutãŒãªã‚“ã‹ãŠã‹ã—ã„..."/>
    <meta name="twitter:image" content="https://nymphium.github.io/pictures/2020/05/06/nikkan-promise3/thumb.png"/>
    <meta name="twitter:image:src" content="https://nymphium.github.io/pictures/2020/05/06/nikkan-promise3/thumb.png"/>

    <link rel="icon" type="image/x-icon" href="/favicon.ico"/>
    <link rel="stylesheet" href="/css/main.css"/>
    <link rel="alternate" type="application/rss+xml" title="lilyum ensemble" href="/feed.xml"/>
    <link href="https://fonts.googleapis.com/css?family=Comfortaa:300%7CDroid+Sans+Mono%7CCrimson+Text:400,400i" rel="stylesheet"/>
<!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="æ—¥åˆŠPromise(3) ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«ã£ã½ã„ã‚‚ã®ã‚’ä½œã£ã¦setTimeoutã‚’æ”¹ä¿®" />
<meta name="author" content="Satoru Kawahara" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="lily, Aikatsu, Programming language, and more" />
<meta property="og:description" content="lily, Aikatsu, Programming language, and more" />
<link rel="canonical" href="https://nymphium.github.io/2020/05/06/nikkan-promise3.html" />
<meta property="og:url" content="https://nymphium.github.io/2020/05/06/nikkan-promise3.html" />
<meta property="og:site_name" content="lilyum ensemble" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-06T00:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="æ—¥åˆŠPromise(3) ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«ã£ã½ã„ã‚‚ã®ã‚’ä½œã£ã¦setTimeoutã‚’æ”¹ä¿®" />
<script type="application/ld+json">
{"headline":"æ—¥åˆŠPromise(3) ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«ã£ã½ã„ã‚‚ã®ã‚’ä½œã£ã¦setTimeoutã‚’æ”¹ä¿®","dateModified":"2020-05-06T00:00:00+09:00","datePublished":"2020-05-06T00:00:00+09:00","description":"lily, Aikatsu, Programming language, and more","url":"https://nymphium.github.io/2020/05/06/nikkan-promise3.html","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://nymphium.github.io/2020/05/06/nikkan-promise3.html"},"author":{"@type":"Person","name":"Satoru Kawahara"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta property="og:image" content="/pictures/2020/05/06/nikkan-promise3/thumb.png"/>
  </head>

  <body>
    <header class="site-header">
      <div class="wrapper" style="font-family: 'Comfortaa';">
        <a class="site-title" href="/">lilyum ensemble</a>
        <nav class="site-nav">
          <div class="trigger">
            <a class="page-link" href="/aboutme.html">About</a>
            <a class="page-link" href="/slide.html">Slides</a>
            <a class="page-link" href="/tags.html">Tags</a>
          </div>
        </nav>
      </div>
    </header>

    <div class="page-content">
      <div class="wrapper" lang="ja">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
          <header class="post-header">
            <h1 class="post-title" itemprop="name headline">æ—¥åˆŠPromise(3) ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«ã£ã½ã„ã‚‚ã®ã‚’ä½œã£ã¦setTimeoutã‚’æ”¹ä¿®</h1>
            <span class="post-meta">
              <time datetime="2020-05-06T00:00:00+09:00" itemprop="datePublished">May 6, 2020</time>
              <a class="src" href="https://github.com/nymphium/nymphium.github.io/blob/source/_posts%2F2020-05-06-nikkan-promise3.md" target="_blank" rel="noopener noreferrer">src</a>
              <p class="tags">tag: {<span class="tag"><a href="/tags.html#%E6%97%A5%E5%88%8APromise-ref">æ—¥åˆŠPromise</a></span><span></span> <span class="tag"><a href="/tags.html#JavaScript-ref">JavaScript</a></span>}</p>
              <a class="twitter-share-button" href="https://twitter.com/intent/tweet" target="_blank" rel="noopener noreferrer">Tweet</a> 
            </span>
            <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
            <script type="text/javascript" src="/js/GithubRepoWidget.min.js"></script>
            <script type="text/javascript">setTimeout(GithubRepoWidget.init, 3000);</script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" integrity="sha384-9tPv11A+glH/on/wEu99NVwDPwkMQESOocs/ZGXPoIiLE8MU/qkqUcZ3zzL+6DuH" crossorigin="anonymous">
            <!-- The loading of KaTeX is deferred to speed up page rendering -->
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.js" integrity="sha384-U8Vrjwb8fuHMt6ewaCy8uqeUXv4oitYACKdB0VziCerzt011iQ/0TqlSlv8MReCm" crossorigin="anonymous"></script>
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/contrib/auto-render.min.js" integrity="sha384-aGfk5kvhIq5x1x5YdvCp4upKZYnA8ckafviDpmWEKp4afOZEqOli7gqSnh8I6enH" crossorigin="anonymous"></script>
            <script>
document.addEventListener("DOMContentLoaded", function(){
  renderMathInElement
    ( document.body
    , { delimiters: [ {left: "$$",  right: "$$",  display: true}
                    , {left: "\\(", right: "\\)", display: false}
                    , {left: "\\[", right: "\\]", display: true}
                    , {left: "[[",  right: "]]",  display: true}
                    , {left: "$",   right: "$",   display: false} ]
    , })});
            </script>
          </header>
          <div class="post-content" itemprop="articleBody">
<h1 id="1.+%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><a class="headerlink" href="#1.+%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">1. ã¯ã˜ã‚ã«</a></h1>
<p>ã“ã‚“ã«ã¡ã¯ï½¤ã³ã—ã‚‡ã€œã˜ã‚‡ã§ã™ï½¡
â€œæ—¥åˆŠ"ã§ã™ãŒæ˜¨æ—¥ã¯ç¥çµµå¸«æ´»å‹•ã®ãŸã‚ãŠä¼‘ã¿ã‚’ã„ãŸã ã„ãŸãŸã‚ï½¤ã»ã¼æ—¥ã«ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸï½¡</p>
<p>ä»Šå›ã¯ï½¤å‰å›ã®èª²é¡Œã§ã‚ã£ãŸ<code>setTimeout</code>ãŒãªã‚“ã‹ãŠã‹ã—ã„ã®ã‚’ç›´ã—ã¾ã—ãŸï½¡
æœ¬å½“ã¯<code>Promise</code>ã¾ã§ã‚¤ãƒƒã‚­ã«ã„ããŸã‹ã£ãŸãŒï½¤ã‚‚ã†ä¸€ç™ºå¤§æ”¹ä¿®ãŒå¿…è¦ãã†ã ã£ãŸã®ã§ä»Šå›ã¯è«¦ã‚ã¾ã—ãŸï½¡</p>
<p>ä»Šå›ã‚‚æ”¾æ˜ ã—ãŸ</p>
<div class="twicard">
  <span class="image"><a href="https://www.youtube.com/watch?v=D5ZkCvEomm4" target="_blank" rel="noopener noreferrer"><div><img src="/pictures/no_image.png"></div></a></span>
  <span class="txt">
    <div class="title"><a href="https://www.youtube.com/watch?v=D5ZkCvEomm4" target="_blank" rel="noopener noreferrer">youtube</a></div>
    <div class="description"></div>
  </span>
</div>
<p>ã¨ã“ã‚ã§ä¸­é€”åŠç«¯ã«<code>Base</code>ã‚’ä½¿ã£ã¦ã„ãŸãŒï½¤ã„ã‚ˆã„ã‚ˆ<code>open Base</code>ã—ãŸï½¡</p>
<h1 id="2.+closure"><a class="headerlink" href="#2.+closure">2. closure</a></h1>
<p>ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£å®Ÿè£…ã—ã¦ãªãã¦ï¾œï¾›ï¾€ãªã®ã§å®Ÿè£…ã—ãŸï½¡
ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã¨ã„ã†ã®ã¯ã§ã™ã­ãˆå¤‰æ•°ç’°å¢ƒã‚’closingã—ã¦ã„ã‚‹é–¢æ•°ã®ã“ã¨ã§ã™ï½¡</p>
<div class="highlight">
<span class="listing-name">fãŒç’°å¢ƒ[{name: "xâ€; value: 3}]ã‚’closingã—ã¦ã„ã‚‹</span><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">x</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">());</span> <span class="c1">// ==&gt; 3</span>
</code></pre>
</div>
<p><code>let</code>ã«ã—ãŸå ´åˆ(å†…éƒ¨çš„ã«)reference cellã«ãªã‚‹ã®ã§å¤–å´ã‹ã‚‰æ›¸ãæ›ãˆãŒã§ãã¾ã™ãŒï½¤ä»Šå›ã®å®Ÿè£…ã¯JSã®ã‚µãƒ–ã‚»ãƒƒãƒˆã«ãªã£ã¦ãŠã‚Š<code>let</code>ã¯omitã—ã¦ã„ã‚‹ã®ã§è€ƒãˆã¾ã›ã‚“ï½¡</p>
<p>ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã«ï½¤ã¾ãš<em>å®Ÿè¡Œæ™‚ã®å€¤</em>ã‚’å®šç¾©ã™ã‚‹ï½¡</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="c">(* ç¢ºã‹ã«ç’°å¢ƒã¯æŸç¸›ã•ã‚Œã¦ã„ã‚‹å¤‰æ•°ã¨ å®Ÿè¡Œæ™‚ã®å€¤ ã®ãƒšã‚¢ã®ãƒªã‚¹ãƒˆã§ã™ã­ *)</span>
<span class="k">type</span> <span class="n">env</span> <span class="o">=</span> <span class="p">(</span><span class="n">variable</span> <span class="o">*</span> <span class="n">runtime_value</span><span class="p">)</span> <span class="kt">list</span>

<span class="ow">and</span> <span class="n">runtime_value</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">RNull</span>
  <span class="o">|</span> <span class="nc">RUnit</span>
  <span class="o">|</span> <span class="nc">RNum</span> <span class="k">of</span> <span class="n">number</span>
  <span class="o">|</span> <span class="nc">RBuiltin</span> <span class="k">of</span> <span class="n">builtin</span>
  <span class="o">|</span> <span class="nc">Closure</span> <span class="k">of</span> <span class="n">env</span> <span class="o">*</span> <span class="n">variable</span> <span class="kt">list</span> <span class="o">*</span> <span class="n">stmts</span>
</code></pre></div>
<p><code>Closure</code> ä»¥å¤–ã¯ã‹ãªã‚Šä½œè€…éƒ½åˆã«ã‚ˆã‚‹ã‚‚ã®ã§ã™ã­ï½¡ã‚­ãƒ„ã„ï½¡
ãã—ã¦ãã‚Œã‚‰ã¨<code>value</code>ã‚’ç›¸äº’ã«å¤‰æ›ã™ã‚‹ãŸã‚ã®<code>value_of_rtv</code>ã¨<code>rtv_of_value</code>ã‚’å®šç¾©ã—ãŸï½¡
å¾Œè€…ã¯é–¢æ•°ã‹ã‚‰ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã‚’ä½œã‚‹ã¨ãã«ç’°å¢ƒã‚’æ³¨å…¥ã—ãŸã„ã®ã§<code>env</code>ã‚’åŒæ™‚ã«å—ã‘å–ã‚‹ï½¡</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="n">eval_exp</span> <span class="n">env</span> <span class="n">exp</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">exp</span> <span class="k">with</span>
  <span class="c">(* Value(Var(x)) -&gt; lookup x env ãŒè¦ã‚‰ãªããªã£ãŸã‚“ã§ï½³ï¾šï½¼ *)</span>
  <span class="o">|</span> <span class="nc">Value</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">rtv_of_value</span> <span class="n">v</span>
  <span class="o">......</span>
  <span class="o">|</span> <span class="nc">Call</span> <span class="p">(</span><span class="n">e1</span><span class="o">,</span> <span class="n">e2</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">eval_exp</span> <span class="n">env</span> <span class="n">e1</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">args</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">~</span><span class="n">f</span><span class="o">:</span><span class="p">(</span><span class="n">eval_exp</span> <span class="n">env</span><span class="p">)</span> <span class="n">e2</span> <span class="k">in</span>
    <span class="p">(</span><span class="k">match</span> <span class="n">fn</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Closure</span> <span class="p">(</span><span class="n">env'</span><span class="o">,</span> <span class="n">xs</span><span class="o">,</span> <span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">env''</span> <span class="o">=</span> <span class="n">bind_args</span> <span class="n">xs</span> <span class="n">args</span> <span class="o">@</span> <span class="n">env'</span> <span class="k">in</span>
      <span class="n">eval_stmts</span> <span class="n">env''</span> <span class="n">body</span> <span class="o">|&gt;</span> <span class="n">rtv_of_value</span> <span class="n">env''</span>
    <span class="o">......</span><span class="p">)</span>
</code></pre></div>
<p>closingã—ãŸç’°å¢ƒã ã‘ã§ã‚„ã£ã¦ã„ãã®ã§ï½¤ç¾åœ¨ã®è©•ä¾¡ç’°å¢ƒã¯ä½¿ã„ã¾ã›ã‚“ï½¡</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span><span class="o">%</span><span class="n">test</span> <span class="s2">"fun"</span> <span class="o">=</span>
  <span class="c">(**
   * const x = 5;
   * const f = (y) =&gt; x + y;
   * const x = 10; // ãã‚‚ãã‚‚syntax errorã ãŒå¿µã®ãŸã‚
   * return f(12)
   *)</span>
  <span class="k">let</span> <span class="n">stmts</span> <span class="o">=</span>
    <span class="nn">Nlist</span><span class="p">.</span><span class="n">from_list</span>
      <span class="p">[</span> <span class="nc">Def</span> <span class="p">(</span><span class="s2">"x"</span><span class="o">,</span> <span class="nc">Value</span> <span class="p">(</span><span class="nc">Num</span> <span class="mi">5</span><span class="p">))</span>
      <span class="p">;</span> <span class="nc">Def</span>
          <span class="p">(</span> <span class="s2">"f"</span>
          <span class="o">,</span> <span class="nc">Value</span>
              <span class="p">(</span><span class="nc">Fun</span>
                 <span class="p">(</span> <span class="p">[</span> <span class="s2">"y"</span> <span class="p">]</span>
                 <span class="o">,</span> <span class="nn">Nlist</span><span class="p">.</span><span class="n">from_list</span> <span class="p">[</span> <span class="nc">Return</span> <span class="p">(</span><span class="nc">Op</span> <span class="p">(</span><span class="nc">Add</span><span class="o">,</span> <span class="nc">Value</span> <span class="p">(</span><span class="nc">Var</span> <span class="s2">"x"</span><span class="p">)</span><span class="o">,</span> <span class="nc">Value</span> <span class="p">(</span><span class="nc">Var</span> <span class="s2">"y"</span><span class="p">)))</span> <span class="p">]</span>
                 <span class="p">))</span> <span class="p">)</span>
      <span class="p">;</span> <span class="nc">Def</span> <span class="p">(</span><span class="s2">"x"</span><span class="o">,</span> <span class="nc">Value</span> <span class="p">(</span><span class="nc">Num</span> <span class="mi">10</span><span class="p">))</span>
      <span class="p">;</span> <span class="nc">Return</span> <span class="p">(</span><span class="nc">Call</span> <span class="p">(</span><span class="nc">Value</span> <span class="p">(</span><span class="nc">Var</span> <span class="s2">"f"</span><span class="p">)</span><span class="o">,</span> <span class="p">[</span> <span class="nc">Value</span> <span class="p">(</span><span class="nc">Num</span> <span class="mi">12</span><span class="p">)</span> <span class="p">]))</span>
      <span class="p">]</span>
  <span class="k">in</span>
  <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">run_program</span> <span class="n">stmts</span> <span class="k">in</span>
  <span class="n">equal_value</span> <span class="n">result</span> <span class="o">@@</span> <span class="nc">Num</span> <span class="mi">17</span>
<span class="p">;;</span>
</code></pre></div>
<p>ãƒ¨ã‚·!
â€¦â€¦ãã†ã„ãˆã°å†å¸°é–¢æ•°ãŒå®šç¾©ã§ããªã„ï½¡</p>
<p>closingã—ã¦ã„ã‚‹ç’°å¢ƒã«é–¢æ•°è‡ªèº«ã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ï½¡
è‡ªèº«ãŒæŸç¸›ã•ã‚Œã‚‹å¤‰æ•°åã‚’æŒã£ã¦ãŠãå¿…è¦ã‚‚ã‚ã‚‹ï½¡</p>
<p>ã¾ï½¤ã¾ã‚ä»Šå›ã¯JSã®ã‚µãƒ–ã‚»ãƒƒãƒˆãªã‚“ã§å†å¸°é–¢æ•°ã¯å®Ÿè£…ã—ãªã„ã¨ã„ã†é€ƒã’ã®ä¸€æ‰‹ã§ã„ãã¾ã™ï½¡</p>
<p><code>let-rec in</code>ã®ã‚ˆã†ã«ç’°å¢ƒã‚’ä½œã‚‹å¤‰æ•°æŸç¸›ã ã£ãŸã‚‰ã‚·ãƒ¥ãƒƒã¨ã„ã‘ãŸã®ã«â€¦â€¦ï½¡</p>
<h1 id="3.+%3Ccode%3EsetTimeout%3C%2Fcode%3E+%E3%82%92%E3%82%84%E3%82%8A%E3%81%AA%E3%81%8A%E3%81%97%E3%81%BE%E3%81%97%E3%82%87%E3%81%86%E3%83%BC%EF%BD%BD%EF%BE%9A%EF%BE%8C%EF%BE%9F%E3%81%A3%E3%81%BD%E3%81%84%E3%82%84%E3%81%A4"><a class="headerlink" href="#3.+%3Ccode%3EsetTimeout%3C%2Fcode%3E+%E3%82%92%E3%82%84%E3%82%8A%E3%81%AA%E3%81%8A%E3%81%97%E3%81%BE%E3%81%97%E3%82%87%E3%81%86%E3%83%BC%EF%BD%BD%EF%BE%9A%EF%BE%8C%EF%BE%9F%E3%81%A3%E3%81%BD%E3%81%84%E3%82%84%E3%81%A4">3. <code>setTimeout</code> ã‚’ã‚„ã‚ŠãªãŠã—ã¾ã—ã‚‡ã†ãƒ¼ï½½ï¾šï¾Œï¾Ÿã£ã½ã„ã‚„ã¤</a></h1>
<p>å‰å›å•é¡Œã¨ã—ã¦æ®‹ã£ãŸã‚‚ã®ã¯<code>setTimeout</code>ãŒåŒæœŸçš„ã«sleepã™ã‚‹ãŸã‚ã«ãªã‚“ã‚‚ã„ã„ã“ã¨ãŒãªã„ï½¤ã¨ã„ã†ã“ã¨ã§ã‚ã£ãŸï½¡</p>
<p>ã§ã¯ï½¤ã“ã†ã—ã¾ã—ã‚‡ã†ï½¡</p>
<p>ã¾ãšã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«ã‚’ä½œã‚‹ï½¡
<code>setTimeout</code>ã«æ¸¡ã•ã‚ŒãŸé–¢æ•°ã‚’ã‚¹ãƒ¬ãƒ—ã«çªã£è¾¼ã‚€ï½¡
nãƒã‚¤ã‚¯ãƒ­ç§’ãšã¤sleepã—ã¦ã‹ã‚‰pendingï½¤nãƒã‚¤ã‚¯ãƒ­ç§’ãšã¤sleepã—ã¦ã‹ã‚‰pendingã‚’ç¹°ã‚Šè¿”ã™ï½¡
pendingã—ãŸã‚‰ã‚‚ã¨ã®å®Ÿè¡Œã«æˆ»ã‚‹ï½¡
åˆè¨ˆã—ã¦<code>setTimeout</code>ã«æ¸¡ã•ã‚ŒãŸæ™‚é–“ã ã‘sleepã—ãŸã‚‰ï½¤æ¸¡ã•ã‚ŒãŸé–¢æ•°ã‚’å®Ÿè¡Œã—ï½¤çµ‚äº†ï½¡</p>
<p>ã‚¹ãƒ¬ãƒ—ã«ãƒ„ãƒƒã‚³ã¾ã‚Œã‚‹"ã‚¹ãƒ¬ãƒƒãƒ‰"ã¯ä»¥ä¸‹ã®å€¤ã‚’è¿”ã™thunkã§ã‚ã‚‹ï½¡</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">type</span> <span class="n">thread_status</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Pending</span> <span class="k">of</span> <span class="p">(</span><span class="kt">unit</span> <span class="o">-&gt;</span> <span class="n">thread_status</span><span class="p">)</span>
  <span class="o">|</span> <span class="nc">Done</span> <span class="k">of</span> <span class="n">runtime_value</span>
</code></pre></div>
<p><code>Pending</code>ã«OCamlãƒ¬ãƒ™ãƒ«ã®é–¢æ•°ã‚’æ¸¡ã™ã“ã¨ã§ï½¤ã„ã„æ„Ÿã˜ã«sleepã‚’èµ°ã‚‰ã›ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ï½¡
ã‚¹ãƒ¬ãƒ—ã¯ã“ã®thunkãŒãƒ„ãƒƒã‚³ã¾ã‚ŒãŸã‚­ãƒ¥ãƒ¼ã«ãªã£ã¦ã„ã‚‹ï½¡
<code>Thread_pool</code>ãŒã‚¹ãƒ¬ãƒ—ã‚’å®Ÿè£…ã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã‚ã‚‹ï½¡
ã‚­ãƒ¥ãƒ¼è‡ªä½“ã¯éš è”½ã•ã‚Œã¦ã„ã‚‹ï½¡</p>
<p>å‰å›å®šç¾©ã—ãŸ<code>builtin</code>ã‚’æ‹¡å¼µã—ï½¤ä»¥ä¸‹ã®ã‚ˆã†ã«é–¢æ•°ã‚’ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°ã™ã‚‹ï½¡</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="c">(* ç¡çœ æ™‚é–“ã®æœ€å°å˜ä½ 20ms *)</span>
<span class="k">let</span> <span class="n">wait_unit</span> <span class="o">:</span> <span class="nn">Float</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="mi">20</span><span class="o">.</span> <span class="o">/.</span> <span class="mi">1000</span><span class="o">.</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">builtin</span> <span class="n">bin</span> <span class="n">rtvs</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">bin</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">SetTimeout</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="n">n</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">nth_exn</span> <span class="n">rtvs</span> <span class="mi">0</span> <span class="o">|&gt;</span> <span class="n">value_of_rtv</span> <span class="o">|&gt;</span> <span class="n">number_of_value</span> <span class="k">in</span>
    <span class="c">(* ã‚„ã¯ã‚Šã‚«ãƒªãƒ¼åŒ–ã‚’ã‚„ã‚ãŸï½¡ç¬¬2å¼•æ•°ã«é–¢æ•°ã‚’å—ã‘å–ã‚‹ï½¡ *)</span>
    <span class="p">(</span><span class="k">match</span> <span class="nn">List</span><span class="p">.</span><span class="n">nth_exn</span> <span class="n">rtvs</span> <span class="mi">1</span> <span class="k">with</span>
    <span class="c">(* ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãŒå½¹ã«ç«‹ã£ãŸğŸ˜ƒ ã¨ã‚Šã‚ãˆãšå¼•æ•°ã¯æ¨ã¦ã‚‹ï½¡ *)</span>
    <span class="o">|</span> <span class="nc">Closure</span> <span class="p">(</span><span class="n">env</span><span class="o">,</span> <span class="n">_</span><span class="o">,</span> <span class="n">stmts</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="c">(* refã«ã¤ã£ã“ã‚€ *)</span>
      <span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">@@</span> <span class="p">(</span><span class="nn">Float</span><span class="p">.</span><span class="n">of_int</span> <span class="n">n</span> <span class="o">/.</span> <span class="mi">1000</span><span class="o">.</span><span class="p">)</span> <span class="k">in</span>
      <span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
        <span class="n">ignore</span>
        <span class="o">@@</span> <span class="nn">Thread_pool</span><span class="p">.</span><span class="n">enqueue</span>
        <span class="o">@@</span>
        <span class="c">(* ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³åŒ–ã®ã‚ˆã†ãªå½¢ã«ãªã£ã¦é¢ç™½ã„ï½¡ã“ã®é–¢æ•°ã‚’ã‚¹ãƒ¬ãƒ—ã«çªã£è¾¼ã‚€ï½¡ *)</span>
        <span class="k">let</span> <span class="k">rec</span> <span class="n">it</span> <span class="bp">()</span> <span class="o">=</span>
          <span class="c">(* wait_unitç§’sleepã™ã‚‹ *)</span>
          <span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">sleepf</span> <span class="n">wait_unit</span> <span class="k">in</span>
          <span class="c">(* æœ€æ‚ª19msä½™è¨ˆã«sleepã™ã‚‹ãŒï½¤ç²¾åº¦ã¯ãã‚“ãªã«ç²¾å¯†ã§ã‚ã‚‹å¿…è¦ã¯ãªã„ *)</span>
          <span class="k">let</span> <span class="n">rest</span> <span class="o">=</span> <span class="o">!</span><span class="n">time</span> <span class="o">-.</span> <span class="n">wait_unit</span> <span class="k">in</span>
          <span class="k">if</span> <span class="nn">Float</span><span class="p">.(</span><span class="n">rest</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">.</span><span class="p">)</span>
          <span class="k">then</span> <span class="p">(</span>
            <span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">eval_stmts</span> <span class="n">env</span> <span class="n">stmts</span> <span class="o">|&gt;</span> <span class="n">ignore</span> <span class="k">in</span>
            <span class="nc">Done</span> <span class="nc">RUnit</span><span class="p">)</span>
          <span class="k">else</span> <span class="p">(</span>
            <span class="n">time</span> <span class="o">:=</span> <span class="n">rest</span><span class="p">;</span>
            <span class="nc">Pending</span> <span class="n">it</span><span class="p">)</span>
        <span class="k">in</span>
        <span class="n">it</span>
      <span class="k">in</span>
      <span class="nc">RUnit</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"second value of setTimeout should be a function"</span><span class="p">)</span>
  <span class="o">......</span>
</code></pre></div>
<p>ã‚¹ãƒ¬ãƒ—ã‹ã‚‰ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’1ã¤å–ã‚Šå‡ºã—ã¦å®Ÿè¡Œã—ï½¤pendingã—ãŸã‚‰ã¾ãŸã‚¹ãƒ¬ãƒ—ã«æˆ»ã™ï½¤ã¨ã„ã†æ“ä½œã‚’<code>eval_exp</code>1å›ã”ã¨ã«ãŠã“ãªã†ï½¡</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="ow">and</span> <span class="n">eval_exp</span> <span class="n">env</span> <span class="n">exp</span> <span class="o">=</span>
  <span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Thread_pool</span><span class="p">.</span><span class="n">run</span> <span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span> <span class="k">in</span>
  <span class="k">match</span> <span class="n">exp</span> <span class="k">with</span>
  <span class="o">......</span>
</code></pre></div>
<p><code>eval_exp</code>1å›ã‚ãŸã‚Šã®è©•ä¾¡æ™‚é–“ã‚’ç„¡è¦–ã—ã¦ã„ã‚‹ãŒï½¤ç„¡è¦–ã—ã¦ã„ã‚‹å®Ÿè¡Œæ™‚é–“ã«ã‚ˆã‚ŠsleepãŒã©ã‚“ã©ã‚“ã‚ºãƒ¬ã¦ã„ãã“ã¨ã«ãªã‚‹ãŒï½¤ã¾ã‚ã“ã®æ–¹æ³•ã§ã¯ä»•æ–¹ãªã„ï½¡</p>
<p><code>Thread_pool.run</code>ã¯ã“ã‚“ãªæ„Ÿã˜ã«optionalã«<code>Done</code>ã®æŒã¤å€¤ã‚’è¿”ã™ï½¡</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="n">run</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* ã‚­ãƒ¥ãƒ¼ã®å…ˆé ­ã‚’å–ã‚Šå‡ºã—ï½¤ *)</span>
  <span class="k">let</span> <span class="n">top</span> <span class="o">=</span> <span class="nn">Queue</span><span class="p">.</span><span class="n">dequeue</span> <span class="n">q</span> <span class="k">in</span>
  <span class="k">match</span> <span class="n">top</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">ts</span> <span class="o">-&gt;</span>
    <span class="p">(</span><span class="k">match</span> <span class="n">ts</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Done</span> <span class="n">rtv</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="n">rtv</span>
    <span class="c">(* pendingã—ã¦ã„ãŸã‚‰ãã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’èµ°ã‚‰ã›ã¦çµæœã‚’ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°ã™ã‚‹ï½¡ *)</span>
    <span class="o">|</span> <span class="nc">Pending</span> <span class="n">thread</span> <span class="o">-&gt;</span> <span class="nn">Fn</span><span class="p">.</span><span class="n">const</span> <span class="nc">None</span> <span class="o">@@</span> <span class="nn">Queue</span><span class="p">.</span><span class="n">enqueue</span> <span class="n">q</span> <span class="o">@@</span> <span class="n">thread</span> <span class="bp">()</span><span class="p">)</span>
<span class="p">;;</span>
</code></pre></div>
<p>ã—ã‹ã—ã“ã‚Œã ã‘ã ã¨ï½¤</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">world</span><span class="dl">"</span><span class="p">)</span>
<span class="p">},</span> <span class="mi">500</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">hello</span><span class="dl">"</span><span class="p">);</span>
</code></pre></div>
<p>ã¨ã„ã†ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã—ãŸã¨ãã«ï½¤(500/20=)25å›ã‚‚å¼ã‚’è©•ä¾¡ã—ãªã„ãŸã‚ï½¤<code>setTimeout</code>ã«æ¸¡ã•ã•ã‚ŒãŸé–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œãªã„ï½¡
ã§ã¯ã©ã†ã™ã‚‹ã‹?</p>
<p>ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ï½¤ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«ã«å…¥ã£ã¦ã„ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ãŒå…¨ã¦<code>Done</code>ã«ãªã‚‹ã¾ã§èµ°ã‚‰ã›ã‚Œã°è‰¯ã„ã§ã—ã‚‡ã†ï½¡</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="n">run_program</span> <span class="n">stmts</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">eval_stmts</span> <span class="bp">[]</span> <span class="n">stmts</span> <span class="k">in</span>
  <span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Thread_pool</span><span class="p">.</span><span class="n">run_all</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="c">(* å®Ÿè¡Œä¸–ç•Œã‹ã‚‰å¸°ã‚‹ã®ã§ã¨ã‚Šã‚ãˆãšå¤‰æ›ã—ã¦ã„ã‚‹ãŒâ€¦â€¦ *)</span>
  <span class="n">value_of_rtv</span> <span class="n">ret</span>
<span class="p">;;</span>
</code></pre></div>
<p><code>Thread_pool.run_all</code>ã¯ã“ã‚“ãªã‹ã‚“ã˜</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="k">rec</span> <span class="n">run_all</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">if</span> <span class="nn">Queue</span><span class="p">.</span><span class="n">is_empty</span> <span class="n">q</span> <span class="k">then</span> <span class="bp">()</span> <span class="k">else</span> <span class="n">run</span> <span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span> <span class="o">|&gt;</span> <span class="n">run_all</span>
</code></pre></div>
<p>ãƒ†ã‚¹ãƒˆã—ã¾ã™ã‚ˆãƒ¼ãƒ†ã‚¹ãƒˆ</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span><span class="o">%</span><span class="n">expect_test</span> <span class="n">_</span> <span class="o">=</span>
  <span class="c">(**
   * const x = 100;
   * setTimeout(() =&gt; console.log(x), 2000);
   * console.log(500);
   * setTimeout(() =&gt; console.log(40), 500);
   *)</span>
  <span class="k">let</span> <span class="n">stmts</span> <span class="o">=</span>
    <span class="nn">Nlist</span><span class="p">.</span><span class="n">from_list</span>
      <span class="p">[</span> <span class="nc">Def</span> <span class="p">(</span><span class="s2">"x"</span><span class="o">,</span> <span class="nc">Value</span> <span class="p">(</span><span class="nc">Num</span> <span class="mi">100</span><span class="p">))</span>
      <span class="p">;</span> <span class="nc">Expression</span>
          <span class="p">(</span><span class="nc">Call</span>
             <span class="p">(</span> <span class="nc">Value</span> <span class="p">(</span><span class="nc">Builtin</span> <span class="nc">SetTimeout</span><span class="p">)</span>
             <span class="o">,</span> <span class="p">[</span> <span class="nc">Value</span> <span class="p">(</span><span class="nc">Num</span> <span class="mi">2000</span><span class="p">)</span>
               <span class="p">;</span> <span class="nc">Value</span>
                   <span class="p">(</span><span class="nc">Fun</span>
                      <span class="p">(</span> <span class="bp">[]</span>
                      <span class="o">,</span> <span class="nn">Nlist</span><span class="p">.</span><span class="n">from_list</span>
                          <span class="p">[</span> <span class="nc">Expression</span>
                              <span class="p">(</span><span class="nc">Call</span> <span class="p">(</span><span class="nc">Value</span> <span class="p">(</span><span class="nc">Builtin</span> <span class="nc">ConsoleLog</span><span class="p">)</span><span class="o">,</span> <span class="p">[</span> <span class="nc">Value</span> <span class="p">(</span><span class="nc">Var</span> <span class="s2">"x"</span><span class="p">)</span> <span class="p">]))</span>
                          <span class="p">]</span> <span class="p">))</span>
               <span class="p">]</span> <span class="p">))</span>
      <span class="p">;</span> <span class="nc">Expression</span> <span class="p">(</span><span class="nc">Call</span> <span class="p">(</span><span class="nc">Value</span> <span class="p">(</span><span class="nc">Builtin</span> <span class="nc">ConsoleLog</span><span class="p">)</span><span class="o">,</span> <span class="p">[</span> <span class="nc">Value</span> <span class="p">(</span><span class="nc">Num</span> <span class="mi">500</span><span class="p">)</span> <span class="p">]))</span>
      <span class="p">;</span> <span class="nc">Expression</span>
          <span class="p">(</span><span class="nc">Call</span>
             <span class="p">(</span> <span class="nc">Value</span> <span class="p">(</span><span class="nc">Builtin</span> <span class="nc">SetTimeout</span><span class="p">)</span>
             <span class="o">,</span> <span class="p">[</span> <span class="nc">Value</span> <span class="p">(</span><span class="nc">Num</span> <span class="mi">500</span><span class="p">)</span>
               <span class="p">;</span> <span class="nc">Value</span>
                   <span class="p">(</span><span class="nc">Fun</span>
                      <span class="p">(</span> <span class="bp">[]</span>
                      <span class="o">,</span> <span class="nn">Nlist</span><span class="p">.</span><span class="n">from_list</span>
                          <span class="p">[</span> <span class="nc">Expression</span>
                              <span class="p">(</span><span class="nc">Call</span> <span class="p">(</span><span class="nc">Value</span> <span class="p">(</span><span class="nc">Builtin</span> <span class="nc">ConsoleLog</span><span class="p">)</span><span class="o">,</span> <span class="p">[</span> <span class="nc">Value</span> <span class="p">(</span><span class="nc">Num</span> <span class="mi">40</span><span class="p">)</span> <span class="p">]))</span>
                          <span class="p">]</span> <span class="p">))</span>
               <span class="p">]</span> <span class="p">))</span>
      <span class="p">]</span>
  <span class="k">in</span>
  <span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">run_program</span> <span class="n">stmts</span> <span class="o">|&gt;</span> <span class="n">ignore</span> <span class="k">in</span>
  <span class="p">[</span><span class="o">%</span><span class="n">expect</span> <span class="p">{</span><span class="o">|</span>
    <span class="mi">500</span>
    <span class="mi">40</span>
    <span class="mi">100</span>
    <span class="o">|</span><span class="p">}]</span>
<span class="p">;;</span>
</code></pre></div>
<p>æ¨™æº–å‡ºåŠ›ã®ãƒ†ã‚¹ãƒˆã®ãŸã‚ã«<a href="https://github.com/janestreet/ppx_expect" target="_blank" rel="noopener noreferrer"><code>ppx_expect</code></a>ã‚’ä½¿ã£ãŸï½¡
ã“ã„ã¤ãã™ã’ãˆã‚„ï½¡</p>
<h1 id="4.+Promise%EF%BD%A4%E3%82%86%EF%BD%A4%E5%8F%8B%E3%81%98%E3%82%87%E2%80%A6%E2%80%A6"><a class="headerlink" href="#4.+Promise%EF%BD%A4%E3%82%86%EF%BD%A4%E5%8F%8B%E3%81%98%E3%82%87%E2%80%A6%E2%80%A6">4. Promiseï½¤ã‚†ï½¤å‹ã˜ã‚‡â€¦â€¦</a></h1>
<p>ã‚¹ãƒ¬ãƒ—ã§ããŸã—ã‚‚ã†å‹¢ã„ã§<code>Promise</code>å®Ÿè£…ã‚„ã£ã¡ã‚ƒã†ã‹ãƒ¼!!
ã¨æ€ã£ãŸã‚“ã§ã™ãŒãƒ€ãƒ¡ãã†ãªã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã—ãŸï½¡</p>
<p><code>new Promise</code>ãŒè¿”ã™å®Ÿè¡Œæ™‚ã®å€¤ã¨ã—ã¦<code>RPromise</code>ã‚’è¿½åŠ ã—ã¾ã™ï½¡
<code>Promise</code>ãŒã‚¹ãƒ¬ãƒ—ã«ãƒ„ãƒƒã‚³ã¾ã‚Œã‚‹ã®ã§ï½¤ã‚¹ãƒ¬ãƒƒãƒ‰ã«å¯¾å¿œã™ã‚‹UUIDã‚’è¿”ã™ï½¡
ã¨ã“ã‚ã§UUIDã¯å†…éƒ¨ã§<code>core_kernel</code>ã‚’ä½¿ã£ã¦ã„ã‚‹ï½¡</p>
<div class="highlight">
<span class="listing-name">runtime_repr.ml</span><pre><code class="language-ocaml" data-lang="ocaml"><span class="ow">and</span> <span class="n">runtime_value</span> <span class="o">=</span>
  <span class="o">......</span>
  <span class="o">|</span> <span class="nc">RPromise</span> <span class="k">of</span> <span class="nn">Uuid</span><span class="p">.</span><span class="n">t</span>
</code></pre>
</div>
<p>é€†ã«ã‚¹ãƒ¬ãƒ—ã«ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã¨ãã‚Œã®UUIDã®tupleã‚’çªã£è¾¼ã‚€ï½¡
å¯¾å¿œã™ã‚‹UUIDã‚’è¿”ã™ã“ã¨ã§ï½¤<code>await</code>ã§ã‚¹ãƒ¬ãƒ—ã‹ã‚‰å¯¾å¿œã™ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä¸€æ°—ã«èµ°ã‚‰ã›ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ï½¡</p>
<div class="highlight">
<span class="listing-name">thread_pool.ml</span><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">type</span> <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="nn">Uuid</span><span class="p">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">thread_status</span><span class="p">)</span> <span class="nn">Queue</span><span class="p">.</span><span class="n">t</span>

<span class="k">let</span> <span class="n">enqueue</span> <span class="n">th</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">uuid</span> <span class="o">=</span> <span class="nn">Uuid</span><span class="p">.</span><span class="n">create</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Queue</span><span class="p">.</span><span class="n">enqueue</span> <span class="n">q</span> <span class="p">(</span><span class="n">uuid</span><span class="o">,</span> <span class="nc">Pending</span> <span class="n">th</span><span class="p">)</span> <span class="k">in</span>
  <span class="n">uuid</span>
<span class="p">;;</span>

<span class="k">let</span> <span class="n">wait</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">go</span> <span class="n">th</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">th</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Pending</span> <span class="n">th'</span> <span class="o">-&gt;</span> <span class="n">go</span> <span class="n">th'</span>
    <span class="o">|</span> <span class="nc">Done</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">r</span>
  <span class="k">in</span>
  <span class="k">fun</span> <span class="n">id</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="n">o_th</span> <span class="o">=</span> <span class="nn">Queue</span><span class="p">.</span><span class="n">find</span> <span class="o">~</span><span class="n">f</span><span class="o">:</span><span class="p">(</span><span class="k">fun</span> <span class="p">(</span><span class="n">id'</span><span class="o">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">Uuid</span><span class="p">.</span><span class="n">equal</span> <span class="n">id</span> <span class="n">id'</span><span class="p">)</span> <span class="n">q</span> <span class="k">in</span>
    <span class="k">match</span> <span class="n">o_th</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="p">(</span><span class="n">_</span><span class="o">,</span> <span class="n">ts</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="p">(</span><span class="k">match</span> <span class="n">ts</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Done</span> <span class="n">rtv</span> <span class="o">-&gt;</span> <span class="n">rtv</span>
      <span class="o">|</span> <span class="nc">Pending</span> <span class="n">thread</span> <span class="o">-&gt;</span> <span class="n">go</span> <span class="n">thread</span><span class="p">)</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"no such id"</span>
<span class="p">;;</span>
</code></pre>
</div>
<p>ã‚ã¨ã¯ã‚„ã‚‹ã ã‘!w
ã¨æ€ã£ãŸã®ã§ã™ãŒâ€¦â€¦</p>
<div class="highlight">
<span class="listing-name">eval_exp</span><pre><code class="language-ocaml" data-lang="ocaml">  <span class="o">......</span>
  <span class="o">|</span> <span class="nc">Promise</span> <span class="n">p</span> <span class="o">-&gt;</span>
    <span class="p">(</span><span class="k">match</span> <span class="n">p</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Constructor</span> <span class="n">exp</span> <span class="o">-&gt;</span>
      <span class="p">(</span><span class="k">match</span> <span class="n">exp</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Value</span> <span class="p">(</span><span class="nc">Fun</span> <span class="p">(</span><span class="n">_</span><span class="o">,</span> <span class="n">_</span><span class="p">)</span> <span class="k">as</span> <span class="n">fn</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="n">exp'</span> <span class="o">=</span> <span class="nc">Call</span> <span class="p">(</span><span class="nc">Value</span> <span class="n">fn</span><span class="o">,</span> <span class="p">[</span> <span class="nc">Value</span> <span class="nc">Unit</span> <span class="p">])</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">uuid</span> <span class="o">=</span> <span class="nn">Thread_pool</span><span class="p">.</span><span class="n">enqueue</span> <span class="o">@@</span> <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="nc">Done</span> <span class="p">(</span><span class="n">eval_exp</span> <span class="n">env</span> <span class="n">exp'</span><span class="p">)</span> <span class="k">in</span>
        <span class="nc">RPromise</span> <span class="n">uuid</span>
      <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"this is not callable object"</span><span class="p">)</span>
    <span class="o">|</span> <span class="nc">Wait</span> <span class="n">exp</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">rtv</span> <span class="o">=</span> <span class="n">eval_exp</span> <span class="n">env</span> <span class="n">exp</span> <span class="k">in</span>
      <span class="p">(</span><span class="k">match</span> <span class="n">rtv</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">RPromise</span> <span class="n">uuid</span> <span class="o">-&gt;</span> <span class="nn">Thread_pool</span><span class="p">.</span><span class="n">wait</span> <span class="n">uuid</span>
      <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">rtv</span><span class="p">))</span>
</code></pre>
</div>
<p>ã†ã¾ãã„ã‹ãªã„ï½¡
ã¨ã‚Šã‚ãˆãšï½¤<code>Promise(Constructor(-))</code>ã«æ¸¡ã•ã‚Œã‚‹ã‚‚ã®ãŒé–¢æ•°ãƒ¼ã•ã‚‰ã«ä»Šå›ã¯æ‰‹æŠœãã§é–¢æ•°<em>ãƒªãƒ†ãƒ©ãƒ«</em>ã«åˆ¶é™ã—ã¦ã„ã‚‹ãƒ¼ã®å ´åˆã«ãã‚Œã‚’ã‚¹ãƒ¬ãƒƒãƒ‰ã«ã—ã¦ã‚¹ãƒ¬ãƒ—ã«çªã£è¾¼ã¿ï½¤å¯¾å¿œã™ã‚‹UUIDã‚’<code>RPromise</code>ã«åŒ…ã‚“ã§å®Ÿè¡Œæ™‚ã®å€¤ã«ã—ã¦è¿”ã™ï½¡
<code>Wait</code>ã¯ãã®ã¾ã¾<code>Thread_pool.wait</code>ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã«ãªã£ã¦ã„ã‚‹ï½¡
<code>Promise</code>ä»¥å¤–ã‚’<code>await</code>ã™ã‚‹ã¨ãã¯JSã¨åŒã˜ã‚ˆã†ã«ã‚µãƒƒã¨æµã™ï½¡
ãã†ã„ãˆã°ã“ã®ã‚µãƒ–ã‚»ãƒƒãƒˆã«ã¯é…åˆ—ãŒãªã„ã®ã§<code>Promise(All(-))</code>ã¯ã—ã‚Œã£ã¨æ¶ˆã—ãŸï½¡</p>
<p>ã—ã‹ã—ã“ã‚Œã§ã¯ã†ã¾ãã„ã‹ãªã„ï½¡
<code>Wait</code>ãŒã†ã¾ãproimiseã‚’å¾…ã£ã¦ãã‚Œãªã„ï½¡
ã“ã‚Œã¯ã¾ã‚ã¾ã‚æ¤œè¨ãŒã¤ã„ã¦ã„ã‚‹ï½¡</p>
<p>JSã®<code>Promise</code>ã‚’æ€ã„å‡ºã—ã¦ã¿ã‚‹ã¨ï½¤</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">hello</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">resolve</span><span class="p">();</span>
  <span class="p">},</span> <span class="mi">500</span><span class="p">));</span>
  <span class="k">await</span> <span class="nx">promise</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">world</span><span class="dl">"</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">f</span><span class="p">();</span>
</code></pre></div>
<p>ãã†ã„ãˆã°<code>resolve</code>ã¨ã‹ã„ã†ã‚„ã¤ã‚ã£ãŸãªï½¡
ä¸Šè¨˜ã®JSãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§<code>resolve</code>ã‚’<code>setTimeout</code>å†…ã§å‘¼ã°ãªã„ã¨çµæ§‹é¢ç™½ã„çµæœãŒå¾—ã‚‰ã‚Œã‚‹ï½¡
â€¦â€¦ã©ã†ã§ã™ã‹? çµæœã¯500ãƒŸãƒªç§’ã®æ²ˆé»™ã®ã®ã¡ã«<code>hello</code>ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã®ã¿ã§ã‚ã‚‹ï½¡
<code>await</code>ã¯ä½•ãªã®ã‹ã‚’æ€ã„å‡ºã—ã¦ã¿ã‚‹ã¨ï½¤<code>await</code>ã‚’ä½¿ã‚ãªã‘ã‚Œã°ä¸Šè¨˜ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰å½¢ã§ãã‚‹ï½¡</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">hello</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">resolve</span><span class="p">();</span>
  <span class="p">},</span> <span class="mi">500</span><span class="p">))</span>
  <span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">world</span><span class="dl">"</span><span class="p">));</span>
<span class="p">}</span>

<span class="nx">f</span><span class="p">();</span>
</code></pre></div>
<p>ã¾ã‚‹ã§<code>call/cc</code>ã ãªï½¡
å®Ÿéš›ã®ã¨ã“ã‚ã¯ç¾åœ¨ã®scopeå†…ã®é™å®šç¶™ç¶šã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã®ã ãŒï½¡</p>
<p>ãµãƒ¼ã‚€ï½¤æŒ¯ã‚Šè¿”ã‚‹ã¾ã§ã‚‚ãªãã“ã®ã‚ˆã†ãªæŒ™å‹•ã«ã¯ãªã£ã¦ãªã„ï½¡
å‰å›ã¯ï½¢statementã®æ®‹ã‚Šã“ããŒç¶™ç¶šã§ã‚ã‚‹ï½£ã¨è¨€ã£ãŸãŒï½¤ã¾ã•ã«ã“ã‚Œã‚’åˆ©ç”¨ã™ã¹ãã§ï½¤<code>Promise</code>å†…ã§<code>resolve</code>ã®ã‚ˆã†ãªã‚‚ã®ã‚’å‘¼ã‚“ã ã‚‰"ã“ã®æ®‹ã‚Šã®statement"ã‚’è©•ä¾¡ã™ã‚Œã°ã‚ˆã„ï½¡</p>
<p>ã“ã‚Œã¯æ¬¡å›ã ãªï½¡
æœ¨æ›œã¯æœ‰çµ¦å–ã£ã¦ãªã„ã‚“ã§ã™ãŒä»Šã£ã¦æœ¨æ›œã®åˆå‰4æ™‚â€¦â€¦</p>
<h1 id="5.+%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><a class="headerlink" href="#5.+%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB">5. ãŠã‚ã‚Šã«</a></h1>
<p>pending</p>
          </div>
        </article>

      </div>
    </div>
    <footer>
      <div class="pagination btn-group" style="text-align: center; font-family: 'Comfortaa';">
        <a class="btn prev" href="/2020/05/04/nikkan-promise2.html" title="æ—¥åˆŠPromise(2) ã¨ã‚Šã‚ãˆãšPromiseã‚’ç½®ã„ã¦ã‘ã¼ã‚Šã«ã—ã¦è©•ä¾¡å™¨ã‚’å®Ÿè£…ã™ã‚‹">â† Prev</a>
        /<a class="btn" href="/">Top</a>/
        <a class="btn next" href="/2020/05/08/nikkan-promise4.html" title="æ—¥åˆŠPromise(4) ç¶™ç¶šãƒ¢ãƒŠãƒ‰ã§æ˜æ—¥ã¸ã®å¸ƒçŸ³">Next â†’</a>
      </div>
    </footer>

  </body>
</html>
