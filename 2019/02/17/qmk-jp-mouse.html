<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html;charset=UTF-8" http-equiv="content-type"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="format-detection" content="telephone=no"/>

    <title>qmk_firmwareで日本語配列 / マウスエミュレーションを頑張る - lilyum ensemble</title>
    <meta itemprop="name" content="qmk_firmwareで日本語配列 / マウスエミュレーションを頑張る - lilyum ensemble"/>
    <meta name="keywords" content="ErgoDox,QMK"/>
    <meta name="thumbnail" content="/pictures/github_icon.png"/>
    <meta itemprop="image" content="/pictures/github_icon.png"/>

    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:site" content="lilyum ensemble"/>
    <meta name="twitter:title" content="qmk_firmwareで日本語配列 / マウスエミュレーションを頑張る - lilyum ensemble"/>
    <meta name="twitter:url" content="/2019/02/17/qmk-jp-mouse.html"/> 
    <meta name="twitter:text:description" content="1. はじめにqmk_firmware(以降qmkと省略)といえば最近の自作キーボードにおけるファームウェアの主流ですね｡ちょっとしたことなら簡単にできますが､少し踏み込んだことをやろうとすると..."/>
    <meta name="twitter:image" content="https://nymphium.github.io/pictures/github_icon.png"/>
    <meta name="twitter:image:src" content="https://nymphium.github.io/pictures/github_icon.png"/>

    <link rel="icon" type="image/x-icon" href="/favicon.ico"/>
    <link rel="stylesheet" href="/css/main.css"/>
    <link rel="alternate" type="application/rss+xml" title="lilyum ensemble" href="/feed.xml"/>
    <link href="https://fonts.googleapis.com/css?family=Comfortaa:300%7CDroid+Sans+Mono%7CCrimson+Text:400,400i" rel="stylesheet"/>
<!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="qmk_firmwareで日本語配列 / マウスエミュレーションを頑張る" />
<meta name="author" content="Satoru Kawahara" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="1. はじめに qmk_firmware(以降qmkと省略)といえば最近の自作キーボードにおけるファームウェアの主流ですね｡ ちょっとしたことなら簡単にできますが､少し踏み込んだことをやろうとするとテクが必要となる印象です｡" />
<meta property="og:description" content="1. はじめに qmk_firmware(以降qmkと省略)といえば最近の自作キーボードにおけるファームウェアの主流ですね｡ ちょっとしたことなら簡単にできますが､少し踏み込んだことをやろうとするとテクが必要となる印象です｡" />
<link rel="canonical" href="https://nymphium.github.io/2019/02/17/qmk-jp-mouse.html" />
<meta property="og:url" content="https://nymphium.github.io/2019/02/17/qmk-jp-mouse.html" />
<meta property="og:site_name" content="lilyum ensemble" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-02-17T00:00:00+09:00" />
<script type="application/ld+json">
{"dateModified":"2019-02-17T00:00:00+09:00","datePublished":"2019-02-17T00:00:00+09:00","@type":"BlogPosting","headline":"qmk_firmwareで日本語配列 / マウスエミュレーションを頑張る","mainEntityOfPage":{"@type":"WebPage","@id":"https://nymphium.github.io/2019/02/17/qmk-jp-mouse.html"},"author":{"@type":"Person","name":"Satoru Kawahara"},"description":"1. はじめに qmk_firmware(以降qmkと省略)といえば最近の自作キーボードにおけるファームウェアの主流ですね｡ ちょっとしたことなら簡単にできますが､少し踏み込んだことをやろうとするとテクが必要となる印象です｡","url":"https://nymphium.github.io/2019/02/17/qmk-jp-mouse.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta property="og:image" content="/pictures/github_icon.png"/>
  </head>

  <body>
    <header class="site-header">
      <div class="wrapper" style="font-family: 'Comfortaa';">
        <a class="site-title" href="/">lilyum ensemble</a>
        <nav class="site-nav">
          <div class="trigger">
            <a class="page-link" href="/aboutme.html">About</a>
            <a class="page-link" href="/slide.html">Slides</a>
            <a class="page-link" href="/tags.html">Tags</a>
          </div>
        </nav>
      </div>
    </header>

    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
          <header class="post-header">
            <h1 class="post-title" itemprop="name headline">qmk_firmwareで日本語配列 / マウスエミュレーションを頑張る</h1>
            <span class="post-meta">
              <time datetime="2019-02-17T00:00:00+09:00" itemprop="datePublished">Feb 17, 2019</time>
              <a class="src" href="https://github.com/nymphium/nymphium.github.io/blob/source/_posts%2F2019-02-17-qmk-jp-mouse.md" target="_blank" rel="noopener noreferrer">src</a>
              <p class="tags">tag: {<span class="tag"><a href="/tags.html#ErgoDox-ref">ErgoDox</a></span><span></span> <span class="tag"><a href="/tags.html#QMK-ref">QMK</a></span>}</p>
              <a class="twitter-share-button" href="https://twitter.com/intent/tweet" target="_blank" rel="noopener noreferrer">Tweet</a> 
            </span>
            <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
            <script type="text/javascript" src="/js/GithubRepoWidget.min.js"></script>
            <script type="text/javascript">setTimeout(GithubRepoWidget.init, 3000);</script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" integrity="sha384-9tPv11A+glH/on/wEu99NVwDPwkMQESOocs/ZGXPoIiLE8MU/qkqUcZ3zzL+6DuH" crossorigin="anonymous">
            <!-- The loading of KaTeX is deferred to speed up page rendering -->
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.js" integrity="sha384-U8Vrjwb8fuHMt6ewaCy8uqeUXv4oitYACKdB0VziCerzt011iQ/0TqlSlv8MReCm" crossorigin="anonymous"></script>
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/contrib/auto-render.min.js" integrity="sha384-aGfk5kvhIq5x1x5YdvCp4upKZYnA8ckafviDpmWEKp4afOZEqOli7gqSnh8I6enH" crossorigin="anonymous"></script>
            <script>
document.addEventListener("DOMContentLoaded", function(){
  renderMathInElement
    ( document.body
    , { delimiters: [ {left: "$$",  right: "$$",  display: true}
                    , {left: "\\(", right: "\\)", display: false}
                    , {left: "\\[", right: "\\]", display: true}
                    , {left: "[[",  right: "]]",  display: true}
                    , {left: "$",   right: "$",   display: false} ]
    , })});
            </script>
          </header>
          <div class="post-content" itemprop="articleBody">
<h1 id="1.+%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><a class="headerlink" href="#1.+%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">1. はじめに</a></h1>
<p>qmk_firmware(以降qmkと省略)といえば最近の自作キーボードにおけるファームウェアの主流ですね｡
ちょっとしたことなら簡単にできますが､少し踏み込んだことをやろうとするとテクが必要となる印象です｡</p>
<p>今回は､筆者がErgoDox EZでおこなった設定を例に挙げ､いくつか踏み込んだ設定についてみていきます｡</p>
<p>ちなみに軸はKailh Goldにしました｡
丁度いいカチカチとしたクリック感が良いです｡</p>
<p>筆者の設定は､以下のURLから参照できます｡
<a href="https://github.com/Nymphium/qmk_firmware/tree/nymphium/keyboards/ergodox_ez/keymaps/nymphium" target="_blank" rel="noopener noreferrer">https://github.com/Nymphium/qmk_firmware/tree/nymphium/keyboards/ergodox_ez/keymaps/nymphium</a></p>
<h1 id="2.+%E6%97%A5%E6%9C%AC%E8%AA%9E%E9%85%8D%E5%88%97"><a class="headerlink" href="#2.+%E6%97%A5%E6%9C%AC%E8%AA%9E%E9%85%8D%E5%88%97">2. 日本語配列</a></h1>
<p>ErgoDox EZでも日本語配列にしたくなります｡
今回は､Shift+数字を日本語配列にすることを考えます｡</p>
<p></p>
<center>
表. 対応

<table>
<thead>
<tr>
<th style="text-align: center">
<code>Shift</code>+</th>
<th style="text-align: center">英語配列</th>
<th style="text-align: center">日本語配列</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center"><code>2</code></td>
<td style="text-align: center"><code>@</code></td>
<td style="text-align: center"><code>"</code></td>
</tr>
<tr>
<td style="text-align: center"><code>6</code></td>
<td style="text-align: center"><code>^</code></td>
<td style="text-align: center"><code>&amp;</code></td>
</tr>
<tr>
<td style="text-align: center"><code>7</code></td>
<td style="text-align: center"><code>&amp;</code></td>
<td style="text-align: center"><code>'</code></td>
</tr>
<tr>
<td style="text-align: center"><code>8</code></td>
<td style="text-align: center"><code>*</code></td>
<td style="text-align: center"><code>(</code></td>
</tr>
<tr>
<td style="text-align: center"><code>9</code></td>
<td style="text-align: center"><code>(</code></td>
<td style="text-align: center"><code>)</code></td>
</tr>
<tr>
<td style="text-align: center"><code>0</code></td>
<td style="text-align: center"><code>)</code></td>
<td style="text-align: center">(none)</td>
</tr>
</tbody>
</table>

<p></p>
</center>
<h1 id="%E5%AE%9F%E8%A3%85"><a class="headerlink" href="#%E5%AE%9F%E8%A3%85">実装</a></h1>
<p>やることはズバリ､日本語配列の記号を入力するレイヤを作り､<code>process_record_user</code>関数でshiftキーの挙動を変えます｡</p>
<p>まずは記号を出す用のレイヤ<code>_SHIFT</code>を定義します｡
レイアウトはお手元のキーボードに適宜読み替えてください｡</p>
<div class="highlight">
<span class="listing-name">keycode.c</span><pre><code class="language-c" data-lang="c"><span class="cp">#define _SHIFT 3
</span><span class="cm">/* ↑レイヤは`keymaps`という配列に格納されており､
 * インデックスは慣例的にレイヤ名(適当に考える)をマクロとして参照する
*/</span>

<span class="c1">// ......</span>

<span class="p">,[</span><span class="n">_SHIFT</span><span class="p">]</span> <span class="o">=</span> <span class="n">LAYOUT_ergodox</span><span class="p">(</span>
  <span class="c1">// left hand</span>
  <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">KC_DQT</span><span class="p">,</span>  <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span>
  <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span>
  <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span>
  <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span>
  <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span>

                                               <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span>
                                                        <span class="n">_______</span><span class="p">,</span>
                                      <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span>

  <span class="c1">// right hand</span>
  <span class="c1">// Shift+0はnopにしてもしなくてもよい</span>
  <span class="n">KC_AMPR</span><span class="p">,</span> <span class="n">KC_QUOT</span><span class="p">,</span> <span class="n">KC_LPRN</span><span class="p">,</span> <span class="n">KC_RPRN</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span>
  <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span>
  <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span>
  <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span>
  <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span>

  <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span>
  <span class="n">_______</span><span class="p">,</span>
  <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span><span class="p">,</span> <span class="n">_______</span>
<span class="p">)</span>
</code></pre>
</div>
<p>続いて<code>process_record_user</code>関数でShiftキーの挙動を変えます｡
具体的には押下中に<code>_SHIFT</code>レイヤに切り替えることをやります｡</p>
<div class="highlight">
<span class="listing-name">NGその1</span><pre><code class="language-c" data-lang="c"><span class="n">bool</span> <span class="nf">process_record_user</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">keycode</span><span class="p">,</span> <span class="n">keyrecord_t</span> <span class="o">*</span><span class="n">record</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">keycode</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// ------------- キーコードで何を押下したかをスイッチ</span>
    <span class="k">case</span> <span class="n">KC_LSFT</span><span class="p">:</span> <span class="c1">// ---------------- 左シフト</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">pressed</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 押下中</span>
        <span class="n">register_code</span><span class="p">(</span><span class="n">KC_LSFT</span><span class="p">);</span> <span class="c1">// -- 左シフトを入力</span>
        <span class="n">layer_on</span><span class="p">(</span><span class="n">_SHIFT</span><span class="p">);</span> <span class="c1">// -------- レイヤーのスイッチ</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// ------------------- 離した</span>
        <span class="n">layer_off</span><span class="p">(</span><span class="n">_SHIFT</span><span class="p">);</span> <span class="c1">// ------- レイヤー戻る</span>
        <span class="n">unregister_code</span><span class="p">(</span><span class="n">KC_LSFT</span><span class="p">);</span> <span class="c1">// 入力解除</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// -------------- 長押しで連続して入力しない</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span> <span class="c1">// ------------------- デフォルト</span>
<span class="p">}</span>
</code></pre>
</div>
<p><code>_SHIFT</code>レイヤに切り替えて､同時に<code>KC_LSFT</code>も入力しています｡
これによって､<code>_______</code>( <code>KC_TRANS</code> のalias)部分を同時に押下すると､前のレイヤのキーをShiftで修飾して入力とします｡</p>
<p>一瞬良い感じに見えますが…??
これで<code>Shift + 7</code>を押下するとおそらく <strong>ダブルクオート</strong> が入力されるはずです｡
なんでや念という感じですか､あるいは既に気づいてる方も居るかもしれません｡
上記の<code>process_record_user</code>による切り替えで､<code>_SHIFT</code>レイヤに切り替え､さらに<code>KC_LSFT</code>も入力しているのが問題です｡
<code>KC_LSFT</code>を入力しないと前のレイヤのキーはShift修飾できません｡</p>
<p>アドホックですが､解法を示しますと､<code>KC_QUOT</code>のようなキーを<code>_SHIFT</code>レイヤで入力し､かつShiftを入力したくない場合は､<code>KC_LSFT</code>の入力を解除してからキーを入力し､そのキーを入力解除してから<code>KC_LSFT</code>を再入力する､ということをします｡</p>
<p><code>KC_QUOT</code>を入力することを例に挙げると､次のような流れになります｡</p>
<ol>
<li>ユーザ: Shiftキーを押下</li>
<li>qmk   : <code>_SHIFT</code>にレイヤ切り替え+<code>KC_LSFT</code>入力</li>
<li>ユーザ: 7キーを押下</li>
<li>qmk   : <code>KC_LSFT</code>の入力解除</li>
<li>qmk   : <code>KC_QUOT</code>を入力</li>
<li>qmk   : <code>KC_QUOT</code>を入力解除</li>
<li>qmk   : <code>KC_LSFT</code>を入力</li>
</ol>
<p>なるほどですね｡
あとはやるだけ</p>
<div class="highlight">
<span class="listing-name">NGその2</span><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">bool</span> <span class="n">shift</span><span class="p">;</span> <span class="c1">// Shiftキーを離してない場合のフラグ</span>

<span class="n">bool</span> <span class="nf">process_record_user</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">keycode</span><span class="p">,</span> <span class="n">keyrecord_t</span> <span class="o">*</span><span class="n">record</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">keycode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">KC_LSFT</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">pressed</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">register_code</span><span class="p">(</span><span class="n">KC_LSFT</span><span class="p">);</span>
        <span class="n">layer_on</span><span class="p">(</span><span class="n">_SHIFT</span><span class="p">);</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="n">layer_off</span><span class="p">(</span><span class="n">_SHIFT</span><span class="p">);</span>
        <span class="n">unregister_code</span><span class="p">(</span><span class="n">KC_LSFT</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">KC_QUOT</span><span class="p">:</span> <span class="c1">// 制御するのは7じゃなくて入力したい`KC_QUOT`</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">pressed</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">unregister_code</span><span class="p">(</span><span class="n">KC_LSFT</span><span class="p">);</span>
        <span class="n">register_code</span><span class="p">(</span><span class="n">keycode</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">shift</span><span class="p">)</span> <span class="n">register_code</span><span class="p">(</span><span class="n">KC_LSFT</span><span class="p">);</span>
        <span class="n">unregister_code</span><span class="p">(</span><span class="n">keycode</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span> <span class="c1">// 長押しで入力をリピートしたいので`true`</span>

  <span class="c1">// ......</span>
</code></pre>
</div>
<p>Shiftを押下し､<code>7</code>を押下し､<code>7</code>を離すがShiftは離さない場合の制御のために<code>shift</code>というフラグを追加しました｡
これでいいかというとそうではなく､<code>Ctrl+Shift+7</code>みたいなキーマップをアプリケーションで使うかもしれませんが､そういうときに<code>KC_LSFT</code>を入力してないため無効となってしまいます｡
はい解法は以下の実装になります｡</p>
<div class="highlight">
<span class="listing-name">OK</span><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">bool</span> <span class="n">shift</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">modkey</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// 修飾キーを押下中のフラグ</span>

<span class="n">bool</span> <span class="nf">process_record_user</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">keycode</span><span class="p">,</span> <span class="n">keyrecord_t</span> <span class="o">*</span><span class="n">record</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">keycode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">KC_LGUI</span><span class="p">:</span> <span class="c1">// Winキー</span>
    <span class="k">case</span> <span class="n">KC_LALT</span><span class="p">:</span> <span class="c1">// 左Alt</span>
    <span class="k">case</span> <span class="n">KC_LCTRL</span><span class="p">:</span> <span class="c1">// 左Ctrl</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">pressed</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">register_code</span><span class="p">(</span><span class="n">keycode</span><span class="p">);</span>
        <span class="n">modkey</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">unregister_code</span><span class="p">(</span><span class="n">keycode</span><span class="p">);</span>
        <span class="n">modkey</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">KC_LSFT</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">pressed</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">register_code</span><span class="p">(</span><span class="n">KC_LSFT</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modkey</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 修飾キー押下時はレイヤーを切り替えない</span>
          <span class="n">shift</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
          <span class="n">layer_on</span><span class="p">(</span><span class="n">_SHIFT</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">shift</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">shift</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
          <span class="n">layer_off</span><span class="p">(</span><span class="n">_SHIFT</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">unregister_code</span><span class="p">(</span><span class="n">KC_LSFT</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">KC_QUOT</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">pressed</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">unregister_code</span><span class="p">(</span><span class="n">KC_LSFT</span><span class="p">);</span>
        <span class="n">register_code</span><span class="p">(</span><span class="n">keycode</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">shift</span><span class="p">)</span> <span class="n">register_code</span><span class="p">(</span><span class="n">KC_LSFT</span><span class="p">);</span>
        <span class="n">unregister_code</span><span class="p">(</span><span class="n">keycode</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

  <span class="c1">// ......</span>
</code></pre>
</div>
<p>コレで完了です｡</p>
<h1 id="3.+%E3%83%9E%E3%82%A6%E3%82%B9%E3%81%AE%E3%82%A8%E3%83%9F%E3%83%A5%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3"><a class="headerlink" href="#3.+%E3%83%9E%E3%82%A6%E3%82%B9%E3%81%AE%E3%82%A8%E3%83%9F%E3%83%A5%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3">3. マウスのエミュレーション</a></h1>
<p>なんとqmkではマウスのエミュレーションができます｡
これまではThinkPadキーボードを使っていた筆者もそれなりに満足してます<sup id="fnref1" title="筆者はThinkPadキーボードのトラックポイントならMinecraftくらいまでならやってましたが､流石にqmkのマウスエミュレーションではウェブブラウジングくらいまでしかできません｡逆にマウスでゲームしないのならマウスとして充分機能します｡ "><a href="#fn1">1</a></sup>｡</p>
<p>さて､さっそく悲報ですが､qmkは何秒キーを押下したかのような情報は取得できません｡
したがって､ThinkPadのように､中クリック直後の寸瞬のうちにカーソルを上下左右に動かすとホイールアクションになる､ということはできません｡
今回は､中クリックに若干秒でホイールアクションに切り替わる､という方法でいきます｡
あまり違いがわからないかもしれませんが､今回実装する後者では中クリック押下即離しても一瞬ホイールアクションに切り替わります｡</p>
<h2 id="%E5%AE%9F%E8%A3%85"><a class="headerlink" href="#%E5%AE%9F%E8%A3%85">実装</a></h2>
<p>マウスエミュレーションを有効にするには､まずruls.mkで<code>MOUSEKEY_ENABLE = yes</code>にします｡
ErgoDox EZはデフォルトで<code>yes</code>になってます｡</p>
<p>マウスエミュレーションは<code>_MOUSE</code>レイヤ､ホイールアクションを<code>_WHEEL</code>でおこないます｡
<code>MOUSE</code>キー押下中にマウスエミュレーションをおこなう(<code>_MOUSE</code>レイヤに切り替え)ようにし､<code>MIDDLE</code>キー押下時に中クリック/ホイール(<code>_WHEEL</code>レイヤに切り替え)にします｡</p>
<p>ユーザ定義キーは<code>custom_keycodes</code>で表現します｡</p>
<div class="highlight">
<span class="listing-name">keycode.c</span><pre><code class="language-c" data-lang="c"><span class="cp">#define _BASE 0
</span><span class="c1">// ......</span>
<span class="cp">#define _MOUSE 4
#define _WHEEL 5
</span>
<span class="c1">// MODEキーで_MODEレイヤをonにするマクロ</span>
<span class="cp">#define TMP_MODE(MODE) \
    case MODE: \
      if (record-&gt;event.pressed) { \
        layer_on(_##MODE); \
      } else { \
        layer_off(_##MODE); \
      } \
      return false; \

</span><span class="k">enum</span> <span class="n">custom_keycodes</span> <span class="p">{</span>
  <span class="n">BASE</span> <span class="o">=</span> <span class="n">SAFE_RANGE</span><span class="p">,</span>
  <span class="n">MOUSE</span><span class="p">,</span>
  <span class="n">MIDDLE</span><span class="p">,</span>
<span class="p">};</span>

<span class="c1">// ......</span>

<span class="p">[</span><span class="n">_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">LAYOUT_ergodox</span><span class="p">(</span>
  <span class="c1">// ......</span>
  <span class="n">MOUSE</span><span class="p">,</span> <span class="c1">// お好きなキーで切り替えてください</span>
  <span class="c1">// ......</span>
<span class="p">)</span>

<span class="c1">// ......</span>

<span class="p">,[</span><span class="n">_MOUSE</span><span class="p">]</span> <span class="o">=</span> <span class="n">LAYOUT_ergodox</span><span class="p">(</span>
  <span class="c1">// left hand</span>
  <span class="n">___</span><span class="p">,</span>    <span class="n">___</span><span class="p">,</span>   <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>
  <span class="n">___</span><span class="p">,</span>    <span class="n">___</span><span class="p">,</span>   <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>
  <span class="n">___</span><span class="p">,</span>    <span class="n">___</span><span class="p">,</span>   <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>
  <span class="n">___</span><span class="p">,</span>    <span class="n">___</span><span class="p">,</span>   <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>
  <span class="c1">//               左       中      右</span>
  <span class="n">___</span><span class="p">,</span>    <span class="n">___</span><span class="p">,</span>   <span class="n">KC_BTN1</span><span class="p">,</span> <span class="n">MIDDLE</span><span class="p">,</span> <span class="n">KC_BTN2</span><span class="p">,</span>

                                    <span class="n">___</span><span class="p">,</span> <span class="n">___</span><span class="p">,</span>
                                         <span class="n">___</span><span class="p">,</span>
                               <span class="n">___</span><span class="p">,</span> <span class="n">___</span><span class="p">,</span> <span class="n">___</span><span class="p">,</span>

  <span class="c1">// right hand</span>
  <span class="n">___</span><span class="p">,</span> <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span> <span class="n">___</span><span class="p">,</span> <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>
  <span class="n">___</span><span class="p">,</span> <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span> <span class="n">___</span><span class="p">,</span> <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>
  <span class="c1">//     ←         ↓      ↑        →</span>
       <span class="n">KC_MS_L</span><span class="p">,</span> <span class="n">KC_MS_D</span><span class="p">,</span> <span class="n">KC_MS_U</span><span class="p">,</span> <span class="n">KC_MS_R</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>
  <span class="n">___</span><span class="p">,</span> <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span> <span class="n">___</span><span class="p">,</span> <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span>
  <span class="n">___</span><span class="p">,</span> <span class="n">___</span><span class="p">,</span>  <span class="n">___</span><span class="p">,</span> <span class="n">___</span><span class="p">,</span> <span class="n">___</span><span class="p">,</span>

  <span class="n">___</span><span class="p">,</span> <span class="n">___</span><span class="p">,</span>
  <span class="n">___</span><span class="p">,</span>
  <span class="n">___</span><span class="p">,</span> <span class="n">___</span><span class="p">,</span> <span class="n">___</span>
<span class="p">)</span>

<span class="c1">// ......</span>

<span class="n">bool</span> <span class="nf">process_record_user</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">keycode</span><span class="p">,</span> <span class="n">keyrecord_t</span> <span class="o">*</span><span class="n">record</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">keycode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">MIDDLE</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">pressed</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">register_code</span><span class="p">(</span><span class="n">KC_BTN3</span><span class="p">);</span> <span class="c1">// -- 中クリックを入力しておく</span>

        <span class="c1">// -------------------------- とりあえず200ミリ秒待つ</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">timer_elapsed</span><span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">time</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{}</span>

        <span class="n">unregister_code</span><span class="p">(</span><span class="n">KC_BTN3</span><span class="p">);</span> <span class="c1">// `KC_BTN3`を解放</span>
        <span class="n">layer_on</span><span class="p">(</span><span class="n">_WHEEL</span><span class="p">);</span> <span class="c1">// ------- _WHEELレイヤ切り替え</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">layer_off</span><span class="p">(</span><span class="n">_WHEEL</span><span class="p">);</span> <span class="c1">// ------ 戻す</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

    <span class="n">TMP_MODE</span><span class="p">(</span><span class="n">MOUSE</span><span class="p">);</span> <span class="c1">// ------------ 押下中だけMOUSEレイヤ</span>

    <span class="c1">// ......</span>
</code></pre>
</div>
<p>実装だけになったのであまりおもしろくないですね｡
<code>while</code>で空のループを回してるのはすこしドキッとします｡
<code>timer_elapsed</code>関数で､押下されてからの秒数を取得してます｡</p>
<p>これなら先述の､ “qmkは何秒キーを押下したかのような情報” を取得していろいろできるような気が一瞬します｡
しかし残念ながらそうではなく､これは押下イベントのタイムスタンプが入ったレコードであり､何秒押下しているかではありません｡
また､<code>record-&gt;event.pressed</code>も動的に変わるわけではなく､押下/離したというイベントが降ってくるので､どちらかという情報が格納されているだけです｡</p>
<p>よもやま話が挟まりましたが､これで全てです｡
<code>MIDDLE</code>の処理を見ての通り､一瞬押下してすぐ離そうがなんだろうが<code>_WHEEL</code>レイヤに切り替わるような実装になってます｡</p>
<h1 id="4.+%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><a class="headerlink" href="#4.+%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB">4. おわりに</a></h1>
<p>Shift+数字キーを例に日本語配列について少し考え､ホイール操作を勘案したマウスエミュレーションについて思いを馳せてみました｡
qmkは簡単なことは簡単にできますが､少しでも踏み入ったことをしようとすると複雑になります｡
しかしフラグによる制御を加えたりするとそこそこなんとかなったり､ならなかったりすることが分かりました｡
デバッグも大変なので､状態遷移をオートマトンなどのモデルにコンパイルして検査されてほしいですね｡</p>
<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>筆者はThinkPadキーボードのトラックポイントならMinecraftくらいまでならやってましたが､流石にqmkのマウスエミュレーションではウェブブラウジングくらいまでしかできません｡逆にマウスでゲームしないのならマウスとして充分機能します｡ <a href="#fnref1">↩</a></p>
</li>

</ol>
</div>
          </div>
        </article>

      </div>
    </div>
    <footer>
      <div class="pagination btn-group" style="text-align: center; font-family: 'Comfortaa';">
        <a class="btn prev" href="/2019/01/27/stackfulness-of-coroutines.html" title="stackfulness of coroutines">← Prev</a>
        /<a class="btn" href="/">Top</a>/
        <a class="btn next" href="/2019/03/28/%E5%8B%89%E5%BC%B7%E4%BC%9A%E3%82%92%E9%96%8B%E5%82%AC%E3%81%97%E3%81%9F%E3%82%89big-name%E3%82%92%E5%8F%AC%E5%96%9A%E3%81%97%E3%81%A6%E3%81%97%E3%81%BE%E3%81%A3%E3%81%9F.html" title="勉強会を開催したらbig nameを召喚してしまった">Next →</a>
      </div>
    </footer>

  </body>
</html>
