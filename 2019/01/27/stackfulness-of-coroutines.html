<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html;charset=UTF-8" http-equiv="content-type"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="format-detection" content="telephone=no"/>

    <title>stackfulness of coroutines - lilyum ensemble</title>
    <meta itemprop="name" content="stackfulness of coroutines - lilyum ensemble"/>
    <meta name="keywords" content="coroutines"/>
    <meta name="thumbnail" content="https://nymphium.github.io/pictures/github_icon.png"/>
    <meta itemprop="image" content="https://nymphium.github.io/pictures/github_icon.png"/>

    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:site" content="lilyum ensemble"/>
    <meta name="twitter:title" content="stackfulness of coroutines - lilyum ensemble"/>
    <meta name="twitter:url" content="https://nymphium.github.io/2019/01/27/stackfulness-of-coroutines.html"/> 
    <meta name="twitter:text:description" content="こんにちは､びしょ〜じょです｡気づいたら1月も終わりますね｡お前も俺も､もう終わりだ｡1. はじめに研究ではコルーチンを使っている｡ここでひとつコルーチンについてまとめておきたい｡特にstack..."/>
    <meta name="twitter:image:src" content="https://nymphium.github.io/pictures/github_icon.png"/>

    <link rel="icon" type="image/x-icon" href="/favicon.ico"/>
    <link rel="stylesheet" href="/css/main.css"/>
    <link rel="alternate" type="application/rss+xml" title="lilyum ensemble" href="https://nymphium.github.io/feed.xml"/>
    <link href="https://fonts.googleapis.com/css?family=Comfortaa:300%7CDroid+Sans+Mono%7CCrimson+Text:400,400i" rel="stylesheet"/>
<!-- Begin Jekyll SEO tag v2.5.0 -->
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="stackfulness of coroutines" />
<meta name="author" content="Satoru Kawahara" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="lily, Aikatsu, Programming language, and more" />
<meta property="og:description" content="lily, Aikatsu, Programming language, and more" />
<link rel="canonical" href="https://nymphium.github.io/2019/01/27/stackfulness-of-coroutines.html" />
<meta property="og:url" content="https://nymphium.github.io/2019/01/27/stackfulness-of-coroutines.html" />
<meta property="og:site_name" content="lilyum ensemble" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-01-27T00:00:00+09:00" />
<script type="application/ld+json">
{"description":"lily, Aikatsu, Programming language, and more","@type":"BlogPosting","url":"https://nymphium.github.io/2019/01/27/stackfulness-of-coroutines.html","headline":"stackfulness of coroutines","dateModified":"2019-01-27T00:00:00+09:00","datePublished":"2019-01-27T00:00:00+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://nymphium.github.io/2019/01/27/stackfulness-of-coroutines.html"},"author":{"@type":"Person","name":"Satoru Kawahara"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta property="og:image" content="https://nymphium.github.io/pictures/github_icon.png"/>
  </head>

  <body>
    <header class="site-header">
      <div class="wrapper" style="font-family: 'Comfortaa';">
        <a class="site-title" href="/">lilyum ensemble</a>
        <nav class="site-nav">
          <div class="trigger">
            <a class="page-link" href="/aboutme.html">About</a>
            <a class="page-link" href="/slide.html">Slides</a>
            <a class="page-link" href="/tags.html">Tags</a>
          </div>
        </nav>
      </div>
    </header>

    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
          <header class="post-header">
            <h1 class="post-title" itemprop="name headline">stackfulness of coroutines</h1>
            <span class="post-meta">
              <time datetime="2019-01-27T00:00:00+09:00" itemprop="datePublished">Jan 27, 2019</time>
              <a class="src" href="https://github.com/nymphium/nymphium.github.io/blob/source/_posts%2F2019-01-27-stackfulness%20of%20coroutines.md" target="_blank" rel="noopener noreferrer">src</a>
              <p class="tags">tag: {<a href="/tags.html#coroutines-ref">coroutines</a>}</p>
              <a class="twitter-share-button" href="https://twitter.com/intent/tweet" target="_blank" rel="noopener noreferrer">Tweet</a> 
            </span>
            <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
            <script type="text/javascript" src="/js/GithubRepoWidget.min.js"></script>
            <script type="text/javascript">setTimeout(GithubRepoWidget.init, 3000);</script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" integrity="sha384-9tPv11A+glH/on/wEu99NVwDPwkMQESOocs/ZGXPoIiLE8MU/qkqUcZ3zzL+6DuH" crossorigin="anonymous">
            <!-- The loading of KaTeX is deferred to speed up page rendering -->
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.js" integrity="sha384-U8Vrjwb8fuHMt6ewaCy8uqeUXv4oitYACKdB0VziCerzt011iQ/0TqlSlv8MReCm" crossorigin="anonymous"></script>
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/contrib/auto-render.min.js" integrity="sha384-aGfk5kvhIq5x1x5YdvCp4upKZYnA8ckafviDpmWEKp4afOZEqOli7gqSnh8I6enH" crossorigin="anonymous"></script>
            <script>
document.addEventListener("DOMContentLoaded", function(){
  renderMathInElement
    ( document.body
    , { delimiters: [ {left: "$$",  right: "$$",  display: true}
                    , {left: "\\(", right: "\\)", display: false}
                    , {left: "\\[", right: "\\]", display: true}
                    , {left: "[[",  right: "]]",  display: true}
                    , {left: "$",   right: "$",   display: false} ]
    , })});
            </script>
          </header>
          <div class="post-content" itemprop="articleBody">
<p>こんにちは､びしょ〜じょです｡
気づいたら1月も終わりますね｡
お前も俺も､もう終わりだ｡</p>
<h1 id="1.+%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><a class="headerlink" href="#1.+%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">1. はじめに</a></h1>
<p>研究ではコルーチンを使っている｡
ここでひとつコルーチンについてまとめておきたい｡
特にstackfulnessについての考察をこれまでおこなっていなかったため､そこに重点を置く｡
本稿では文献<span class="cite">[<a href="#fn1" rel="footnote" title="Moura, Ana Lúcia De, and Roberto Ierusalimschy. “Revisiting coroutines.” ACM Transactions on Programming Languages and Systems (TOPLAS) 31.2 (2009): 6. " id="fnref1">1</a>]</span>
を参考にする｡</p>
<h1 id="2.+%E5%AF%BE%E7%A7%B0%E6%80%A7%E3%81%AB%E3%82%88%E3%82%8B%E5%88%86%E9%A1%9E"><a class="headerlink" href="#2.+%E5%AF%BE%E7%A7%B0%E6%80%A7%E3%81%AB%E3%82%88%E3%82%8B%E5%88%86%E9%A1%9E">2. 対称性による分類</a></h1>
<p>コルーチンとは､一時停止､再開のできるサブルーチンを指す｡
コルーチンを呼び出した呼び出し元にコントロールを戻す操作の有無により､コルーチンを対称コルーチンと<em>非</em>対称コルーチンの2種類に分けることができる(図<a href="#tbl1">2.1</a>
)｡</p>
<p></p>
<center>
<label id="tbl1"></label>

<p>表<a href="#tbl1">2.1</a>
. コルーチンの対称性による分類
</p>
</center>
<table>
<thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: center">対称コルーチン</th>
<th style="text-align: center">非対照コルーチン</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">“戻る” 操作</td>
<td style="text-align: center">ない</td>
<td style="text-align: center">ある</td>
</tr>
</tbody>
</table>
<p>対称コルーチンを持つプログラム言語は筆者は知らない｡
非対称コルーチンはわりとメジャーな機能で､コルーチンやFiberと言われる言語機能は概ね非対称コルーチンと思われる｡
“戻る” 操作とは､多くの非対称コルーチンを持つプログラム言語では<code>yield</code>というキーワードや関数名として使うことができる｡</p>
<div class="highlight">
<span class="listing-name">yield example</span><pre><code class="language-lua" data-lang="lua"><span class="nb">coroutine.create</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
  <span class="c1">-- callerに"戻る"</span>
  <span class="nb">coroutine.yield</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="k">end</span><span class="p">)</span>
</code></pre>
</div>
<h1 id="3.+stackfulness%E3%81%AB%E3%82%88%E3%82%8B%E5%88%86%E9%A1%9E"><a class="headerlink" href="#3.+stackfulness%E3%81%AB%E3%82%88%E3%82%8B%E5%88%86%E9%A1%9E">3. stackfulnessによる分類</a></h1>
<p><strong>コールスタックをまたいで</strong> yieldできるかどうかで､非対称コルーチンをさらに2つに分類できる(表<a href="#tbl2">3.1</a>
)｡</p>
<p></p>
<center>
<label id="tbl2"></label>

<p>表<a href="#tbl2">3.1</a>
. stackfulnessによる分類</p>

<table>
<thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: left">stackful</th>
<th style="text-align: left">stackless</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">またいでyield</td>
<td style="text-align: left">できる</td>
<td style="text-align: left">できない</td>
</tr>
<tr>
<td style="text-align: left">examples</td>
<td style="text-align: left">Luaのcoroutine, RubyのFiber</td>
<td style="text-align: left">Rustのcoroutine, JSのGenerator</td>
</tr>
</tbody>
</table>

<p></p>
</center>
<p>stackful coroutinesは単に “coroutine” ､ あるいは “fiber” と呼ばれ､
stackless coroutinesは “generator” と称される傾向にある｡</p>
<p>では､ “コールスタックをまたげる” とはどういうことか?
これはyieldがネストした関数呼出しから一気にコルーチンの呼び出し元まで戻れる､またyieldした位置にコントロールを戻せるということである｡
次の例を見てみる(プログラム<a href="#lst:stackfulexample">3.2</a>
, プログラム<a href="#lst:stacklessexample">3.3</a>
)｡</p>
<p><label id="lst:stackfulexample"></label></p>
<div class="highlight">
<span class="listing-name">プログラム<a href="#lst:stackfulexample">3.2</a>
. stackful example in Lua</span><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">send</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">y</span> <span class="o">=</span> <span class="n">yield</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">3</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="n">co</span> <span class="o">=</span> <span class="nb">coroutine.create</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">x</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">10</span>
<span class="k">end</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">resume</span><span class="p">(</span><span class="n">co</span><span class="p">))</span> <span class="c1">-- prints 10</span>
<span class="nb">print</span><span class="p">(</span><span class="n">resume</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="c1">-- prints 15</span>
</code></pre>
</div>
<p><label id="lst:stacklessexample"></label></p>
<div class="highlight">
<span class="listing-name">プログラム<a href="#lst:stacklessexample">3.3</a>
. stackless example in JS</span><pre><code class="language-javascript" data-lang="javascript"><span class="cm">/* syntax error
function send(x) {
  yield x
}
*/</span>

<span class="kd">const</span> <span class="nx">co</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="o">*</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">x</span> <span class="o">=</span> <span class="k">yield</span> <span class="mi">10</span>
  <span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">10</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">co</span><span class="p">.</span><span class="nx">enxt</span><span class="p">())</span>  <span class="c1">// prints 10</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">co</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="c1">// prints 13</span>
</code></pre>
</div>
<p><a href="#lst:stackfulexample">3.2</a>
を見てみる｡
関数<code>send</code>の中で<code>yield</code>しているが､<code>send</code>自体はただの関数である｡
<code>send</code>をコルーチン<code>co</code>の中で呼び出すと､この<code>yield</code>で一時停止する｡
2度目の<code>resume</code>で渡した<code>2</code>が､<code>yield</code>の戻り値となり､<code>send</code>の戻り値は<code>2 + 3</code>となる｡</p>
<p>一方<a href="#lst:stacklessexample">3.3</a>
は､コルーチン(generator)の中でしか<code>yield</code>できない｡
特にJSは<code>yield</code>がキーワードとして扱われ､generatorの中でしか書けないというsyntacticな制約がある｡</p>
<h1 id="4.+pros%2Fcons"><a class="headerlink" href="#4.+pros%2Fcons">4. pros/cons</a></h1>
<p>非対称コルーチンをさらにstaclful､stacklessの2種類に分類した｡
利点と欠点をまとめてみると､次のようになる(表<a href="#tbl3">4.1</a>
)｡</p>
<p></p>
<center>
<label id="tbl3"></label>

<p>表<a href="#tbl3">4.1</a>
. 利点･欠点まとめ
</p>
</center>
<table>
<thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: left">stackful</th>
<th style="text-align: left">stackless</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">利点</td>
<td style="text-align: left">関数呼出しをまたいだyieldができ､<br>stacklessよりも表現力が高い</td>
<td style="text-align: left">ステートマシンに変換でき､実装が簡潔な<br>だけでなく実行のパフォーマンスも良い</td>
</tr>
<tr>
<td style="text-align: left">欠点</td>
<td style="text-align: left">実装が煩雑となり､コンテキストスイッチの<br>オーバーヘッドがかかる</td>
<td style="text-align: left">表現力が低い</td>
</tr>
</tbody>
</table>
<p>stackful coroutinesの利点･欠点が､逆にstackless coroutinesの欠点･利点と､一長一短となっている｡</p>
<h1 id="5.+%E7%A0%94%E7%A9%B6%E3%81%A8%E3%81%AE%E9%96%A2%E9%80%A3%E6%80%A7"><a class="headerlink" href="#5.+%E7%A0%94%E7%A9%B6%E3%81%A8%E3%81%AE%E9%96%A2%E9%80%A3%E6%80%A7">5. 研究との関連性</a></h1>
<p>筆者の研究では “ネストした関数呼出しから一気に飛び出せる” というstackful coroutinesの特性を利用している｡
そのためstackless coroutinesではすぐには代替できない｡
stackful coroutines → stackless coroutinesの変換がある場合はなんとかなるかもしれないので､教えてください｡</p>
<h1 id="6.+%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><a class="headerlink" href="#6.+%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB">6. おわりに</a></h1>
<p>という話をゼミでやった｡
(研究の進捗は)ないです</p>
<h1 id="%E4%BB%96"><a class="headerlink" href="#%E4%BB%96">他</a></h1>
<p>なんかわかりやすいやつ</p>
<div class="twicard">
  <span class="image"><a href="https://stackoverflow.com/questions/28977302/how-do-stackless-coroutines-differ-from-stackful-coroutines" target="_blank" rel="noopener noreferrer"><div><img src="https://cdn.sstatic.net/Sites/stackoverflow/img/apple-touch-icon@2.png?v=73d79a89bded"></div></a></span>
  <span class="txt">
    <div class="title"><a href="https://stackoverflow.com/questions/28977302/how-do-stackless-coroutines-differ-from-stackful-coroutines" target="_blank" rel="noopener noreferrer">How do stackless coroutines differ from stackful coroutines?</a></div>
    <div class="description">Background:I’m asking this because I currently have an application with many (hundreds to thousands) of threads. Most of those threads are idle a great portion of the time, waiting on work items …</div>
  </span>
</div>
<hr>
<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>Moura, Ana Lúcia De, and Roberto Ierusalimschy. “Revisiting coroutines.” ACM Transactions on Programming Languages and Systems (TOPLAS) 31.2 (2009): 6. <a href="#fnref1" rev="footnote">↩</a></p>
</li>

</ol>
</div>
          </div>
        </article>

      </div>
    </div>
    <footer>
      <div class="pagination btn-group" style="text-align: center; font-family: 'Comfortaa';">
        <a class="btn prev" href="/2018/12/09/asymmetric-coroutines%E3%81%AB%E3%82%88%E3%82%8Boneshot-algebraic-effects%E3%81%AE%E5%AE%9F%E8%A3%85.html" title="Asymmetric CoroutinesによるOneshot Algebraic Effectsの実装">← Prev</a>
        /<a class="btn" href="/">Top</a>/
        <a class="btn next" href="/2019/03/28/%E5%8B%89%E5%BC%B7%E4%BC%9A%E3%82%92%E9%96%8B%E5%82%AC%E3%81%97%E3%81%9F%E3%82%89big-name%E3%82%92%E5%8F%AC%E5%96%9A%E3%81%97%E3%81%A6%E3%81%97%E3%81%BE%E3%81%A3%E3%81%9F.html" title="勉強会を開催したらbig nameを召喚してしまった">Next →</a>
      </div>
    </footer>

  </body>
</html>
