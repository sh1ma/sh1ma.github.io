<!DOCTYPE html>
<html>
  <head>
    <title>Control Flow Graph &#47; lilyum ensemble</title>
    <meta content="text/html;charset=UTF-8" http-equiv="content-type">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Satoru Kawahara">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="lilyum ensemble">
    <meta name="twitter:creator" content="Satoru Kawahara"> 
    <meta name="twitter:text:description" content="Control Flow Graph">
    <meta name="twitter:title" content="Control Flow Graph"> 
    <meta name="twitter:url" content="https://nymphium.github.io/2017/02/07/cfg.html"> 
    <meta name="twitter:description" content="こんにちは､びしょ〜じょです｡いつの間にか2017年､そして2月｡季節はめぐり､また俺達は―">
    <meta name="twitter:image:src" content="https://nymphium.github.io/pictures/github_icon.png">
    <meta name="description" content="こんにちは､びしょ〜じょです｡いつの間にか2017年､そして2月｡季節はめぐり､また俺達は―">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="https://nymphium.github.io/2017/02/07/cfg.html">
    <link rel="alternate" type="application/rss+xml" title="lilyum ensemble" href="https://nymphium.github.io/feed.xml">
    <link href="https://fonts.googleapis.com/css?family=Comfortaa:300%7CDroid+Sans+Mono%7CCrimson+Text:400,400i" rel="stylesheet">
  </head>

  <body>
    <header class="site-header">
      <div class="wrapper" style="font-family: 'Comfortaa';">
        <a class="site-title" href="/">lilyum ensemble</a>
        <nav class="site-nav">
          <div class="trigger">
            <a class="page-link" href="/slide.html">Slides</a>
            <a class="page-link" href="/tags.html">Tags</a>
          </div>
        </nav>
      </div>
    </header>

    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
          <header class="post-header">
            <h1 class="post-title" itemprop="name headline">Control Flow Graph</h1>
            <span class="post-meta">
              <time datetime="2017-02-07T00:00:00+09:00" itemprop="datePublished">Feb 7, 2017</time>
              <p>tag: &#123;<a href="/tags.html#Lua VM-ref">Lua VM</a>, <a href="/tags.html#code optimization-ref">code optimization</a>&#125;</p>
            </span>
            <script type="text/javascript" src="/js/GithubRepoWidget.min.js"></script>
            <script type="text/javascript">setTimeout(GithubRepoWidget.init, 3000);</script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" integrity="sha384-9tPv11A+glH/on/wEu99NVwDPwkMQESOocs/ZGXPoIiLE8MU/qkqUcZ3zzL+6DuH" crossorigin="anonymous">
            <!-- The loading of KaTeX is deferred to speed up page rendering -->
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.js" integrity="sha384-U8Vrjwb8fuHMt6ewaCy8uqeUXv4oitYACKdB0VziCerzt011iQ/0TqlSlv8MReCm" crossorigin="anonymous"></script>
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/contrib/auto-render.min.js" integrity="sha384-aGfk5kvhIq5x1x5YdvCp4upKZYnA8ckafviDpmWEKp4afOZEqOli7gqSnh8I6enH" crossorigin="anonymous"
                    onload="renderMathInElement(document.body);"></script>
          </header>
          <div class="post-content" itemprop="articleBody">
<p>こんにちは､びしょ〜じょです｡いつの間にか2017年､そして2月｡季節はめぐり､また俺達は―</p>
<h1 id="1">1. はじめに</h1>
<p>さて以前DU Chainがなんとかって話をしたんですが､その中に出てくるControl Flow Graphというものについてかなり適当に流しました｡
本当はここは重要なので､重要じゃよ〜</p>
<h1 id="2">2. 構成方法</h1>
<ol>
<li>
<p>各命令を基本ブロックとする｡
各命令にはその行番号と､次に実行される命令の行番号(指すべき先行ブロックの開始位置)をタグ付けする｡殆どの命令は行番号+1だが､以下の命令は異なり､または複数の行き先がある｡</p>

<table>
<thead>
<tr>
<th style="text-align: left">instructions</th>
<th style="text-align: left">destination(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">
<code>JMP</code>, <code>FORPREP</code>
</td>
<td style="text-align: left">+<code>RB</code>+1</td>
</tr>
<tr>
<td style="text-align: left"><code>LOADBOOL</code></td>
<td style="text-align: left">+2 if <code>RC</code> == 1</td>
</tr>
<tr>
<td style="text-align: left">
<code>TEST</code>, <code>TESTSET</code>, <code>LT</code>, <code>LE</code>, <code>EQ</code>
</td>
<td style="text-align: left">+1, +2</td>
</tr>
<tr>
<td style="text-align: left">
<code>FORLOOP</code>, <code>TFORLOOP</code>
</td>
<td style="text-align: left">+1,+<code>RB</code>+1</td>
</tr>
<tr>
<td style="text-align: left">
<code>RETURN</code>, <code>TAILCALL</code>
</td>
<td style="text-align: left">none</td>
</tr>
</tbody>
</table>

<p><code>RETURN</code>, <code>TAILCALL</code>は必ずブロックの最後になり､そのブロックに先行ブロックは付かない｡</p>
</li>
<li>
<p>基本ブロックをつなげていく｡</p>

<ol>
<li>基本ブロック\(B_1\)の行き先が基本ブロック\(B_2\)の開始位置を指している場合､\(B_1\)の後続ブロックにブ\(B_2\)を追加する｡\(B_2\)の先行ブロックに\(B_1\)を追加する｡</li>
<li>\(B_1\)が\(B_2\)の開始位置以外を指している場合､

<ol>
<li>\(B_2\)を

<ul>
<li>\(B_2a\): 開始位置〜指している位置-1</li>
<li>\(B_2b\): 指している位置〜\(B_2\)の最後
に分割し､</li>
</ul>
</li>
<li>\(B_2\)の先行ブロックを\(B_2a\)に移し､\(B_2\)の後続ブロックを\(B_2b\)に移す｡</li>
<li>\(B_2a\)の後続ブロックに\(B_2b\)を追加する｡\(B_2b\)の先行ブロックに\(B_2a\)を追加する｡</li>
<li>\(B_1\)の後続ブロックに\(B_2b\)を追加する｡\(B_2b\)の後続ブロックに\(B_1\)を追加する｡</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>流れるような説明ありがとうございます!</p>
<h1 id="3-example">3. example</h1>
<p>以下のようなコード</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">3</span>

<span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">then</span>
    <span class="nb">print</span><span class="s2">"hello"</span>
<span class="k">else</span>
    <span class="nb">print</span><span class="s2">"world"</span>
<span class="k">end</span>
</code></pre></div>
<p>また､これから成るVMの命令列</p>
<div class="highlight"><pre><code class="language-" data-lang="">        1       [1]     LOADK           0 -1    ; 3
        2       [3]     LT              0 0 -2  ; - 5
        3       [3]     JMP             0 4     ; to 8
        4       [4]     GETTABUP        1 0 -3  ; _ENV "print"
        5       [4]     LOADK           2 -4    ; "hello"
        6       [4]     CALL            1 2 1
        7       [4]     JMP             0 3     ; to 11
        8       [6]     GETTABUP        1 0 -3  ; _ENV "print"
        9       [6]     LOADK           2 -5    ; "world"
        10      [6]     CALL            1 2 1
        11      [7]     RETURN          0 1
</code></pre></div>
<p>を考える｡</p>
<p>まず､各命令を基本ブロックとして見ていき､先行ブロック(の開始位置)をタグ付けする｡</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="p">{</span>
  <span class="p">{</span><span class="n">op</span> <span class="o">=</span> <span class="s2">"LOADK"</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">succ_pos</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">}},</span>
  <span class="p">{</span><span class="n">op</span> <span class="o">=</span> <span class="s2">"LT"</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">succ_pos</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">}},</span>
  <span class="p">{</span><span class="n">op</span> <span class="o">=</span> <span class="s2">"JMP"</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">succ_pos</span> <span class="o">=</span> <span class="mi">8</span><span class="p">},</span>
  <span class="p">{</span><span class="n">op</span> <span class="o">=</span> <span class="s2">"GETTABUP"</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">succ_pos</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">}},</span>
  <span class="p">{</span><span class="n">op</span> <span class="o">=</span> <span class="s2">"LOADK"</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">succ_pos</span> <span class="o">=</span> <span class="p">{</span><span class="mi">6</span><span class="p">}},</span>
  <span class="p">{</span><span class="n">op</span> <span class="o">=</span> <span class="s2">"CALL"</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">succ_pos</span> <span class="o">=</span> <span class="p">{</span><span class="mi">7</span><span class="p">}},</span>
  <span class="p">{</span><span class="n">op</span> <span class="o">=</span> <span class="s2">"JMP"</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">succ_pos</span> <span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">}},</span>
  <span class="p">{</span><span class="n">op</span> <span class="o">=</span> <span class="s2">"GETTABUP"</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">succ_pos</span> <span class="o">=</span> <span class="p">{</span><span class="mi">9</span><span class="p">}},</span>
  <span class="p">{</span><span class="n">op</span> <span class="o">=</span> <span class="s2">"LOADK"</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">succ_pos</span> <span class="o">=</span> <span class="p">{</span><span class="mi">10</span><span class="p">}},</span>
  <span class="p">{</span><span class="n">op</span> <span class="o">=</span> <span class="s2">"CALL"</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">succ_pos</span> <span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">}},</span>
  <span class="p">{</span><span class="n">op</span> <span class="o">=</span> <span class="s2">"RETURN"</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="n">succ_pos</span> <span class="o">=</span> <span class="p">{}}</span>
<span class="p">}</span>
</code></pre></div>
<p>そしてつなげていく｡</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="p">{</span>
  <span class="p">{</span><span class="n">start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="k">end</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">succ</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="n">prev</span> <span class="o">=</span> <span class="p">{}},</span> <span class="c1">-- block 1</span>
  <span class="p">{</span><span class="n">start</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="k">end</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">succ</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">},</span> <span class="n">prev</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">}},</span> <span class="c1">-- block 2</span>
  <span class="p">{</span><span class="n">start</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="k">end</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">succ</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">},</span> <span class="n">prev</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">}},</span> <span class="c1">-- block 3</span>
  <span class="p">{</span><span class="n">start</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="k">end</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">succ</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">},</span> <span class="n">prev</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">}},</span>
  <span class="p">{</span><span class="n">start</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="k">end</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="n">succ</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">prev</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">}}</span>
<span class="p">}</span>
</code></pre></div>
<h1 id="4">4. おわりに</h1>
<p>最近は体調以外良好気味です｡</p>
<p>そういえばTwitter Cardとかいう物体をねじ込んでみました｡よかったです｡いや本当は良くなくてね〜いや〜良い､良くない</p>
          </div>
        </article>

      </div>
    </div>
    <footer>
      <div class="pagination btn-group" style="text-align: center; font-family: 'Comfortaa';">
        <a class="btn prev" href="/2016/12/13/%E3%81%94%E5%A0%B1%E5%91%8A.html" title="ご報告">&larr; Prev</a>
        &#47;<a class="btn" href="/">Top</a>&#47;
        <a class="btn next" href="/2017/02/12/opeth.html" title="通年でLua最適化器を作った">Next &rarr;</a>
      </div>
    </footer>

  </body>
</html>
